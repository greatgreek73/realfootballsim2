<div id="markov-panel" style="border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;">
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
    <strong>Markov v0 (демо, 1 минута)</strong>
    <button id="markov-run" type="button">Обновить минуту</button>
    <span id="markov-status" style="background:#eee;padding:2px 8px;border-radius:999px;">Готово</span>
  </div>
  <pre id="markov-summary" style="background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto;">{}</pre>
  <pre id="markov-events"  style="background:#f6f8fa;padding:8px;border-radius:6px;overflow:auto;height:180px;">[]</pre>
</div>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const status = $('markov-status'), summary = $('markov-summary'), events = $('markov-events');
  // если есть match.id в контексте — используем его
  const seed = (typeof MATCH_ID !== 'undefined') ? MATCH_ID : ({{ match.id|default:73 }});
  async function runOnce(){
    try{
      status.textContent='Загрузка...';
      const resp = await fetch(`/matches/markov-minute/?seed=${encodeURIComponent(seed)}`, {headers:{'Accept':'application/json'}});
      const data = await resp.json();
      const ms = data.minute_summary || {};
      summary.textContent = JSON.stringify({
        start_state: ms.start_state, end_state: ms.end_state,
        possession_end: ms.possession_end, score: ms.score, counts: ms.counts
      }, null, 2);
      events.textContent = JSON.stringify(ms.events ?? [], null, 2);
      status.textContent='Готово';
    }catch(e){
      status.textContent='Ошибка';
      summary.textContent=String(e);
      events.textContent='[]';
    }
  }
  $('markov-run').addEventListener('click', runOnce);
  runOnce(); // автозапуск один раз
})();
</script>
