{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4"> {# –î–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É #}
    <div class="row">
        <div class="col-12">

            <!-- 1) MATCH CENTER -->
            <div class="card mb-4 shadow-sm" {# –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–µ–Ω–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã #}
                 id="matchInfoArea"
                 data-match-id="{{ match.id }}"
                 data-match-status="{{ match.status }}"
                 data-home-team-id="{{ match.home_team.id }}"
                 data-away-team-id="{{ match.away_team.id }}"
                 data-minute-seconds="{{ match_minute_seconds }}">
                <div class="card-header bg-light"> {# –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω –∑–∞–≥–æ–ª–æ–≤–∫–∞ #}
                    <div class="d-flex justify-content-between align-items-center flex-wrap"> {# flex-wrap –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö #}
                        <h2 class="h4 mb-0 me-3"> {# –£–º–µ–Ω—å—à–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ #}
                            <a href="{% url 'clubs:club_detail' match.home_team.id %}" class="text-decoration-none text-dark">{{ match.home_team.name }}</a>
                            vs
                            <a href="{% url 'clubs:club_detail' match.away_team.id %}" class="text-decoration-none text-dark">{{ match.away_team.name }}</a>
                        </h2>
                        <div class="text-muted small"> {# –£–º–µ–Ω—å—à–µ–Ω —à—Ä–∏—Ñ—Ç –¥–∞—Ç—ã #}
                            {{ match.datetime|date:"d M Y H:i" }}
                        </div>
                    </div>
                    <div class="text-muted small mt-1"> {# –£–º–µ–Ω—å—à–µ–Ω —à—Ä–∏—Ñ—Ç –∏ –¥–æ–±–∞–≤–ª–µ–Ω –æ—Ç—Å—Ç—É–ø #}
                        {% if match.championshipmatch_set.first.championship.league %} {# –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –ª–∏–≥—É #}
                            {{ match.championshipmatch_set.first.championship.league.name }}
                        {% endif %}
                        {% with match.championshipmatch_set.first as cm %}
                            {% if cm and cm.round %}
                                - Round {{ cm.round }}
                            {% endif %}
                        {% endwith %}
                        ¬†|¬†
                        Status: <span id="matchStatusDisplay">{{ match.get_status_display }}</span> {# ID –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ #}
                    </div>
                </div>

                <div class="card-body">
                    <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å: –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥ –∏ —Å—á—ë—Ç -->
                    <div class="text-center mb-4">
                        <div class="row align-items-center">
                            <div class="col-5"> {# –ò—Å–ø–æ–ª—å–∑—É–µ–º col-5 –¥–ª—è —Å–∏–º–º–µ—Ç—Ä–∏–∏ #}
                                <a href="{% url 'clubs:club_detail' match.home_team.id %}" class="text-decoration-none">
                                    <h4 class="h5 mb-1">{{ match.home_team.name }}</h4> {# –£–º–µ–Ω—å—à–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ #}
                                    {% if match.home_team.is_bot %}
                                        <span class="badge bg-secondary">Bot</span> {# –ë–µ–π–¥–∂ –¥–ª—è –±–æ—Ç–∞ #}
                                    {% endif %}
                                </a>
                            </div>

                            <div class="col-2">
                                <!-- –°—á—ë—Ç -->
                                <h3 class="score mb-0" id="score">
                                    <span class="score-box home-score">{{ match.home_score }}</span> {# –ò—Å–ø–æ–ª—å–∑—É–µ–º span –∏ –∫–ª–∞—Å—Å #}
                                    <span class="score-separator">-</span>
                                    <span class="score-box away-score">{{ match.away_score }}</span> {# –ò—Å–ø–æ–ª—å–∑—É–µ–º span –∏ –∫–ª–∞—Å—Å #}
                                </h3>
                                <!-- –ú–∏–Ω—É—Ç—ã -->
                                <div class="match-time small text-muted mt-1" id="matchTime"> {# –ö–ª–∞—Å—Å –∏ –æ—Ç—Å—Ç—É–ø #}
                                    {% if match.status == 'in_progress' %}
                                        {{ match.current_minute }}'
                                    {% elif match.status == 'finished' %}
                                        FT {# Full Time #}
                                    {% else %}
                                        0'
                                    {% endif %}
                                </div>
                                <button id="continueMinute" class="btn btn-sm btn-primary mt-2" style="display:none;" type="button">Continue</button>
                                <button id="nextMinuteBtn" class="btn btn-sm btn-success mt-2" style="display:none;" type="button">Next Minute</button>
                            </div>

                            <div class="col-5"> {# –ò—Å–ø–æ–ª—å–∑—É–µ–º col-5 –¥–ª—è —Å–∏–º–º–µ—Ç—Ä–∏–∏ #}
                                <a href="{% url 'clubs:club_detail' match.away_team.id %}" class="text-decoration-none">
                                    <h4 class="h5 mb-1">{{ match.away_team.name }}</h4> {# –£–º–µ–Ω—å—à–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ #}
                                    {% if match.away_team.is_bot %}
                                         <span class="badge bg-secondary">Bot</span> {# –ë–µ–π–¥–∂ –¥–ª—è –±–æ—Ç–∞ #}
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-5 text-start">
                                <span id="homeMomentumIcon" class="momentum-icon momentum-neutral">üòê</span>
                                <span id="homeMomentumValue" class="momentum-value">{{ match.home_momentum }}</span>
                            </div>
                            <div class="col-2"></div>
                            <div class="col-5 text-end">
                                <span id="awayMomentumIcon" class="momentum-icon momentum-neutral">üòê</span>
                                <span id="awayMomentumValue" class="momentum-value">{{ match.away_momentum }}</span>
                            </div>
                        </div>
                    </div>

                    <div id="pitch" class="pitch" style="display: grid !important; grid-template-columns: repeat(8, 1fr) !important; grid-template-rows: repeat(3, 60px) !important; background-color: #28a745 !important; min-height: 200px !important; border: 2px solid #fff !important; padding: 10px !important;">
                        <!-- –õ–µ–≤–∞—è —Ü–µ–ª—å (Home GK / Away FWD area) -->
                        <div class="zone goal goal-left" data-zone="goal-left"></div>

                        <!-- Left def (home DEF / away FWD) -->
                        <div class="zone left-def-top" data-zone="left-def-top"></div>
                        <div class="zone left-def-middle" data-zone="left-def-middle"></div>
                        <div class="zone left-def-bottom" data-zone="left-def-bottom"></div>

                        <!-- Left dm (home DM / away AM) -->
                        <div class="zone left-dm-top" data-zone="left-dm-top"></div>
                        <div class="zone left-dm-middle" data-zone="left-dm-middle"></div>
                        <div class="zone left-dm-bottom" data-zone="left-dm-bottom"></div>

                        <!-- Left mid (home MID / away AM or MID) -->
                        <div class="zone left-mid-top" data-zone="left-mid-top"></div>
                        <div class="zone left-mid-middle" data-zone="left-mid-middle"></div>
                        <div class="zone left-mid-bottom" data-zone="left-mid-bottom"></div>

                        <!-- Right mid (away MID / home AM or MID) -->
                        <div class="zone right-mid-top" data-zone="right-mid-top"></div>
                        <div class="zone right-mid-middle" data-zone="right-mid-middle"></div>
                        <div class="zone right-mid-bottom" data-zone="right-mid-bottom"></div>

                        <!-- Right am (home AM / away DM) -->
                        <div class="zone right-am-top" data-zone="right-am-top"></div>
                        <div class="zone right-am-middle" data-zone="right-am-middle"></div>
                        <div class="zone right-am-bottom" data-zone="right-am-bottom"></div>

                        <!-- Right def (home FWD / away DEF) -->
                        <div class="zone right-def-top" data-zone="right-def-top"></div>
                        <div class="zone right-def-middle" data-zone="right-def-middle"></div>
                        <div class="zone right-def-bottom" data-zone="right-def-bottom"></div>

                        <!-- –ü—Ä–∞–≤–∞—è —Ü–µ–ª—å (Away GK / Home FWD area) -->
                        <div class="zone goal goal-right" data-zone="goal-right"></div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∞ Replay, –µ—Å–ª–∏ –º–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω -->
                    {% if match.status == 'finished' %}
                    <div class="text-center mb-3"> {# –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É #}
                        <button id="startReplayBtn" class="btn btn-sm btn-outline-primary"> {# –£–º–µ–Ω—å—à–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ #}
                            <i class="fas fa-play me-1"></i> Watch Replay {# –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç Font Awesome) #}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 2) –û–ë–õ–ê–°–¢–¨ –°–û–ë–´–¢–ò–ô –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                     <h3 class="h5 mb-0">Match Log & Stats</h3>
                </div>
                 <div class="card-body">
                    <div class="row">
                        <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π (–õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
                        <div class="col-md-7 mb-3 mb-md-0"> {# –ë–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –¥–ª—è –ª–æ–≥–∞ #}
                            <h4 class="h6 mb-3">Events</h4>
                            <div id="originalEvents" class="event-log"> {# –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ª–æ–≥–∞ #}
                                <div class="list-group events-box"> {# –°—é–¥–∞ JS –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Å–æ–±—ã—Ç–∏—è #}
                                    {% if match.status != 'in_progress' %}
                                        {# –í—ã–≤–æ–¥–∏–º —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π —Å –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º #}
                                        {% for enriched_event in enriched_match_events %}
                                        <div class="list-group-item narrative-event-item 
                                             {% if enriched_event.narrative_context.overall_importance == 'legendary' %}narrative-legendary
                                             {% elif enriched_event.narrative_context.overall_importance == 'major' %}narrative-major
                                             {% elif enriched_event.narrative_context.overall_importance == 'significant' %}narrative-significant
                                             {% elif enriched_event.narrative_context.overall_importance == 'minor' %}narrative-minor
                                             {% endif %}"
                                             {% if enriched_event.narrative_context.has_narrative %}
                                             data-bs-toggle="tooltip" 
                                             data-bs-placement="top" 
                                             title="{{ enriched_event.narrative_context.narrative_event.title }}: {{ enriched_event.narrative_context.narrative_event.description }}"
                                             {% endif %}>
                                            
                                            {# –ù–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ #}
                                            <div class="narrative-indicators">
                                                {% if enriched_event.narrative_context.has_rivalry %}
                                                    <span class="narrative-icon rivalry-icon" title="Rivalry: {{ enriched_event.narrative_context.rivalry.get_rivalry_type_display }} ({{ enriched_event.narrative_context.rivalry_intensity }})">‚öîÔ∏è</span>
                                                {% endif %}
                                                {% if enriched_event.narrative_context.has_chemistry %}
                                                    <span class="narrative-icon chemistry-icon" title="Team Chemistry: {{ enriched_event.narrative_context.chemistry.get_chemistry_type_display }} ({{ enriched_event.narrative_context.chemistry_strength|floatformat:1 }})">ü§ù</span>
                                                {% endif %}
                                                {% if enriched_event.narrative_context.has_character_growth %}
                                                    <span class="narrative-icon growth-icon" title="Character Development">üìà</span>
                                                {% endif %}
                                                {% if enriched_event.narrative_context.has_narrative %}
                                                    <span class="narrative-icon story-icon" title="Story Moment">üìñ</span>
                                                {% endif %}
                                            </div>
                                            
                                            {# –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–±—ã—Ç–∏—è #}
                                            <div class="event-content">
                                                <strong>{{ enriched_event.minute }}'</strong>
                                                {% if enriched_event.event_type == 'goal' %}‚öΩ{% elif enriched_event.event_type == 'counterattack' %}‚ö°{% elif enriched_event.event_type == 'interception' %}üîÑ{% elif enriched_event.event_type == 'shot_miss' %}‚ùå{% elif enriched_event.event_type == 'pass' %}‚û°Ô∏è{% elif enriched_event.event_type == 'foul' %}‚ö†Ô∏è{% elif enriched_event.event_type == 'injury_concern' %}‚úö{% else %} M {% endif %}
                                                {{ enriched_event.description }}
                                                
                                                {# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ #}
                                                {% if enriched_event.player %}
                                                <small class="text-muted">({{ enriched_event.player.last_name }}{% if enriched_event.related_player %} -> {{ enriched_event.related_player.last_name }}{% endif %})</small>
                                                {% endif %}
                                                
                                                {# –ù–∞—Ä—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å #}
                                                {% if enriched_event.narrative_context.has_narrative %}
                                                <div class="narrative-description mt-2">
                                                    <small class="text-primary"><em>{{ enriched_event.narrative_context.narrative_event.description }}</em></small>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% empty %}
                                         <div class="list-group-item text-muted">No events found for this match yet.</div>
                                        {% endfor %}
                                    {% else %}
                                        {# –î–ª—è live-–º–∞—Ç—á–µ–π —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–¥—É—Ç —á–µ—Ä–µ–∑ WebSocket #}
                                        <div class="list-group-item text-muted">Waiting for match events...</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞) -->
                        <div class="col-md-5">
                            <!-- Narrative Summary Section -->
                            {% if narrative_summary.total_events > 0 %}
                            <div class="narrative-summary mb-4">
                                <h4 class="h6 mb-3">Match Stories</h4>
                                <div class="card border-primary">
                                    <div class="card-body p-3">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="stat-number text-primary">{{ narrative_summary.total_events }}</div>
                                                <small class="text-muted">Story Events</small>
                                            </div>
                                            <div class="col-6">
                                                <div class="stat-number text-warning">{{ narrative_summary.major_events }}</div>
                                                <small class="text-muted">Major Moments</small>
                                            </div>
                                        </div>
                                        
                                        {% if narrative_summary.narrative_events %}
                                        <hr class="my-2">
                                        <div class="narrative-highlights">
                                            <small class="text-muted d-block mb-2">Highlights:</small>
                                            {% for narrative_event in narrative_summary.narrative_events|slice:":3" %}
                                            <div class="narrative-highlight mb-2">
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-secondary me-2">{{ narrative_event.minute }}'</span>
                                                    <small class="text-primary">
                                                        {% if narrative_event.event_type == 'rivalry_clash' %}‚öîÔ∏è{% elif narrative_event.event_type == 'chemistry_moment' %}ü§ù{% elif narrative_event.event_type == 'character_growth' %}üìà{% else %}üìñ{% endif %}
                                                        {{ narrative_event.title|truncatechars:25 }}
                                                    </small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <h4 class="h6 mb-3">Statistics</h4>
                            <div id="matchStatistics" class="mb-4">
                                <div class="list-group stat-box">
                                    {# –ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ #}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Passes</span>
                                        <span class="badge bg-primary rounded-pill stat-passes">{{ match.st_passes|default:0 }}</span> {# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å #}
                                    </div>
                                     <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Shoots</span>
                                        <span class="badge bg-info rounded-pill stat-shoots">{{ match.st_shoots|default:0 }}</span> {# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å #}
                                    </div>
                                     <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Possessions</span>
                                        <span class="badge bg-secondary rounded-pill stat-possessions">{{ match.st_possessions|default:0 }}</span> {# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å #}
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Fouls</span>
                                        <span class="badge bg-warning text-dark rounded-pill stat-fouls">{{ match.st_fouls|default:0 }}</span> {# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å #}
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>Injuries</span>
                                        <span class="badge bg-danger rounded-pill stat-injuries" id="inj">{{ match.st_injury|default:0 }}</span> {# –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å #}
                                    </div>
                                </div>
                            </div>
                             <!-- –§–æ—Ä–º–∞ —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Ç—Ä–∞–≤–º—É (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                             <div id="matchUserAction-inj" class="matchUserAction card bg-light p-3" style="display: none;"> {# –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ –∫–∞—Ä—Ç–æ—á–∫–∞ #}
                                <h5 class="h6 mb-2 text-danger">Injury Detected!</h5>
                                <p class="small mb-2">Select player to substitute:</p> {# –£—Ç–æ—á–Ω–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ #}
                                <div class="mb-2">
                                    {# –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ) #}
                                    {# –ü–†–ï–î–ü–û–õ–û–ñ–ï–ù–ò–ï: user_club –∏ user_players –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç #}
                                    <select name="playerToReplace" id="playerToReplaceSelect" class="form-select form-select-sm">
                                        <option value="">-- Select Player --</option>
                                        {% with user_club_id=request.user.club.id|default:None %}
                                            {% if match.home_team_id == user_club_id and match.home_lineup %}
                                                {% for slot, p_data in match.home_lineup.items %}
                                                    {% if p_data.playerId %}
                                                        <option value="{{ p_data.playerId }}">
                                                            {{ p_data.slotLabel }}: {{ p_data.playerName|default:p_data.playerId }} {# –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è, –µ—Å–ª–∏ –µ—Å—Ç—å #}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% elif match.away_team_id == user_club_id and match.away_lineup %}
                                                 {% for slot, p_data in match.away_lineup.items %}
                                                    {% if p_data.playerId %}
                                                        <option value="{{ p_data.playerId }}">
                                                            {{ p_data.slotLabel }}: {{ p_data.playerName|default:p_data.playerId }}
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        {% endwith %}
                                    </select>
                                </div>
                                <div class="text-end">
                                    <button type="button" class="btn btn-sm btn-danger" id="replace-player">Replace</button> {# –ö–Ω–æ–ø–∫–∞ –∑–∞–º–µ–Ω—ã #}
                                    <button type="button" class="btn btn-sm btn-secondary ms-1" onclick="this.closest('.matchUserAction').style.display='none'">Ignore</button> {# –ö–Ω–æ–ø–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è #}
                                </div>
                             </div>
                        </div>

                    </div>
                </div>
            </div>


            <!-- 3) –°–û–°–¢–ê–í–´ –ú–ê–¢–ß–ê (–µ—Å–ª–∏ –º–∞—Ç—á –∏–¥–µ—Ç –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω) -->
            {% if match.status == 'in_progress' or match.status == 'finished' %}
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-light">
                    <h3 class="h5 mb-0">Lineups Used in This Match</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- –î–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞ -->
                        <div class="col-md-6 mb-4">
                            <h6 class="mb-2">{{ match.home_team.name }} <small class="text-muted">({{ match.home_tactic|default:'balanced' }})</small></h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-hover"> {# –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª–∞—Å—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã #}
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Slot</th>
                                            <th>Player</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if home_lineup_list %}
                                            {% for slot, player in home_lineup_list %}
                                            <tr>
                                                <td>Slot {{ slot }}</td>
                                                <td>
                                                    {% if player %}
                                                        {{ player.first_name }} {{ player.last_name }}
                                                        <small class="text-muted">({{ player.position }})</small>
                                                    {% else %}
                                                        <em class="text-danger">No player</em> {# –í—ã–¥–µ–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ #}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="2" class="text-center text-muted"><em>No lineup data available</em></td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- –ì–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ -->
                        <div class="col-md-6 mb-4">
                             <h6 class="mb-2">{{ match.away_team.name }} <small class="text-muted">({{ match.away_tactic|default:'balanced' }})</small></h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-hover"> {# –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–ª–∞—Å—Å—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã #}
                                    <thead>
                                        <tr>
                                            <th style="width: 20%;">Slot</th>
                                            <th>Player</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if away_lineup_list %}
                                            {% for slot, player in away_lineup_list %}
                                            <tr>
                                                <td>Slot {{ slot }}</td>
                                                <td>
                                                    {% if player %}
                                                        {{ player.first_name }} {{ player.last_name }}
                                                        <small class="text-muted">({{ player.position }})</small>
                                                    {% else %}
                                                         <em class="text-danger">No player</em> {# –í—ã–¥–µ–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ #}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                             <tr>
                                                <td colspan="2" class="text-center text-muted"><em>No lineup data available</em></td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div><!-- /.row -->
                </div>
            </div>
            {% endif %} {# –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ –¥–ª—è —Å–æ—Å—Ç–∞–≤–æ–≤ –º–∞—Ç—á–∞ #}

             <!-- –û–±–ª–∞—Å—Ç—å —Ä–µ–ø–ª–µ—è (–µ—Å–ª–∏ –Ω—É–∂–Ω–∞) -->
             <div id="replayArea" style="display: none;">
                 {# –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–ø–ª–µ–µ–º #}
             </div>

            <!-- –ö–Ω–æ–ø–∫–∞ "Back to Matches" -->
            <div class="text-center mb-5"> {# –£–≤–µ–ª–∏—á–µ–Ω –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø #}
                <a href="{% url 'matches:match_list' %}" class="btn btn-outline-secondary"> {# –ò–∑–º–µ–Ω–µ–Ω —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ #}
                    <i class="fas fa-arrow-left me-1"></i> Back to Matches {# –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∫–æ–Ω–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç Font Awesome) #}
                </a>
            </div>

        </div><!-- /.col-12 -->
    </div><!-- /.row -->
</div><!-- /.container -->
{% endblock %}

{% block extra_js %}
{# –ü–æ–¥–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç—ã #}
<script src="{% static 'matches/js/match_replay.js' %}"></script> {# –ï—Å–ª–∏ –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç —Ä–µ–ø–ª–µ—è #}
{# –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π #}
{% if match.status != 'finished' and match.status != 'cancelled' and match.status != 'error' %}
    <script src="{% static 'matches/js/live_match.js' %}"></script>
{% endif %}

{# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap tooltips –¥–ª—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∏–∫–æ–Ω–æ–∫
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], .narrative-icon[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –Ω–∞—Ä—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
    document.querySelectorAll('.narrative-event-item').forEach(function(element) {
        element.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(2px)';
            this.style.transition = 'transform 0.2s ease';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });
});
</script>
{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="{% static 'matches/css/match_detail.css' %}?v=3">
{% endblock %}
