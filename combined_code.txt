
# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\migrations\0001_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import django.contrib.auth.models
import django.contrib.auth.validators
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        migrations.CreateModel(
            name='CustomUser',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'unique': 'A user with that username already exists.'}, help_text='Required. 150 characters or fewer. Letters, digits and @/./+/-/_ only.', max_length=150, unique=True, validators=[django.contrib.auth.validators.UnicodeUsernameValidator()], verbose_name='username')),
                ('first_name', models.CharField(blank=True, max_length=150, verbose_name='first name')),
                ('last_name', models.CharField(blank=True, max_length=150, verbose_name='last name')),
                ('is_staff', models.BooleanField(default=False, help_text='Designates whether the user can log into this admin site.', verbose_name='staff status')),
                ('is_active', models.BooleanField(default=True, help_text='Designates whether this user should be treated as active. Unselect this instead of deleting accounts.', verbose_name='active')),
                ('date_joined', models.DateTimeField(default=django.utils.timezone.now, verbose_name='date joined')),
                ('email', models.EmailField(max_length=254, unique=True)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'verbose_name': 'user',
                'verbose_name_plural': 'users',
                'abstract': False,
            },
            managers=[
                ('objects', django.contrib.auth.models.UserManager()),
            ],
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\migrations\0001_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\login.html ---

{% extends 'core/base.html' %}

{% block title %}Login{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Login</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="form-group mb-3">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    {% for error in field.errors %}
                                        <div class="alert alert-danger mt-1">
                                            {{ error }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="btn btn-primary">Login</button>
                    </form>
                </div>
                <div class="card-footer">
                    <p class="mb-0">Don't have an account? <a href="{% url 'accounts:register' %}">Register here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\login.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\logout.html ---

{% extends 'core/base.html' %}

{% block title %}Logged Out{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Logged Out</h3>
                </div>
                <div class="card-body">
                    <p>You have been successfully logged out.</p>
                    <a href="{% url 'accounts:login' %}" class="btn btn-primary">Login Again</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\logout.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\register.html ---

{% extends 'core/base.html' %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Register</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="form-group mb-3">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    {% for error in field.errors %}
                                        <div class="alert alert-danger mt-1">
                                            {{ error }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                        <button type="submit" class="btn btn-primary">Register</button>
                    </form>
                </div>
                <div class="card-footer">
                    <p class="mb-0">Already have an account? <a href="{% url 'accounts:login' %}">Login here</a></p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\templates\accounts\register.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\admin.py ---

from django.contrib import admin
from .models import CustomUser

class CustomUserAdmin(admin.ModelAdmin):
    list_display = ('username', 'email', 'is_staff', 'last_login')  # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ 'email' –≤ —Å–ø–∏—Å–æ–∫
    search_fields = ('username', 'email')  # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–∏—Å–∫ –ø–æ email —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–µ–Ω

admin.site.register(CustomUser, CustomUserAdmin)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\apps.py ---

from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\forms.py ---

from django import forms
from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
from django.contrib.auth import get_user_model

User = get_user_model()

class CustomUserCreationForm(UserCreationForm):
    email = forms.EmailField(
        widget=forms.EmailInput(attrs={
            'class': 'form-control',
            'placeholder': 'Enter your email'
        })
    )
    username = forms.CharField(
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Choose a username'
        })
    )
    password1 = forms.CharField(
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Enter your password'
        })
    )
    password2 = forms.CharField(
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Confirm your password'
        })
    )

    class Meta:
        model = User
        fields = ("username", "email", "password1", "password2")

class CustomAuthenticationForm(AuthenticationForm):
    username = forms.CharField(
        widget=forms.TextInput(attrs={
            'class': 'form-control',
            'placeholder': 'Enter your username'
        })
    )
    password = forms.CharField(
        widget=forms.PasswordInput(attrs={
            'class': 'form-control',
            'placeholder': 'Enter your password'
        })
    )

    class Meta:
        model = User
        fields = ("username", "password")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\forms.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\models.py ---

from django.contrib.auth.models import AbstractUser
from django.db import models

class CustomUser(AbstractUser):
    email = models.EmailField(unique=True, blank=False)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\tests.py ---

from django.test import TestCase
from django.contrib.auth import get_user_model
from django.urls import reverse

class AuthenticationTestCase(TestCase):
    def setUp(self):
        # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        self.user = get_user_model().objects.create_user(username='testuser', password='12345')

    def test_successful_login(self):
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
        response = self.client.post(reverse('login'), {'username': 'testuser', 'password': '12345'})
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, '–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É')

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\urls.py ---

from django.urls import path
from .views import RegisterView, LoginView, LogoutView

app_name = 'accounts'

urlpatterns = [
    path('register/', RegisterView.as_view(), name='register'),
    path('login/', LoginView.as_view(), name='login'),
    path('logout/', LogoutView.as_view(), name='logout'),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\views.py ---

from django.contrib.auth import logout
from django.shortcuts import redirect
from django.urls import reverse_lazy
from django.views.generic import FormView
from django.contrib.auth.views import LogoutView as BaseLogoutView
from .forms import CustomUserCreationForm, CustomAuthenticationForm
from django.contrib.auth import login, logout

class RegisterView(FormView):
    template_name = 'accounts/register.html'
    form_class = CustomUserCreationForm
    success_url = reverse_lazy('accounts:login')

    def form_valid(self, form):
        user = form.save()
        if hasattr(user, 'club'):
            return redirect('clubs:club_detail', user.club.pk)
        else:
            return redirect('clubs:create_club')

class LoginView(FormView):
    template_name = 'accounts/login.html'
    form_class = CustomAuthenticationForm
    
    def form_valid(self, form):
        user = form.get_user()
        login(self.request, user)
        
        if hasattr(user, 'club'):
            return redirect('clubs:club_detail', user.club.pk)
        return redirect('clubs:create_club')

class LogoutView(BaseLogoutView):
    next_page = reverse_lazy('accounts:login')
    
    def get(self, request, *args, **kwargs):
        return self.post(request, *args, **kwargs)
    
    def post(self, request, *args, **kwargs):
        logout(request)
        return redirect(self.next_page)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\accounts\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\accounts\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\assign_leagues.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from clubs.models import Club
from tournaments.models import League
from django.db.models import Count

class Command(BaseCommand):
    help = 'Assigns clubs to leagues ensuring 16 teams per league'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—Å—Ç–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ª–∏–≥–∞–º —Ç–æ–ª—å–∫–æ –¥–ª—è –±–æ—Ç–æ–≤
                Club.objects.filter(is_bot=True).update(league=None)

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ª–∏–≥–∏, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–∞–Ω–µ –∏ —É—Ä–æ–≤–Ω—é
                leagues = League.objects.all().order_by('country', 'level')
                
                # –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª—É–±—ã
                for league in leagues:
                    existing_clubs = Club.objects.filter(league=league).count()
                    if existing_clubs > 0:
                        self.stdout.write(f"League {league} already has {existing_clubs} clubs")
                        continue

                    # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –±–æ—Ç-–∫–ª—É–±—ã –±–µ–∑ –ª–∏–≥–∏ –∏–∑ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω—ã
                    available_clubs = Club.objects.filter(
                        country=league.country,
                        league__isnull=True,
                        is_bot=True  # –¢–æ–ª—å–∫–æ –±–æ—Ç—ã
                    )[:16]  # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ 16 –∫–ª—É–±–æ–≤
                    
                    if available_clubs.count() < 16:
                        self.stdout.write(
                            self.style.WARNING(
                                f"Not enough bot clubs for {league}. Found only {available_clubs.count()}"
                            )
                        )
                        continue

                    # –ù–∞–∑–Ω–∞—á–∞–µ–º –ª–∏–≥—É –¥–ª—è –∫–ª—É–±–æ–≤
                    for club in available_clubs:
                        club.league = league
                        club.save()
                        
                    self.stdout.write(
                        self.style.SUCCESS(
                            f"Assigned {available_clubs.count()} bot clubs to {league}"
                        )
                    )

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                for league in leagues:
                    bot_count = Club.objects.filter(league=league, is_bot=True).count()
                    human_count = Club.objects.filter(league=league, is_bot=False).count()
                    self.stdout.write(f"{league}: {bot_count} bot teams, {human_count} human teams")

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error occurred: {str(e)}"))
            raise e

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\assign_leagues.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\check_leagues.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from clubs.models import Club
from tournaments.models import League
from django.db.models import Count

class Command(BaseCommand):
    help = 'Checks current distribution of clubs in leagues'

    def handle(self, *args, **options):
        # –°—á–∏—Ç–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ –ª–∏–≥–∏
        unassigned_clubs = Club.objects.filter(league__isnull=True).count()
        self.stdout.write(f"\n–ö–æ–º–∞–Ω–¥—ã –±–µ–∑ –ª–∏–≥–∏: {unassigned_clubs}")

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
        countries = set(Club.objects.values_list('country', flat=True))
        
        self.stdout.write("\n–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º:")
        for country in sorted(countries):
            clubs = Club.objects.filter(country=country)
            leagues = League.objects.filter(country=country).order_by('level')
            
            self.stdout.write(f"\n{country}:")
            self.stdout.write(f"–í—Å–µ–≥–æ –∫–æ–º–∞–Ω–¥: {clubs.count()}")
            self.stdout.write(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏–≥: {leagues.count()}")
            
            if leagues.exists():
                self.stdout.write("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ª–∏–≥–∞–º:")
                for league in leagues:
                    club_count = Club.objects.filter(league=league).count()
                    self.stdout.write(f"  {league.name} (—É—Ä–æ–≤–µ–Ω—å {league.level}): {club_count} –∫–æ–º–∞–Ω–¥")
            
            unassigned = clubs.filter(league__isnull=True).count()
            if unassigned > 0:
                self.stdout.write(f"–ù–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–æ: {unassigned} –∫–æ–º–∞–Ω–¥")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\check_leagues.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\generate_players.py ---

from django.core.management.base import BaseCommand
from clubs.models import Club
from players.models import Player
from django.db import transaction
from faker import Faker
from players.utils import generate_player_stats
from clubs.views import get_locale_from_country_code
from tqdm import tqdm
import random

class Command(BaseCommand):
    help = 'Generates 5 random players for each club'

    def handle(self, *args, **options):
        clubs = Club.objects.all()
        total_clubs = clubs.count()
        
        self.stdout.write(f"Found {total_clubs} clubs. Starting player generation...")
        
        positions = [
            "Goalkeeper",
            "Right Back",
            "Center Back",
            "Left Back",
            "Defensive Midfielder",
            "Central Midfielder",
            "Attacking Midfielder",
            "Right Midfielder",
            "Left Midfielder",
            "Center Forward"
        ]

        with transaction.atomic():
            for club in tqdm(clubs, desc="Generating players"):
                # –°–æ–∑–¥–∞–µ–º Faker —Å –ª–æ–∫–∞–ª—å—é, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞–Ω–µ –∫–ª—É–±–∞
                locale = get_locale_from_country_code(club.country.code)
                fake = Faker(locale)

                # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º –≤—Ä–∞—Ç–∞—Ä—è
                self.create_player_for_club(
                    club=club,
                    fake=fake,
                    position="Goalkeeper",
                    player_class=random.randint(1, 4)
                )
                
                # –°–æ–∑–¥–∞–µ–º –µ—â–µ 4 —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–∞
                for _ in range(4):
                    # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Ä–∞—Ç–∞—Ä—è –∏–∑ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–∑–∏—Ü–∏–π
                    position = random.choice([pos for pos in positions if pos != "Goalkeeper"])
                    self.create_player_for_club(
                        club=club,
                        fake=fake,
                        position=position,
                        player_class=random.randint(1, 4)
                    )
        
        self.stdout.write(self.style.SUCCESS(
            f'Successfully generated {total_clubs * 5} players for {total_clubs} clubs'
        ))

    def create_player_for_club(self, club, fake, position, player_class):
        """–°–æ–∑–¥–∞–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∫–ª—É–±–∞"""
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
        while True:
            first_name = fake.first_name_male()
            last_name = fake.last_name_male() if hasattr(fake, 'last_name_male') else fake.last_name()
            if not Player.objects.filter(first_name=first_name, last_name=last_name).exists():
                break

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏
        stats = generate_player_stats(position, player_class)

        if position == 'Goalkeeper':
            player = Player.objects.create(
                club=club,
                first_name=first_name,
                last_name=last_name,
                nationality=club.country,
                age=17,
                position=position,
                player_class=player_class,
                strength=stats['strength'],
                stamina=stats['stamina'],
                pace=stats['pace'],
                positioning=stats['positioning'],
                reflexes=stats['reflexes'],
                handling=stats['handling'],
                aerial=stats['aerial'],
                jumping=stats['jumping'],
                command=stats['command'],
                throwing=stats['throwing'],
                kicking=stats['kicking']
            )
        else:
            player = Player.objects.create(
                club=club,
                first_name=first_name,
                last_name=last_name,
                nationality=club.country,
                age=17,
                position=position,
                player_class=player_class,
                strength=stats['strength'],
                stamina=stats['stamina'],
                pace=stats['pace'],
                marking=stats['marking'],
                tackling=stats['tackling'],
                work_rate=stats['work_rate'],
                positioning=stats['positioning'],
                passing=stats['passing'],
                crossing=stats['crossing'],
                dribbling=stats['dribbling'],
                ball_control=stats['ball_control'],
                heading=stats['heading'],
                finishing=stats['finishing'],
                long_range=stats['long_range'],
                vision=stats['vision']
            )

        return player

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\generate_players.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\commands\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\management\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\0001_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Club',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, verbose_name='Club Name')),
                ('country', django_countries.fields.CountryField(max_length=2, verbose_name='Country')),
                ('lineup', models.JSONField(blank=True, null=True)),
                ('is_bot', models.BooleanField(default=False, help_text='Indicates if this team is controlled by AI', verbose_name='Bot Team')),
                ('promoted', models.BooleanField(default=False, help_text='–ö–æ–º–∞–Ω–¥–∞ –ø–æ–≤—ã—à–µ–Ω–∞ –≤ –∫–ª–∞—Å—Å–µ')),
                ('relegated', models.BooleanField(default=False, help_text='–ö–æ–º–∞–Ω–¥–∞ –ø–æ–Ω–∏–∂–µ–Ω–∞ –≤ –∫–ª–∞—Å—Å–µ')),
            ],
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\0001_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\0002_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('clubs', '0001_initial'),
        ('tournaments', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AddField(
            model_name='club',
            name='league',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='clubs', to='tournaments.league'),
        ),
        migrations.AddField(
            model_name='club',
            name='owner',
            field=models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='club', to=settings.AUTH_USER_MODEL, verbose_name='Owner'),
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\0002_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\club_detail.html ---

{% extends 'core/base.html' %}

{% block title %}{{ club.name }}{% endblock %}

{% block content %}
<div class="container">
    <!-- Club Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1>
                        {{ club.name }}
                        {% if club.is_bot %}
                            <span class="badge bg-secondary">BOT</span>
                        {% endif %}
                    </h1>
                    <div class="club-info">
                        <p class="mb-1">
                            <strong>Country:</strong> {{ club.country }}
                        </p>
                        <p class="mb-1">
                            <strong>League:</strong> {{ club.league.name }} (Division {{ club.league.level }})
                        </p>
                        <p class="mb-1">
                            <strong>Status:</strong>
                            {% if club.is_bot %}
                                <span class="text-muted">AI Controlled</span>
                            {% else %}
                                Owned by {{ club.owner.username }}
                            {% endif %}
                        </p>
                    </div>
                </div>
                {% if user == club.owner %}
                <div>
                    <a href="{% url 'clubs:team_selection' club.id %}" class="btn btn-primary">
                        Select Team Lineup
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Players Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title h4 mb-0">Players</h2>
                </div>
                <div class="card-body">
                    {% if user == club.owner %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <form method="get" action="{% url 'clubs:create_player' club.id %}" class="row g-3">
                                <div class="col-md-4">
                                    <label for="position" class="form-label">Choose Position:</label>
                                    <select class="form-select" id="position" name="position" required>
                                        <option value="">Select a position</option>
                                        <option value="Goalkeeper">Goalkeeper</option>
                                        <option value="Right Back">Right Back</option>
                                        <option value="Left Back">Left Back</option>
                                        <option value="Center Back">Center Back</option>
                                        <option value="Defensive Midfielder">Defensive Midfielder</option>
                                        <option value="Right Midfielder">Right Midfielder</option>
                                        <option value="Central Midfielder">Central Midfielder</option>
                                        <option value="Left Midfielder">Left Midfielder</option>
                                        <option value="Attacking Midfielder">Attacking Midfielder</option>
                                        <option value="Center Forward">Center Forward</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="player_class" class="form-label">Choose Player Class:</label>
                                    <select class="form-select" id="player_class" name="player_class" required>
                                        <option value="">Select a class</option>
                                        <option value="1">Class 1</option>
                                        <option value="2">Class 2</option>
                                        <option value="3">Class 3</option>
                                        <option value="4">Class 4</option>
                                    </select>
                                </div>
                                <div class="col-md-4 d-flex align-items-end gap-2">
                                    <button type="submit" class="btn btn-primary">Create Player</button>
                                    <a href="{% url 'matches:simulate_match' 0 %}" class="btn btn-primary" target="_blank">Create New Match</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Position</th>
                                    <th>Class</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player in players %}
                                <tr>
                                    <td>{{ player.first_name }} {{ player.last_name }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ player.position }}</span>
                                    </td>
                                    <td>
                                        {% if player.player_class %}
                                            <span class="badge bg-info">Class {{ player.player_class }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'players:player_detail' player.pk %}" 
                                           class="btn btn-sm btn-outline-primary">
                                            View Details
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center">No players found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\club_detail.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\create_club.html ---

{% extends 'core/base.html' %}
{% block title %}Create Club{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">Create New Club</h3>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        {% for field in form %}
                            <div class="form-group mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.help_text %}
                                    <small class="form-text text-muted">{{ field.help_text }}</small>
                                {% endif %}
                                {% if field.errors %}
                                    {% for error in field.errors %}
                                        <div class="alert alert-danger mt-1">
                                            {{ error }}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% endfor %}
                        {% if form.non_field_errors %}
                            {% for error in form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ error }}
                                </div>
                            {% endfor %}
                        {% endif %}
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Create Club</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\create_club.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\team_selection.html ---

{% extends 'core/base.html' %}
{% load static %}

{% block title %}Team Selection - {{ club.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">Team Selection</h2>
                        <a href="{% url 'clubs:club_detail' club.id %}" class="btn btn-outline-secondary">
                            Back to Club
                        </a>
                    </div>
                </div>
                <div class="card-body">

                    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∞–∫—Ç–∏–∫–∏ -->
                    <div class="tactics-section">
                        <label for="tacticSelect"><strong>Select Tactic:</strong></label>
                        <select id="tacticSelect">
                            <option value="attacking">Attacking</option>
                            <option value="balanced" selected>Balanced</option>
                            <option value="defensive">Defensive</option>
                        </select>
                    </div>
                    <!-- –ö–æ–Ω–µ—Ü —Å–µ–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ —Ç–∞–∫—Ç–∏–∫–∏ -->

                    <div class="pitch" id="pitch">
                        <!-- Player slots will be added here dynamically -->
                    </div>

                    <div class="text-center mt-4">
                        <button id="resetButton" class="btn btn-warning">Reset Lineup</button>
                        <div id="saveStatus" class="mt-2"></div>
                    </div>

                    <div class="mt-4">
                        <h3 class="h4 mb-3">Available Players</h3>
                        <div class="player-list" id="playerList">
                            <!-- Available players will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –∫–ª—É–±–∞ -->
<input type="hidden" id="clubId" value="{{ club.id }}">

<style>
    .pitch {
        width: 100%;
        max-width: 800px;
        height: 600px;
        background-color: #4CAF50;
        background-image: 
            linear-gradient(#ffffff 1px, transparent 1px),
            linear-gradient(90deg, #ffffff 1px, transparent 1px);
        background-size: 50px 50px;
        position: relative;
        margin: 0 auto;
        border: 2px solid #388E3C;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .player-slot {
        width: 70px;
        height: 70px;
        background-color: rgba(255, 255, 255, 0.8);
        border: 2px solid #fff;
        border-radius: 50%;
        position: absolute;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        transition: all 0.2s ease;
        transform: translate(-50%, -50%);
    }

    .player-slot:hover {
        background-color: rgba(255, 255, 255, 0.9);
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }

    .player-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        min-height: 100px;
    }

    .player-item {
        width: 130px;
        height: 70px;
        background-color: #fff;
        padding: 8px;
        cursor: move;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        font-size: 12px;
        text-align: center;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
        margin: 0;
    }

    .player-item:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .player-item.goalkeeper {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .player-item.defender {
        background-color: #cfe2ff;
        border-left: 4px solid #0d6efd;
    }

    .player-item.midfielder {
        background-color: #d1e7dd;
        border-left: 4px solid #198754;
    }

    .player-item.forward {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .player-name {
        font-weight: bold;
        margin-bottom: 4px;
    }

    .player-position {
        font-size: 11px;
        color: #6c757d;
    }

    .position-label {
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        font-weight: bold;
        background-color: rgba(0,0,0,0.3);
        padding: 2px 6px;
        border-radius: 3px;
    }

    .sortable-ghost {
        opacity: 0.4;
    }

    .sortable-chosen {
        opacity: 0.8;
        transform: scale(1.05);
    }

    .sortable-drag {
        opacity: 0.8;
    }

    #saveStatus {
        min-height: 24px;
        transition: all 0.3s ease;
    }

    #saveStatus.alert {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0;
        font-size: 14px;
    }

    .pitch::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background-color: rgba(255, 255, 255, 0.5);
    }

    .pitch::after {
        content: '';
        position: absolute;
        top: 25%;
        bottom: 25%;
        left: 50%;
        width: 2px;
        background-color: rgba(255, 255, 255, 0.5);
        transform: translateX(-50%);
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="{% static 'js/team_selection.js' %}"></script>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\templates\clubs\team_selection.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\admin.py ---

from django.contrib import admin
from .models import Club

@admin.register(Club)
class ClubAdmin(admin.ModelAdmin):
    list_display = ['name', 'country', 'owner', 'is_bot']  # —è–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º –≤—Å–µ –ø–æ–ª—è
    list_filter = ['country', 'is_bot']
    search_fields = ['name', 'owner__username']

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\apps.py ---

from django.apps import AppConfig


class ClubsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'clubs'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\country_locales.py ---

# country_locales.py

country_locales = {
    'US': 'en_US',
    'FR': 'fr_FR',
    'DE': 'de_DE',
    'ES': 'es_ES',
    'IT': 'it_IT',
    'RU': 'ru_RU',
    # –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\country_locales.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\forms.py ---

from django import forms
from django_countries.widgets import CountrySelectWidget
from .models import Club

class ClubForm(forms.ModelForm):
    class Meta:
        model = Club
        fields = ['name', 'country']
        widgets = {
            'name': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': 'Enter club name'
            }),
            'country': CountrySelectWidget(attrs={
                'class': 'form-control'
            })
        }

    def clean(self):
        cleaned_data = super().clean()
        self.instance._skip_clean = True
        return cleaned_data

    def save(self, commit=True, user=None):
        instance = super().save(commit=False)
        
        if user:
            instance.owner = user
            instance.is_bot = False
        
        if commit and not hasattr(instance, '_skip_save'):
            instance._skip_save = True
            instance.save()
        
        return instance
    



# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\forms.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\models.py ---

from django.db import models
from django.conf import settings
from django_countries.fields import CountryField
from django.core.exceptions import ValidationError

class Club(models.Model):
    name = models.CharField(max_length=100, verbose_name="Club Name")
    country = CountryField(blank_label='(select country)', verbose_name="Country")
    owner = models.OneToOneField(
        settings.AUTH_USER_MODEL, 
        on_delete=models.CASCADE, 
        verbose_name="Owner", 
        related_name="club",
        null=True,
        blank=True
    )
    league = models.ForeignKey(
        'tournaments.League',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='clubs'
    )
    lineup = models.JSONField(null=True, blank=True)
    is_bot = models.BooleanField(
        default=False,
        verbose_name="Bot Team",
        help_text="Indicates if this team is controlled by AI"
    )
    promoted = models.BooleanField(
        default=False,
        help_text="–ö–æ–º–∞–Ω–¥–∞ –ø–æ–≤—ã—à–µ–Ω–∞ –≤ –∫–ª–∞—Å—Å–µ"
    )
    relegated = models.BooleanField(
        default=False,
        help_text="–ö–æ–º–∞–Ω–¥–∞ –ø–æ–Ω–∏–∂–µ–Ω–∞ –≤ –∫–ª–∞—Å—Å–µ"
    )

    def __str__(self):
        return self.name

    def clean(self):
        if hasattr(self, '_skip_clean'):
            return
            
        if not self.is_bot and not self.owner:
            raise ValidationError("Non-bot teams must have an owner")

    def save(self, *args, **kwargs):
        if not hasattr(self, '_skip_clean'):
            self.full_clean()
        super().save(*args, **kwargs)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\tests.py ---

from django.test import TestCase

# Create your tests here.

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\urls.py ---

from django.urls import path
from . import views

app_name = 'clubs'

urlpatterns = [
    path('create/', views.CreateClubView.as_view(), name='create_club'),
    path('detail/<int:pk>/', views.ClubDetailView.as_view(), name='club_detail'),
    path('detail/<int:pk>/create_player/', views.create_player, name='create_player'),
    path('detail/<int:pk>/team-selection/', views.team_selection_view, name='team_selection'),
    path('detail/<int:pk>/get-players/', views.get_players, name='get_players'),
    path('detail/<int:pk>/save-team-lineup/', views.save_team_lineup, name='save_team_lineup'),
    path('detail/<int:pk>/get-team-lineup/', views.get_team_lineup, name='get_team_lineup'),
    
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\views.py ---

from django.shortcuts import redirect, render, get_object_or_404
from django.views.generic import CreateView, DetailView
from django.contrib import messages
from django.http import JsonResponse, HttpResponse
from django.views.decorators.http import require_http_methods
from django.db import transaction
from faker import Faker
from .models import Club
from players.models import Player
from tournaments.models import Championship, League
from players.utils import generate_player_stats
from .country_locales import country_locales
from .forms import ClubForm
import json
import random
import logging

logger = logging.getLogger(__name__)

class CreateClubView(CreateView):
    model = Club
    form_class = ClubForm
    template_name = 'clubs/create_club.html'

    def form_valid(self, form):
        try:
            with transaction.atomic():
                # 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                club = form.save(commit=False)
                
                # 2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
                club.owner = self.request.user
                club.is_bot = False
                club._skip_clean = True
                
                # 3. –ù–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –ª–∏–≥—É
                league = League.objects.filter(
                    country=club.country,
                    level=1
                ).first()
                
                if not league:
                    messages.error(
                        self.request,
                        f'–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ª–∏–≥–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω—ã {club.country.name}'
                    )
                    return self.form_invalid(form)

                club.league = league
                
                # 4. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—É–±
                club.save()

                # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º ID —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                if not club.id:
                    messages.error(self.request, "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—É–±–∞: –Ω–µ –ø–æ–ª—É—á–µ–Ω ID")
                    return self.form_invalid(form)

                messages.info(self.request, f"–ö–ª—É–± —Å–æ–∑–¥–∞–Ω —Å ID: {club.id}")
                
                # 6. –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —Å–∏–≥–Ω–∞–ª —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è
                from time import sleep
                sleep(0.2)
                
                # 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
                championship = Championship.objects.filter(
                    teams=club,
                    season__is_active=True
                ).first()
                
                if championship:
                    messages.success(
                        self.request,
                        f'–ö–ª—É–± "{club.name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ {championship.league.name}!'
                    )
                else:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ
                    active_season = Championship.objects.filter(
                        season__is_active=True
                    ).exists()
                    if not active_season:
                        messages.warning(
                            self.request,
                            '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ.'
                        )
                    else:
                        messages.warning(
                            self.request,
                            f'–ö–ª—É–± "{club.name}" —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç. '
                            '–í–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç.'
                        )

                # 8. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–ª—É–±–∞
                return redirect('clubs:club_detail', pk=club.id)
                    
        except Exception as e:
            logger.error(f'Error creating club: {str(e)}')
            messages.error(self.request, f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—É–±–∞: {str(e)}')
            return self.form_invalid(form)

    def form_invalid(self, form):
        messages.error(
            self.request, 
            '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª—É–±–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.'
        )
        return super().form_invalid(form)

class ClubDetailView(DetailView):
    model = Club
    template_name = 'clubs/club_detail.html'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['players'] = Player.objects.filter(club=self.object)
        
        championship = Championship.objects.filter(
            teams=self.object,
            season__is_active=True
        ).first()
        context['championship'] = championship
        
        return context

def get_locale_from_country_code(country_code):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∫–∞–ª—å –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã"""
    return country_locales.get(country_code, 'en_US')

@require_http_methods(["GET"])
def create_player(request, pk):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –∫–ª—É–±–∞"""
    club = get_object_or_404(Club, pk=pk)
    if club.owner != request.user:
        return HttpResponse("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤ –≤ —ç—Ç–æ–º –∫–ª—É–±–µ.", status=403)
    
    position = request.GET.get('position')
    player_class = int(request.GET.get('player_class', 1))
    
    if not position:
        return HttpResponse("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏—é.")

    country_code = club.country.code
    locale = get_locale_from_country_code(country_code)
    fake = Faker(locale)

    attempts = 0
    max_attempts = 100
    while attempts < max_attempts:
        first_name = fake.first_name_male()
        last_name = fake.last_name_male() if hasattr(fake, 'last_name_male') else fake.last_name()
        if not Player.objects.filter(first_name=first_name, last_name=last_name).exists():
            break
        attempts += 1
    
    if attempts >= max_attempts:
        messages.error(request, f'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –∏–≥—Ä–æ–∫–∞')
        return redirect('clubs:club_detail', pk=pk)

    try:
        stats = generate_player_stats(position, player_class)
        
        player = Player.objects.create(
            club=club,
            first_name=first_name,
            last_name=last_name,
            nationality=club.country,
            age=random.randint(17, 35),
            position=position,
            player_class=player_class,
            **stats
        )

        messages.success(
            request, 
            f'–ò–≥—Ä–æ–∫ {player.first_name} {player.last_name} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'
        )
    except Exception as e:
        messages.error(
            request,
            f'–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞: {str(e)}'
        )
        logger.error(f'Error creating player: {str(e)}')

    return redirect('clubs:club_detail', pk=pk)

@require_http_methods(["GET"])
def team_selection_view(request, pk):
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—ã–±–æ—Ä–∞ —Å–æ—Å—Ç–∞–≤–∞"""
    club = get_object_or_404(Club, pk=pk)
    if club.owner != request.user:
        messages.error(request, "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.")
        return redirect('clubs:club_detail', pk=pk)
    
    context = {
        'club': club,
        'current_section': 'team_selection'
    }
    # –†–µ–Ω–¥–µ—Ä–∏–º —à–∞–±–ª–æ–Ω –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞, –≥–¥–µ —É–∂–µ –µ—Å—Ç—å select –¥–ª—è —Ç–∞–∫—Ç–∏–∫–∏
    return render(request, 'clubs/team_selection.html', context)

@require_http_methods(["GET"])
def get_players(request, pk):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –∫–ª—É–±–∞"""
    club = get_object_or_404(Club, pk=pk)
    if club.owner != request.user:
        return JsonResponse({"error": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"}, status=403)
    
    players = Player.objects.filter(club=club)
    player_data = [{
        'id': player.id,
        'name': f"{player.first_name} {player.last_name}",
        'position': player.position,
        'playerClass': player.player_class,
        'attributes': {
            'stamina': player.stamina,
            'strength': player.strength,
            'speed': player.pace
        }
    } for player in players]
    return JsonResponse(player_data, safe=False)

@require_http_methods(["POST"])
def save_team_lineup(request, pk):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–∞–Ω–¥—ã –∏ —Ç–∞–∫—Ç–∏–∫–∏"""
    club = get_object_or_404(Club, pk=pk)
    if club.owner != request.user:
        return JsonResponse({"error": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"}, status=403)
    
    try:
        data = json.loads(request.body)
        lineup = data.get('lineup', {})
        tactic = data.get('tactic', 'balanced')  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞

        if len(lineup) > 11:
            return JsonResponse({
                "success": False,
                "error": "–í —Å–æ—Å—Ç–∞–≤–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 11 –∏–≥—Ä–æ–∫–æ–≤"
            })

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Ä–∞—Ç–∞—Ä—è
        goalkeeper_positions = [
            pos for pos, player_id in lineup.items() 
            if Player.objects.get(id=player_id).position == 'Goalkeeper'
        ]
        if not goalkeeper_positions:
            return JsonResponse({
                "success": False,
                "error": "–í —Å–æ—Å—Ç–∞–≤–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—Ä–∞—Ç–∞—Ä—å"
            })

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–∞–≤ –∏ —Ç–∞–∫—Ç–∏–∫—É –≤ –∫–ª—É–±
        # –ü—Ä–µ–¥—Å—Ç–∞–≤–∏–º, —á—Ç–æ club.lineup - JSONField –∏–ª–∏ TextField, –≥–¥–µ –º—ã –º–æ–∂–µ–º —Ö—Ä–∞–Ω–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å
        club.lineup = {
            'lineup': lineup,
            'tactic': tactic
        }
        club.save()
        
        return JsonResponse({
            "success": True,
            "message": "–°–æ—Å—Ç–∞–≤ –∏ —Ç–∞–∫—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
        })
        
    except json.JSONDecodeError:
        return JsonResponse({
            "success": False,
            "error": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö"
        }, status=400)
    except Exception as e:
        logger.error(f'Error saving team lineup: {str(e)}')
        return JsonResponse({
            "success": False,
            "error": str(e)
        }, status=500)

@require_http_methods(["GET"])
def get_team_lineup(request, pk):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–∞–Ω–¥—ã –∏ —Ç–∞–∫—Ç–∏–∫–∏"""
    club = get_object_or_404(Club, pk=pk)
    if club.owner != request.user:
        return JsonResponse({"error": "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω"}, status=403)
    
    data = club.lineup or {}
    lineup = data.get('lineup', {})
    tactic = data.get('tactic', 'balanced')

    lineup_data = {
        'lineup': lineup,
        'tactic': tactic,
        'players': {}
    }
    
    if lineup:
        players = Player.objects.filter(id__in=lineup.values())
        lineup_data['players'] = {
            str(player.id): {
                'name': f"{player.first_name} {player.last_name}",
                'position': player.position,
                'playerClass': player.player_class
            } for player in players
        }
    
    return JsonResponse(lineup_data)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\clubs\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\clubs\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\templates\core\base.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Football Manager{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">Football Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            {% if user.club and user.club.id %}
                                <a class="nav-link" href="{% url 'clubs:club_detail' user.club.id %}">My Club</a>
                            {% else %}
                                <a class="nav-link" href="{% url 'clubs:create_club' %}">Create Club</a>
                            {% endif %}
                        </li>
                        <li class="nav-item">
                            {% if user.club and user.club.id %}
                                <a class="nav-link" href="{% url 'tournaments:my_championship' %}">Tournaments</a>
                            {% else %}
                                <a class="nav-link" href="{% url 'tournaments:championship_list' %}">Tournaments</a>
                            {% endif %}
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'matches:match_list' %}">Matches</a>
                        </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav">
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'accounts:logout' %}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'accounts:login' %}">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'accounts:register' %}">Register</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\templates\core\base.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\templates\core\home.html ---

{% extends 'core/base.html' %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="text-center mb-5">
                <h1 class="display-4">Welcome to Football Manager</h1>
                <p class="lead">Manage your team and compete in championships!</p>
            </div>

            {% if user.is_authenticated %}
                {% if user.club %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title h5 mb-0">Your Club</h3>
                            </div>
                            <div class="card-body">
                                <h4 class="h5">{{ user.club.name }}</h4>
                                <p class="mb-2">
                                    <strong>League:</strong> {{ user.club.league.name }}
                                </p>
                                <a href="{% url 'clubs:club_detail' user.club.id %}" 
                                   class="btn btn-primary">View Club</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title h5 mb-0">Quick Actions</h3>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="{% url 'tournaments:championship_detail' user.club.championship_set.first.id %}" 
                                       class="btn btn-outline-primary">View Championship</a>
                                    <a href="{% url 'clubs:team_selection' user.club.id %}" 
                                       class="btn btn-outline-primary">Select Team</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center mb-4">
                    <a href="{% url 'clubs:create_club' %}" class="btn btn-primary btn-lg">Create Your Club</a>
                </div>
                {% endif %}
            {% else %}
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 class="h4 mb-4">Get Started</h3>
                            <div class="d-grid gap-3">
                                <a href="{% url 'login' %}" class="btn btn-primary btn-lg">Login</a>
                                <a href="{% url 'register' %}" class="btn btn-outline-primary btn-lg">Register</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if championships %}
            <div class="mt-5">
                <h2 class="h3 mb-4">Active Championships</h2>
                <div class="row">
                    {% for championship in championships %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">{{ championship.league.name }}</h5>
                                <p class="card-text">
                                    <small class="text-muted">
                                        {{ championship.league.country.name }} - 
                                        Division {{ championship.league.level }}
                                    </small>
                                </p>
                                <a href="{% url 'tournaments:championship_detail' championship.id %}" 
                                   class="btn btn-outline-primary btn-sm">View Details</a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\templates\core\home.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\admin.py ---

from django.contrib import admin

# Register your models here.

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\apps.py ---

from django.apps import AppConfig


class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\models.py ---

from django.db import models

# Create your models here.

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\tests.py ---

from django.test import TestCase

# Create your tests here.

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\urls.py ---

from django.urls import path
from .views import home

urlpatterns = [
    path('', home, name='home'),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\views.py ---

from django.shortcuts import render, redirect
from django.contrib.auth.decorators import login_required

def home(request):
    if request.user.is_authenticated:
        if hasattr(request.user, 'club'):
            return redirect('clubs:club_detail', pk=request.user.club.id)
        return redirect('clubs:create_club')
    return redirect('accounts:login')  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω namespace

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\core\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\core\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\management\commands\test_match.py ---

from django.core.management.base import BaseCommand
from django.utils import timezone
from clubs.models import Club
from matches.models import Match
from matches.match_simulation import MatchSimulation
import random

class Command(BaseCommand):
    help = 'Tests match simulation with random teams'

    def handle(self, *args, **options):
        try:
            # Get random teams
            teams = list(Club.objects.all().order_by('?')[:2])
            if len(teams) < 2:
                self.stdout.write(self.style.ERROR('Not enough teams in database'))
                return

            home_team = teams[0]
            away_team = teams[1]

            # Display team information
            self.stdout.write('\nTeam Information:')
            self.stdout.write(f'\nHome team: {home_team.name}')
            self.stdout.write(f'Players: {home_team.player_set.count()}')
            
            self.stdout.write(f'\nAway team: {away_team.name}')
            self.stdout.write(f'Players: {away_team.player_set.count()}\n')

            # Create test match
            match = Match.objects.create(
                home_team=home_team,
                away_team=away_team,
                date=timezone.now(),
                status='scheduled'
            )

            # Initialize simulation
            simulation = MatchSimulation(match)
            
            # Simulate match
            self.stdout.write('\n=== MATCH START ===\n')
            
            for minute in range(90):
                if minute % 5 == 0:  # Show status every 5 minutes
                    self.stdout.write(f'\n=== MINUTE {minute} ===')
                    self.stdout.write(f'Score: {match.home_score} - {match.away_score}')
                    self.stdout.write(f'Possession: {simulation.match_stats["home"]["possession"]}% - {simulation.match_stats["away"]["possession"]}%')
                    self.stdout.write(f'Shots (on target): {simulation.match_stats["home"]["shots"]} ({simulation.match_stats["home"]["shots_on_target"]}) - {simulation.match_stats["away"]["shots"]} ({simulation.match_stats["away"]["shots_on_target"]})')
                
                simulation.simulate_minute(minute)
                
                # Show events immediately after they happen
                events = match.events.filter(minute=minute)
                for event in events:
                    self.stdout.write(f'{event.minute}\' - {event.description}')
            
            # Final statistics
            self.stdout.write('\n=== FINAL STATISTICS ===')
            self.stdout.write(f'\nFinal score: {match.home_score} - {match.away_score}')
            
            self.stdout.write('\nHome team statistics:')
            self.stdout.write(f'Possession: {simulation.match_stats["home"]["possession"]}%')
            self.stdout.write(f'Shots (on target): {simulation.match_stats["home"]["shots"]} ({simulation.match_stats["home"]["shots_on_target"]})')
            self.stdout.write(f'Corners: {simulation.match_stats["home"]["corners"]}')
            self.stdout.write(f'Fouls: {simulation.match_stats["home"]["fouls"]}')
            self.stdout.write(f'Attacks (dangerous): {simulation.match_stats["home"]["attacks"]} ({simulation.match_stats["home"]["dangerous_attacks"]})')
            
            self.stdout.write('\nAway team statistics:')
            self.stdout.write(f'Possession: {simulation.match_stats["away"]["possession"]}%')
            self.stdout.write(f'Shots (on target): {simulation.match_stats["away"]["shots"]} ({simulation.match_stats["away"]["shots_on_target"]})')
            self.stdout.write(f'Corners: {simulation.match_stats["away"]["corners"]}')
            self.stdout.write(f'Fouls: {simulation.match_stats["away"]["fouls"]}')
            self.stdout.write(f'Attacks (dangerous): {simulation.match_stats["away"]["attacks"]} ({simulation.match_stats["away"]["dangerous_attacks"]})')

        except Exception as e:
            self.stdout.write(self.style.ERROR(f'\nError occurred: {str(e)}'))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\management\commands\test_match.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0001_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('clubs', '0001_initial'),
        ('players', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Match',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('datetime', models.DateTimeField(blank=True, db_index=True, null=True, verbose_name='Match Date and Time')),
                ('processed', models.BooleanField(db_index=True, default=False, help_text='Indicates if match has been processed')),
                ('home_score', models.PositiveIntegerField(default=0)),
                ('away_score', models.PositiveIntegerField(default=0)),
                ('status', models.CharField(choices=[('scheduled', 'Scheduled'), ('in_progress', 'In Progress'), ('finished', 'Finished'), ('cancelled', 'Cancelled')], db_index=True, default='scheduled', max_length=20)),
                ('home_lineup', models.JSONField(blank=True, null=True)),
                ('away_lineup', models.JSONField(blank=True, null=True)),
                ('away_team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='away_matches', to='clubs.club')),
                ('home_team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='home_matches', to='clubs.club')),
            ],
        ),
        migrations.CreateModel(
            name='MatchEvent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('minute', models.PositiveIntegerField()),
                ('event_type', models.CharField(choices=[('goal', 'Goal'), ('yellow_card', 'Yellow Card'), ('red_card', 'Red Card'), ('substitution', 'Substitution')], max_length=20)),
                ('description', models.TextField()),
                ('match', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='events', to='matches.match')),
                ('player', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='players.player')),
            ],
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0001_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0002_alter_matchevent_event_type_alter_matchevent_player.py ---

# Generated by Django 5.0.1 on 2024-12-07 16:48

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('matches', '0001_initial'),
        ('players', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='matchevent',
            name='event_type',
            field=models.CharField(choices=[('goal', 'Goal'), ('yellow_card', 'Yellow Card'), ('red_card', 'Red Card'), ('substitution', 'Substitution'), ('possession', 'Possession Change'), ('miss', 'Miss')], max_length=20),
        ),
        migrations.AlterField(
            model_name='matchevent',
            name='player',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='players.player'),
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0002_alter_matchevent_event_type_alter_matchevent_player.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0003_alter_matchevent_event_type.py ---

# Generated by Django 5.0.1 on 2024-12-07 16:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('matches', '0002_alter_matchevent_event_type_alter_matchevent_player'),
    ]

    operations = [
        migrations.AlterField(
            model_name='matchevent',
            name='event_type',
            field=models.CharField(choices=[('goal', 'Goal'), ('miss', 'Miss'), ('possession', 'Possession Change'), ('defense_to_midfield', 'Defense to Midfield Transition'), ('midfield_to_attack', 'Midfield to Attack Transition'), ('attack_to_shot', 'Attack to Shot Opportunity'), ('interception', 'Interception'), ('yellow_card', 'Yellow Card'), ('red_card', 'Red Card'), ('substitution', 'Substitution')], max_length=20),
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0003_alter_matchevent_event_type.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0004_match_current_minute.py ---

# Generated by Django 5.0.1 on 2024-12-18 18:28

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('matches', '0003_alter_matchevent_event_type'),
    ]

    operations = [
        migrations.AddField(
            model_name='match',
            name='current_minute',
            field=models.PositiveIntegerField(default=0),
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\0004_match_current_minute.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\static\matches\js\team_selection.js ---

document.addEventListener('DOMContentLoaded', function() {
    const pitch = document.getElementById('pitch');
    const playerList = document.getElementById('playerList');
    const resetButton = document.getElementById('resetTeam');
    const saveStatus = document.getElementById('saveStatus');
    const tacticSelect = document.getElementById('tacticSelect');
    const clubId = document.getElementById('clubId').value;
    let saveTimeout;

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø–æ–ª–µ
    const positions = [
        {top: '10%', left: '50%'},  // GK
        {top: '30%', left: '20%'}, {top: '30%', left: '40%'},  // DEF
        {top: '30%', left: '60%'}, {top: '30%', left: '80%'},
        {top: '60%', left: '30%'}, {top: '60%', left: '50%'},  // MID
        {top: '60%', left: '70%'},
        {top: '80%', left: '30%'}, {top: '80%', left: '50%'},  // FWD
        {top: '80%', left: '70%'}
    ];

    positions.forEach((pos, index) => {
        const slot = document.createElement('div');
        slot.className = 'player-slot';
        slot.style.top = pos.top;
        slot.style.left = pos.left;
        slot.dataset.position = index;
        pitch.appendChild(slot);
    });

    function autoSave() {
        clearTimeout(saveTimeout);
        saveStatus.textContent = 'Saving...';
        saveTimeout = setTimeout(() => {
            saveTeamSelection();
        }, 1000); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    }

    function saveTeamSelection() {
        const selection = {};
        document.querySelectorAll('.player-slot').forEach(slot => {
            const playerElem = slot.querySelector('.player-item');
            if (playerElem) {
                selection[slot.dataset.position] = playerElem.dataset.playerId;
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫—Ç–∏–∫—É –∫ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–º –¥–∞–Ω–Ω—ã–º
        const tactic = tacticSelect.value;

        const payload = {
            lineup: selection,
            tactic: tactic
        };

        fetch(`/clubs/${clubId}/save-team-lineup/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                saveStatus.textContent = 'Saved';
                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 2000);
            } else {
                saveStatus.textContent = 'Save failed';
            }
        })
        .catch(error => {
            saveStatus.textContent = 'Save failed';
        });
    }

    function loadPreviousSelection() {
        fetch(`/clubs/${clubId}/get-team-lineup/`)
            .then(response => response.json())
            .then(data => {
                if (data.lineup) {
                    Object.entries(data.lineup).forEach(([position, playerId]) => {
                        const slot = document.querySelector(`.player-slot[data-position="${position}"]`);
                        const player = document.querySelector(`.player-item[data-player-id="${playerId}"]`);
                        if (slot && player) {
                            slot.appendChild(player);
                        }
                    });
                }

                // –ï—Å–ª–∏ –≤ –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å —Ç–∞–∫—Ç–∏–∫–∞, –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
                if (data.tactic) {
                    tacticSelect.value = data.tactic;
                }
            });
    }

    function resetSelection() {
        document.querySelectorAll('.player-slot .player-item').forEach(player => {
            playerList.appendChild(player);
        });
        autoSave();
    }

    function initializeSortable() {
        new Sortable(playerList, {
            group: 'shared',
            animation: 150,
            onEnd: autoSave
        });

        document.querySelectorAll('.player-slot').forEach(slot => {
            new Sortable(slot, {
                group: 'shared',
                animation: 150,
                onAdd: function(evt) {
                    const slotElement = evt.to;
                    const newPlayer = evt.item;

                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Å–ª–æ—Ç–∞
                    slotElement.querySelectorAll('.player-item').forEach(player => {
                        if (player !== newPlayer) {
                            playerList.appendChild(player);
                        }
                    });

                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ —Å–ª–æ—Ç
                    slotElement.appendChild(newPlayer);

                    autoSave();
                }
            });
        });
    }

    fetch(`/clubs/${clubId}/get-players/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(players => {
            if (!Array.isArray(players) || players.length === 0) {
                playerList.textContent = 'No players available';
                return;
            }
            players.forEach(player => {
                const playerElem = document.createElement('div');
                playerElem.className = 'player-item';
                playerElem.textContent = `${player.name} (${player.position})`;
                playerElem.dataset.playerId = player.id;
                playerList.appendChild(playerElem);
            });

            initializeSortable();
            loadPreviousSelection();
        })
        .catch(error => {
            playerList.textContent = 'Error loading players. Please try again later.';
        });

    resetButton.addEventListener('click', resetSelection);

    tacticSelect.addEventListener('change', autoSave);

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\static\matches\js\team_selection.js ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\create_match.html ---

{% extends 'core/base.html' %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title h4 mb-0">Create New Match</h2>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">
                                {{ field.label }}
                            </label>
                            {% if field.field.widget.input_type == 'select' %}
                                <select name="{{ field.name }}" id="{{ field.id_for_label }}" 
                                        class="form-select {% if field.errors %}is-invalid{% endif %}">
                                    {% for value, label in field.field.choices %}
                                        <option value="{{ value }}"
                                                {% if value == field.value|stringformat:"s" %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% else %}
                                {{ field.as_widget }}
                            {% endif %}
                            {% if field.errors %}
                                <div class="invalid-feedback">
                                    {{ field.errors|join:", " }}
                                </div>
                            {% endif %}
                            {% if field.help_text %}
                                <small class="form-text text-muted">{{ field.help_text }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Create Match</button>
                            <a href="{% url 'home' %}" class="btn btn-outline-secondary">Back to Home</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\create_match.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\match_detail.html ---

{% extends 'core/base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="mb-0">Match Details</h2>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <a href="{% url 'clubs:club_detail' match.home_team.id %}" class="text-decoration-none">
                                    <h3>{{ match.home_team.name }}</h3>
                                    {% if match.home_team.is_bot %}
                                        <span class="badge bg-secondary">Bot</span>
                                    {% endif %}
                                </a>
                            </div>
                            <div class="col-md-2">
                                {% if match.status == 'finished' %}
                                    <h3 class="score" id="score">{{ match.home_score }} - {{ match.away_score }}</h3>
                                {% else %}
                                    <!-- –ü–æ–∫–∞ –º–∞—Ç—á –∏–¥–µ—Ç, –º—ã –º–æ–∂–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—á–µ—Ç -->
                                    <h3 class="score" id="score">{{ match.home_score }} - {{ match.away_score }}</h3>
                                {% endif %}
                            </div>
                            <div class="col-md-5">
                                <a href="{% url 'clubs:club_detail' match.away_team.id %}" class="text-decoration-none">
                                    <h3>{{ match.away_team.name }}</h3>
                                    {% if match.away_team.is_bot %}
                                        <span class="badge bg-secondary">Bot</span>
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p><strong>Date:</strong> {{ match.date }}</p>
                            <p><strong>Status:</strong> 
                                <span class="badge {% if match.status == 'finished' %}bg-success{% elif match.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ match.get_status_display }}
                                </span>
                            </p>
                            <!-- –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –º–∏–Ω—É—Ç—É –º–∞—Ç—á–∞ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏) -->
                            <p><strong>Minute:</strong> <span id="minute">{{ match.current_minute }}</span></p>
                        </div>
                        <div class="col-md-6 text-md-end">
                            {% if match.status == 'scheduled' and user.is_staff %}
                                <form method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-primary">Simulate Match</button>
                                </form>
                            {% endif %}
                        </div>
                    </div>

                    <h4>Match Events</h4>
                    <!-- –ò–∑–Ω–∞—á–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π –∏–∑ –ë–î -->
                    <div class="list-group mb-3">
                        {% for event in match.events.all %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ event.minute }}'</strong> - 
                                        {{ event.get_event_type_display }}: {{ event.description }}
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="list-group-item text-center text-muted">
                                No events recorded
                            </div>
                        {% endfor %}
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–±—ã—Ç–∏–π, –ø–æ—Å—Ç—É–ø–∞—é—â–∏—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
                    <h5>Live Events</h5>
                    <div id="live-events" class="list-group">
                        <!-- –ù–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è, –ø–æ—Å—Ç—É–ø–∞—é—â–∏–µ —á–µ—Ä–µ–∑ WebSocket, –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                    </div>
                </div>
            </div>

            <div class="text-center">
                <a href="{% url 'home' %}" class="btn btn-outline-primary">Back to Home</a>
            </div>
        </div>
    </div>
</div>

<!-- JS –¥–ª—è WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
<script>
    var matchId = "{{ match.id }}";

    var socket = new WebSocket("ws://" + window.location.host + "/ws/match/" + matchId + "/");

    socket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
        document.getElementById('score').textContent = data.home_score + " - " + data.away_score;
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –º–∏–Ω—É—Ç—É
        document.getElementById('minute').textContent = data.minute;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è
        var liveEventsContainer = document.getElementById('live-events');
        liveEventsContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
        data.events.forEach(function(event) {
            var div = document.createElement('div');
            div.className = 'list-group-item';
            div.textContent = event.minute + "' " + event.event_type.toUpperCase() + ": " + event.description;
            liveEventsContainer.appendChild(div);
        });
    };

    socket.onopen = function() {
        console.log("WebSocket connection established for match " + matchId);
    };

    socket.onclose = function() {
        console.log("WebSocket connection closed for match " + matchId);
    };

    socket.onerror = function(error) {
        console.log("WebSocket error: ", error);
    };
</script>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\match_detail.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\team_selection.html ---

{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Selection for {{ club.name }}</title>
    <style>
        .pitch {
            width: 600px;
            height: 400px;
            background-color: #4CAF50;
            position: relative;
            margin: 20px auto;
        }
        .player-slot {
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px solid #fff;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
        }
        .player-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        .player-item {
            width: 100px;
            height: 50px;
            background-color: #f1f1f1;
            margin: 5px;
            padding: 5px;
            cursor: move;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            text-align: center;
        }
        .tactics-section {
            text-align: center;
            margin-top: 20px;
        }
        .tactics-section select {
            font-size: 14px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1 style="text-align: center;">Select Your Team Lineup for {{ club.name }}</h1>

    <div class="tactics-section">
        <label for="tacticSelect"><strong>Select Tactic:</strong></label>
        <select id="tacticSelect">
            <option value="attacking">Attacking</option>
            <option value="balanced" selected>Balanced</option>
            <option value="defensive">Defensive</option>
        </select>
    </div>
    
    <div class="pitch" id="pitch">
        <!-- Player slots will be added here dynamically -->
    </div>

    <h2 style="text-align: center;">Available Players</h2>
    <div class="player-list" id="playerList">
        <!-- Available players will be added here dynamically -->
    </div>

    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å ID –∫–ª—É–±–∞ -->
    <input type="hidden" id="clubId" value="{{ club.id }}">

    <button id="resetTeam" style="display:block;margin:20px auto;">Reset Selection</button>
    <span id="saveStatus" style="display:block;text-align:center;"></span>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <script src="{% static 'js/team_selection.js' %}"></script>
</body>
</html>

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\templates\matches\team_selection.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\admin.py ---

from django.contrib import admin
from django.contrib.admin import DateFieldListFilter
from .models import Match, MatchEvent

@admin.register(Match)
class MatchAdmin(admin.ModelAdmin):
    list_display = ('home_team', 'away_team', 'datetime', 'status', 'processed')
    list_filter = ('status', ('datetime', DateFieldListFilter), 'processed')
    search_fields = ('home_team__name', 'away_team__name')

@admin.register(MatchEvent)
class MatchEventAdmin(admin.ModelAdmin):
    list_display = ('match', 'minute', 'event_type', 'player')
    list_filter = ('event_type', 'match')
    search_fields = ('match__home_team__name', 'match__away_team__name', 'player__first_name', 'player__last_name')

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\apps.py ---

from django.apps import AppConfig


class MatchesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'matches'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\consumers.py ---

import json
from channels.generic.websocket import AsyncWebsocketConsumer
from django.db import models
from matches.models import Match, MatchEvent

class MatchConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.match_id = self.scope['url_route']['kwargs']['match_id']
        self.group_name = f"match_{self.match_id}"

        # –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –≥—Ä—É–ø–ø–µ
        await self.channel_layer.group_add(
            self.group_name,
            self.channel_name
        )

        await self.accept()

    async def disconnect(self, close_code):
        # –ü–æ–∫–∏–¥–∞–µ–º –≥—Ä—É–ø–ø—É
        await self.channel_layer.group_discard(
            self.group_name,
            self.channel_name
        )

    async def receive(self, text_data):
        # –û–±—ã—á–Ω–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ—Å—ã–ª–∞–µ—Ç –Ω–∏—á–µ–≥–æ, –ª–∏–±–æ –º—ã –º–æ–∂–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        pass

    # –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ WebSocket
    async def match_update(self, event):
        # event —Å–æ–¥–µ—Ä–∂–∏—Ç 'type': 'match_update' –∏ 'data': —Å–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        await self.send(json.dumps(event['data']))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\consumers.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\match_preparation.py ---

from typing import Dict, List, Tuple
from .models import Match
from clubs.models import Club
from players.models import Player

class PreMatchPreparation:
    """–ö–ª–∞—Å—Å –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –º–∞—Ç—á–∞ –ø–µ—Ä–µ–¥ –µ–≥–æ –Ω–∞—á–∞–ª–æ–º"""
    
    # –í–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∏–ª—ã –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º
    DEFENDER_WEIGHTS = {
        'marking': 0.3,
        'tackling': 0.3,
        'strength': 0.2,
        'positioning': 0.2
    }
    
    MIDFIELDER_WEIGHTS = {
        'passing': 0.3,
        'vision': 0.3,
        'stamina': 0.2,
        'work_rate': 0.2
    }
    
    FORWARD_WEIGHTS = {
        'finishing': 0.3,
        'dribbling': 0.3,
        'long_range': 0.2,
        'accuracy': 0.2
    }
    
    GOALKEEPER_WEIGHTS = {
        'reflexes': 0.25,
        'handling': 0.25,
        'positioning': 0.2,
        'aerial': 0.1,
        'command': 0.1,
        'shot_reading': 0.1
    }

    def __init__(self, match: Match):
        self.match = match
        self.home_team = match.home_team
        self.away_team = match.away_team
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–æ—Å—Ç–∞–≤—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        self.home_lineup = self.match.home_lineup if self.match.home_lineup else self.auto_select_lineup(self.home_team)
        self.away_lineup = self.match.away_lineup if self.match.away_lineup else self.auto_select_lineup(self.away_team)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ—Å—Ç–∞–≤—ã –≤ –º–∞—Ç—á
        if not self.match.home_lineup:
            self.match.home_lineup = self.home_lineup
        if not self.match.away_lineup:
            self.match.away_lineup = self.away_lineup
        self.match.save()
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫ –∏ —Ä–∞—Å—á–µ—Ç–æ–≤ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∑–¥–µ—Å—å
        self.validation_results = {
            'home_valid': False,
            'away_valid': False,
            'errors': []
        }
        
        # –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥
        self.team_strengths = {
            'home': 0,
            'away': 0
        }
        
        # –ù–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç—á–∞
        self.match_parameters = {
            'home': {
                'players_condition': {},  # –§–∏–∑–∏—á–µ—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (100%)
                'team_attack': 0,        # –ê—Ç–∞–∫—É—é—â–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–æ–º–∞–Ω–¥—ã
                'team_defense': 0,       # –û–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–æ–º–∞–Ω–¥—ã
                'team_midfield': 0,      # –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏
                'goalkeeper_strength': 0  # –°–∏–ª–∞ –≤—Ä–∞—Ç–∞—Ä—è
            },
            'away': {
                'players_condition': {},  # –§–∏–∑–∏—á–µ—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (100%)
                'team_attack': 0,        # –ê—Ç–∞–∫—É—é—â–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–æ–º–∞–Ω–¥—ã
                'team_defense': 0,       # –û–±–æ—Ä–æ–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –∫–æ–º–∞–Ω–¥—ã
                'team_midfield': 0,      # –ö–æ–Ω—Ç—Ä–æ–ª—å —Å—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏
                'goalkeeper_strength': 0  # –°–∏–ª–∞ –≤—Ä–∞—Ç–∞—Ä—è
            }
        }

    def auto_select_lineup(self, team: Club) -> dict:
        """
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–∞–≤ –∫–æ–º–∞–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ 4-4-2
        
        Args:
            team: Club - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–π —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–æ—Å—Ç–∞–≤
            
        Returns:
            dict: —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏–≥—Ä–æ–∫–æ–≤
        """
        players = team.player_set.all()
        lineup = {}
        
        # –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ–º –≤—Ä–∞—Ç–∞—Ä—è
        goalkeeper = players.filter(position='Goalkeeper').first()
        if goalkeeper:
            lineup['0'] = goalkeeper.id
        
        # –í—ã–±–∏—Ä–∞–µ–º –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤ (4 –ø–æ–∑–∏—Ü–∏–∏)
        defenders = players.filter(
            position__in=['Right Back', 'Left Back', 'Center Back']
        )[:4]
        for i, player in enumerate(defenders, 1):
            lineup[str(i)] = player.id
        
        # –í—ã–±–∏—Ä–∞–µ–º –ø–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤ (4 –ø–æ–∑–∏—Ü–∏–∏)
        midfielders = players.filter(
            position__icontains='Midfielder'
        )[:4]
        for i, player in enumerate(midfielders, 5):
            lineup[str(i)] = player.id
        
        # –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–ø–∞–¥–∞—é—â–∏—Ö (2 –ø–æ–∑–∏—Ü–∏–∏)
        forwards = players.filter(
            position='Center Forward'
        )[:2]
        for i, player in enumerate(forwards, 9):
            lineup[str(i)] = player.id
            
        return lineup

    def validate_lineup(self, lineup: Dict, team: Club) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–∞–≤–∞ –∫–æ–º–∞–Ω–¥—ã
        
        Args:
            lineup: Dict - —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏–≥—Ä–æ–∫–æ–≤
            team: Club - –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        Returns:
            bool: True –µ—Å–ª–∏ —Å–æ—Å—Ç–∞–≤ –≤–∞–ª–∏–¥–µ–Ω, False –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        """
        errors = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
        if len(lineup) != 11:
            errors.append(f"–ö–æ–º–∞–Ω–¥–∞ {team.name} –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å —Ä–æ–≤–Ω–æ 11 –∏–≥—Ä–æ–∫–æ–≤ –≤ —Å–æ—Å—Ç–∞–≤–µ")
            return False
            
        position_counts = {
            'Goalkeeper': 0,
            'Defender': 0,
            'Midfielder': 0,
            'Forward': 0
        }
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –≤ —Å–æ—Å—Ç–∞–≤–µ
        for pos, player_id in lineup.items():
            try:
                player = Player.objects.get(id=player_id)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞
                if player.position == 'Goalkeeper':
                    position_counts['Goalkeeper'] += 1
                elif 'Back' in player.position or player.position == 'Center Back':
                    position_counts['Defender'] += 1
                elif 'Midfielder' in player.position:
                    position_counts['Midfielder'] += 1
                elif 'Forward' in player.position:
                    position_counts['Forward'] += 1
                    
            except Player.DoesNotExist:
                errors.append(f"–ò–≥—Ä–æ–∫ —Å ID {player_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        if position_counts['Goalkeeper'] != 1:
            errors.append(f"–í —Å–æ—Å—Ç–∞–≤–µ –∫–æ–º–∞–Ω–¥—ã {team.name} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–æ–≤–Ω–æ 1 –≤—Ä–∞—Ç–∞—Ä—å")
            return False
            
        if not (3 <= position_counts['Defender'] <= 5):
            errors.append(f"–í —Å–æ—Å—Ç–∞–≤–µ –∫–æ–º–∞–Ω–¥—ã {team.name} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 3 –¥–æ 5 –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤")
            return False
            
        if not (2 <= position_counts['Midfielder'] <= 5):
            errors.append(f"–í —Å–æ—Å—Ç–∞–≤–µ –∫–æ–º–∞–Ω–¥—ã {team.name} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 5 –ø–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤")
            return False
            
        if not (1 <= position_counts['Forward'] <= 4):
            errors.append(f"–í —Å–æ—Å—Ç–∞–≤–µ –∫–æ–º–∞–Ω–¥—ã {team.name} –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 4 –Ω–∞–ø–∞–¥–∞—é—â–∏—Ö")
            return False
            
        # –î–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
        if errors:
            self.validation_results['errors'].extend(errors)
            return False
            
        return True

    def calculate_player_strength(self, player: Player) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∏–ª—É –∏–≥—Ä–æ–∫–∞ –Ω–∞ –µ–≥–æ –ø–æ–∑–∏—Ü–∏–∏
        
        Args:
            player: Player - –∏–≥—Ä–æ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
            
        Returns:
            float: –∑–Ω–∞—á–µ–Ω–∏–µ —Å–∏–ª—ã –∏–≥—Ä–æ–∫–∞ (0-100)
        """
        if player.position == 'Goalkeeper':
            weights = self.GOALKEEPER_WEIGHTS
            attributes = {
                'reflexes': player.reflexes,
                'handling': player.handling,
                'positioning': player.positioning,
                'aerial': player.aerial,
                'command': player.command,
                'shot_reading': player.shot_reading
            }
        elif 'Back' in player.position or player.position == 'Center Back':
            weights = self.DEFENDER_WEIGHTS
            attributes = {
                'marking': player.marking,
                'tackling': player.tackling,
                'strength': player.strength,
                'positioning': player.positioning
            }
        elif 'Midfielder' in player.position:
            weights = self.MIDFIELDER_WEIGHTS
            attributes = {
                'passing': player.passing,
                'vision': player.vision,
                'stamina': player.stamina,
                'work_rate': player.work_rate
            }
        else:  # Forwards
            weights = self.FORWARD_WEIGHTS
            attributes = {
                'finishing': player.finishing,
                'dribbling': player.dribbling,
                'long_range': player.long_range,
                'accuracy': player.accuracy
            }
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Å—É–º–º—É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        strength = sum(weights[attr] * value for attr, value in attributes.items())
        return round(strength, 2)

    def calculate_team_strength(self, lineup: Dict, team: Club, is_home: bool = False) -> float:
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å–∏–ª—É –∫–æ–º–∞–Ω–¥—ã
        
        Args:
            lineup: Dict - —Å–ª–æ–≤–∞—Ä—å —Å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∏–≥—Ä–æ–∫–æ–≤
            team: Club - –∫–æ–º–∞–Ω–¥–∞
            is_home: bool - –∏–≥—Ä–∞–µ—Ç –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –¥–æ–º–∞
            
        Returns:
            float: –æ–±—â–∞—è —Å–∏–ª–∞ –∫–æ–º–∞–Ω–¥—ã (0-100)
        """
        total_strength = 0
        position_counts = {
            'Goalkeeper': 0,
            'Defender': 0,
            'Midfielder': 0,
            'Forward': 0
        }

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∏–ª—É –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∏ —Å—É–º–º–∏—Ä—É–µ–º
        for player_id in lineup.values():
            try:
                player = Player.objects.get(id=player_id)
                player_strength = self.calculate_player_strength(player)
                total_strength += player_strength

                # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
                if player.position == 'Goalkeeper':
                    position_counts['Goalkeeper'] += 1
                elif 'Back' in player.position or player.position == 'Center Back':
                    position_counts['Defender'] += 1
                elif 'Midfielder' in player.position:
                    position_counts['Midfielder'] += 1
                else:
                    position_counts['Forward'] += 1

            except Player.DoesNotExist:
                continue

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å —Å–æ—Å—Ç–∞–≤–∞
        if position_counts['Goalkeeper'] != 1:
            return 0  # –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ä–∞—Ç–∞—Ä–µ–π
        if position_counts['Defender'] < 3 or position_counts['Defender'] > 5:
            return 0  # –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–ª–∏ –º–Ω–æ–≥–æ –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤
        if position_counts['Midfielder'] < 2 or position_counts['Midfielder'] > 5:
            return 0  # –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–ª–∏ –º–Ω–æ–≥–æ –ø–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤
        if position_counts['Forward'] < 1 or position_counts['Forward'] > 4:
            return 0  # –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –∏–ª–∏ –º–Ω–æ–≥–æ –Ω–∞–ø–∞–¥–∞—é—â–∏—Ö

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω—é—é —Å–∏–ª—É –∫–æ–º–∞–Ω–¥—ã
        team_strength = total_strength / 11
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å –∑–∞ –¥–æ–º–∞—à–Ω–µ–µ –ø–æ–ª–µ (+10%)
        if is_home:
            team_strength *= 1.1
            
        return round(team_strength, 2)

    def _calculate_initial_parameters(self, team_type: str):
        """
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
        
        Args:
            team_type: str - 'home' –∏–ª–∏ 'away'
        """
        lineup = self.home_lineup if team_type == 'home' else self.away_lineup
        parameters = self.match_parameters[team_type]
        
        attack_sum = 0
        defense_sum = 0
        midfield_sum = 0
        attacker_count = 0
        defender_count = 0
        midfielder_count = 0
        
        # –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –≤ —Å–æ—Å—Ç–∞–≤–µ
        for position, player_id in lineup.items():
            player = Player.objects.get(id=player_id)
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
            parameters['players_condition'][player_id] = 100
            
            if player.position == 'Goalkeeper':
                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∏–ª—É –≤—Ä–∞—Ç–∞—Ä—è
                parameters['goalkeeper_strength'] = self.calculate_player_strength(player)
                
            elif 'Back' in player.position or player.position == 'Center Back':
                # –ó–∞—â–∏—Ç–Ω–∏–∫–∏
                defense_sum += (
                    player.marking * 0.3 +
                    player.tackling * 0.3 +
                    player.strength * 0.2 +
                    player.positioning * 0.2
                )
                defender_count += 1
                
            elif 'Midfielder' in player.position:
                # –ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–∏
                midfield_sum += (
                    player.passing * 0.3 +
                    player.vision * 0.3 +
                    player.work_rate * 0.2 +
                    player.stamina * 0.2
                )
                midfielder_count += 1
                
                # –ê—Ç–∞–∫—É—é—â–∏–µ –ø–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫–∏ –≤–Ω–æ—Å—è—Ç –≤–∫–ª–∞–¥ –≤ –∞—Ç–∞–∫—É
                if 'Attacking' in player.position:
                    attack_sum += (
                        player.finishing * 0.2 +
                        player.long_range * 0.2 +
                        player.accuracy * 0.1
                    )
                    attacker_count += 0.5  # –°—á–∏—Ç–∞–µ–º –∫–∞–∫ –ø–æ–ª-–Ω–∞–ø–∞–¥–∞—é—â–µ–≥–æ
                    
            else:
                # –ù–∞–ø–∞–¥–∞—é—â–∏–µ
                attack_sum += (
                    player.finishing * 0.3 +
                    player.dribbling * 0.3 +
                    player.long_range * 0.2 +
                    player.accuracy * 0.2
                )
                attacker_count += 1
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        parameters['team_attack'] = round(attack_sum / max(attacker_count, 1), 2)
        parameters['team_defense'] = round(defense_sum / defender_count, 2)
        parameters['team_midfield'] = round(midfield_sum / midfielder_count, 2)
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–º–∞—à–Ω–∏–π –±–æ–Ω—É—Å
        if team_type == 'home':
            parameters['team_attack'] *= 1.1
            parameters['team_defense'] *= 1.1
            parameters['team_midfield'] *= 1.1

    def prepare_match(self) -> bool:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –º–∞—Ç—á–∞
        
        Returns:
            bool: True –µ—Å–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞, False –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–∞–≤—ã
        self.validation_results['home_valid'] = self.validate_lineup(self.home_lineup, self.home_team)
        self.validation_results['away_valid'] = self.validate_lineup(self.away_lineup, self.away_team)
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–æ—Å—Ç–∞–≤–∞—Ö, –¥–∞–ª—å–Ω–µ–π—à–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞
        if not (self.validation_results['home_valid'] and self.validation_results['away_valid']):
            return False
            
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∏–ª—É –∫–æ–º–∞–Ω–¥
        self.team_strengths['home'] = self.calculate_team_strength(
            self.home_lineup, 
            self.home_team, 
            is_home=True
        )
        self.team_strengths['away'] = self.calculate_team_strength(
            self.away_lineup, 
            self.away_team, 
            is_home=False
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–∏–ª
        if self.team_strengths['home'] == 0 or self.team_strengths['away'] == 0:
            self.validation_results['errors'].append("–û—à–∏–±–∫–∞ –≤ —Ä–∞—Å—á–µ—Ç–µ —Å–∏–ª –∫–æ–º–∞–Ω–¥ - –Ω–µ–≤–µ—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å —Å–æ—Å—Ç–∞–≤–∞")
            return False
        
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∞—Ç—á–∞
        self._calculate_initial_parameters('home')
        self._calculate_initial_parameters('away')
        
        return True

    def get_validation_errors(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏"""
        return self.validation_results['errors']

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\match_preparation.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\match_simulation.py ---

from django.utils import timezone
from .models import Match, MatchEvent
from .player_agent import PlayerAgent
import random
import logging

logger = logging.getLogger(__name__)

from channels.layers import get_channel_layer
from asgiref.sync import async_to_sync

class MatchSimulation:
    def __init__(self, match):
        self.match = match
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–∞—Ç—á–∞
        self.match_stats = {
            'home': {
                'possession': 50, 
                'shots': 0, 
                'goals': 0,
                'passes': 0,
                'tackles': 0,
                'team_attack': self._calculate_team_parameter(match.home_team, 'attack'),
                'team_defense': self._calculate_team_parameter(match.home_team, 'defense'),
                'team_midfield': self._calculate_team_parameter(match.home_team, 'midfield'),
                'tactics': 'attacking'
            },
            'away': {
                'possession': 50, 
                'shots': 0, 
                'goals': 0,
                'passes': 0,
                'tackles': 0,
                'team_attack': self._calculate_team_parameter(match.away_team, 'attack'),
                'team_defense': self._calculate_team_parameter(match.away_team, 'defense'),
                'team_midfield': self._calculate_team_parameter(match.away_team, 'midfield'),
                'tactics': 'defensive'
            }
        }

        self.player_agents = {'home': {}, 'away': {}}
        for team_type in ['home', 'away']:
            team = self.match.home_team if team_type == 'home' else self.match.away_team
            players = team.player_set.all()
            for player in players:
                agent = PlayerAgent(player)
                self.player_agents[team_type][player.id] = agent

        self.ball_owner = None
        self.current_zone = None

        self._setup_moments()

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—á–µ—Ç –≤ 0, —Ç–∞–∫ –∫–∞–∫ –º–∞—Ç—á –∏–¥–µ—Ç –ø–æ—à–∞–≥–æ–≤–æ
        self.match.home_score = self.match.home_score or 0
        self.match.away_score = self.match.away_score or 0
        self.match.save()

    def _calculate_team_parameter(self, team, parameter_type):
        players = team.player_set.all()
        total = 0
        count = 0
        
        for player in players:
            experience_multiplier = 1 + player.experience * 0.01

            if parameter_type == 'attack':
                if player.position in ['Center Forward', 'Attacking Midfielder']:
                    base_value = player.finishing + player.heading + player.long_range
                    weight = 1.5
                else:
                    base_value = player.finishing + player.long_range
                    weight = 1.0
            elif parameter_type == 'defense':
                if player.position in ['Center Back', 'Right Back', 'Left Back', 'Defensive Midfielder']:
                    base_value = player.marking + player.tackling + player.heading
                    weight = 1.5
                else:
                    base_value = player.marking + player.tackling
                    weight = 1.0
            else:  # midfield
                if player.position in ['Central Midfielder', 'Defensive Midfielder', 'Attacking Midfielder']:
                    base_value = player.passing + player.vision + player.work_rate
                    weight = 1.5
                else:
                    base_value = player.passing + player.work_rate
                    weight = 1.0

            final_value = base_value * experience_multiplier
            total += final_value * weight
            count += weight
            
        return round(total / count) if count > 0 else 50

    def create_match_event(self, minute, event_type, agent, description):
        player_model = agent.player_model if agent else None
        MatchEvent.objects.create(
            match=self.match,
            minute=minute,
            event_type=event_type,
            player=player_model,
            description=description
        )

    def get_random_agent(self, team_type, positions=None):
        agents = list(self.player_agents[team_type].values())
        if positions:
            agents = [agent for agent in agents if any(pos in agent.position for pos in positions)]
        return random.choice(agents) if agents else None

    def set_ball_owner(self, team_type, player_id):
        self.ball_owner = (team_type, player_id)

    def clear_ball_owner(self):
        self.ball_owner = None
        self.current_zone = None

    def assign_ball_to_defender(self, team_type):
        positions_priority = ['Defensive Midfielder', 'Center Back', 'Right Back', 'Left Back', 'Central Midfielder']
        candidates = []
        for pid, agent in self.player_agents[team_type].items():
            if any(pos in agent.position for pos in positions_priority):
                candidates.append(pid)
        if candidates:
            chosen = random.choice(candidates)
            self.set_ball_owner(team_type, chosen)
            self.current_zone = 'defense'
        else:
            all_pids = list(self.player_agents[team_type].keys())
            chosen = random.choice(all_pids)
            self.set_ball_owner(team_type, chosen)
            self.current_zone = 'defense'

    def advance_zone(self, team_type):
        if self.current_zone == 'defense':
            self.current_zone = 'midfield'
        elif self.current_zone == 'midfield':
            self.current_zone = 'attack'

    def _apply_tactics_to_pass(self, team_type, pass_success, intercept_chance):
        tactics = self.match_stats[team_type]['tactics']

        if tactics == 'attacking':
            pass_success = min(1.0, pass_success + 0.1)
            intercept_chance = min(1.0, intercept_chance + 0.1)
        elif tactics == 'defensive':
            pass_success = max(0.0, pass_success - 0.1)
            intercept_chance = min(1.0, intercept_chance + 0.05)
        return pass_success, intercept_chance

    def _apply_tactics_to_shot(self, team_type, shot_chance):
        tactics = self.match_stats[team_type]['tactics']

        if tactics == 'attacking':
            shot_chance = min(1.0, shot_chance + 0.1)
        elif tactics == 'defensive':
            shot_chance = max(0.0, shot_chance - 0.05)
        return shot_chance

    def attempt_pass(self, minute, team_type):
        if not self.ball_owner:
            return False
        owner_team, owner_pid = self.ball_owner
        if owner_team != team_type:
            return False

        passer_agent = self.player_agents[team_type][owner_pid]
        pass_success = min(1.0, (self.match_stats[team_type]['team_midfield']/100)*1.5)

        defending_team = 'away' if team_type == 'home' else 'home'
        defense_factor = self.match_stats[defending_team]['team_defense']
        attack_factor = self.match_stats[team_type]['team_attack']
        intercept_chance = 0.3 if defense_factor > attack_factor else 0.15

        pass_success, intercept_chance = self._apply_tactics_to_pass(team_type, pass_success, intercept_chance)

        if random.random() < intercept_chance:
            self.match_stats[defending_team]['tackles'] += 1
            self.clear_ball_owner()
            self.create_match_event(minute, 'info', None, "Pass intercepted by defenders!")
            return False

        if random.random() < pass_success:
            self.match_stats[team_type]['passes'] += 1
            self.create_match_event(minute, 'info', passer_agent, f"{passer_agent.full_name} passes forward")
            self.advance_zone(team_type)
            new_owner = self.get_random_agent(team_type)
            if new_owner:
                self.set_ball_owner(team_type, new_owner.player_model.id)
            return True
        else:
            self.clear_ball_owner()
            self.create_match_event(minute, 'info', passer_agent, f"{passer_agent.full_name}'s pass goes wide")
            return False

    def attempt_shot(self, minute, team_type):
        if not self.ball_owner:
            return False
        owner_team, owner_pid = self.ball_owner
        if owner_team != team_type:
            return False
            
        shooter = self.player_agents[team_type][owner_pid]
        shot_chance = min(1.0, (self.match_stats[team_type]['team_attack']/100)*1.2)

        shot_chance = self._apply_tactics_to_shot(team_type, shot_chance)

        defending_team = 'away' if team_type == 'home' else 'home'

        if self.match_stats[defending_team]['tactics'] == 'defensive':
            block_chance = 0.6
        else:
            block_chance = 0.5

        if random.random() < block_chance:
            self.match_stats[defending_team]['tackles'] += 1
            self.clear_ball_owner()
            self.create_match_event(minute, 'info', None, "Shot blocked by a defender!")
            return False

        if random.random() < shot_chance:
            self.match_stats[team_type]['goals'] += 1
            self.match_stats[team_type]['shots'] += 1
            if team_type == 'home':
                self.match.home_score += 1
            else:
                self.match.away_score += 1
            self.match.save()

            self.create_match_event(minute, 'goal', shooter, f"GOAL! {shooter.full_name} scores!")
            self.clear_ball_owner()
            return True
        else:
            self.match_stats[team_type]['shots'] += 1
            self.create_match_event(minute, 'info', shooter, f"{shooter.full_name}'s shot goes wide")
            self.clear_ball_owner()
            return False

    def _determine_attacking_team(self):
        home_mid = self.match_stats['home']['team_midfield']
        away_mid = self.match_stats['away']['team_midfield']
        if (home_mid + away_mid) == 0:
            return 'home' if random.random() < 0.5 else 'away'
        home_chance = home_mid / (home_mid + away_mid)
        return 'home' if random.random() < home_chance else 'away'

    def _setup_moments(self):
        base_min, base_max = 10, 20
        home_strength = (self.match_stats['home']['team_attack'] + self.match_stats['home']['team_midfield']) / 2
        away_strength = (self.match_stats['away']['team_attack'] + self.match_stats['away']['team_midfield']) / 2
        
        home_factor = min(home_strength / 100, 1.0)
        away_factor = min(away_strength / 100, 1.0)
        
        home_chances = int(base_min + (base_max - base_min)*home_factor)
        away_chances = int(base_min + (base_max - base_min)*away_factor)

        all_minutes = list(range(1, 90))
        random.shuffle(all_minutes)

        self.home_moments_minutes = sorted(all_minutes[:home_chances])
        self.away_moments_minutes = sorted(all_minutes[home_chances:home_chances+away_chances])

    def simulate_minute(self, minute):
        # –°–∏–º—É–ª—è—Ü–∏—è –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã –º–∞—Ç—á–∞
        if minute in self.home_moments_minutes:
            attacking_team = 'home'
        elif minute in self.away_moments_minutes:
            attacking_team = 'away'
        else:
            return

        self.create_match_event(minute, 'info', None, "==============================")
        self.create_match_event(minute, 'info', None, f"MOMENT at minute {minute}: {attacking_team.upper()} tries to attack!")
        self.create_match_event(minute, 'info', None, "==============================")

        self.assign_ball_to_defender(attacking_team)

        if self.ball_owner:
            owner_team, owner_pid = self.ball_owner
            owner_agent = self.player_agents[owner_team][owner_pid]
            self.create_match_event(minute, 'info', None, f"Ball currently owned by {owner_team.upper()} player {owner_agent.full_name} in {self.current_zone} zone.")

        if not self.attempt_pass(minute, attacking_team):
            return

        for _ in range(3):
            if not self.ball_owner or self.ball_owner[0] != attacking_team:
                break
            if self.current_zone == 'attack':
                self.attempt_shot(minute, attacking_team)
                break
            else:
                if not self.attempt_pass(minute, attacking_team):
                    break

def simulate_one_minute(match_id: int):
    """
    –°–∏–º—É–ª–∏—Ä—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä–æ–≤—É—é –º–∏–Ω—É—Ç—É –¥–ª—è –º–∞—Ç—á–∞.
    –ï—Å–ª–∏ current_minute < 90, increment –∏ simulate_minute.
    –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–∞–µ–º 90, –∑–∞–≤–µ—Ä—à–∞–µ–º –º–∞—Ç—á.
    –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ WebSocket.
    """
    match = Match.objects.get(id=match_id)
    if match.status == 'in_progress':
        if match.current_minute < 90:
            sim = MatchSimulation(match)
            sim.simulate_minute(match.current_minute + 1)
            match.current_minute += 1
            if match.current_minute >= 90:
                match.status = 'finished'
            match.save()

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ WebSocket
            layer = get_channel_layer()
            data = {
                "minute": match.current_minute,
                "home_score": match.home_score,
                "away_score": match.away_score,
                "events": list(match.events.filter(minute=match.current_minute).values('minute', 'event_type', 'description'))
            }
            async_to_sync(layer.group_send)(
                f"match_{match_id}",
                {
                    "type": "match_update",
                    "data": data
                }
            )
        else:
            # —É–∂–µ 90 –º–∏–Ω—É—Ç –ø—Ä–æ—à–ª–æ, —Å—Ç–∞–≤–∏–º finished –µ—Å–ª–∏ –Ω–µ—Ç
            if match.status != 'finished':
                match.status = 'finished'
                match.save()
    else:
        logger.info(f"Match {match_id} is not in progress, skipping simulate_one_minute.")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\match_simulation.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\models.py ---

from django.db import models
from django.conf import settings
from clubs.models import Club
from django.utils import timezone

class Match(models.Model):
    home_team = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='home_matches')
    away_team = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='away_matches')
    datetime = models.DateTimeField(
        verbose_name="Match Date and Time",
        db_index=True,
        null=True,
        blank=True
    )
    processed = models.BooleanField(
        default=False,
        db_index=True,
        help_text="Indicates if match has been processed"
    )
    home_score = models.PositiveIntegerField(default=0)
    away_score = models.PositiveIntegerField(default=0)
    status = models.CharField(
        max_length=20,
        choices=[
            ('scheduled', 'Scheduled'),
            ('in_progress', 'In Progress'),
            ('finished', 'Finished'),
            ('cancelled', 'Cancelled')
        ],
        default='scheduled',
        db_index=True
    )
    home_lineup = models.JSONField(null=True, blank=True)
    away_lineup = models.JSONField(null=True, blank=True)

    # –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –º–∏–Ω—É—Ç—ã –º–∞—Ç—á–∞
    current_minute = models.PositiveIntegerField(default=0)

    def __str__(self):
        return f"{self.home_team} vs {self.away_team} - {self.datetime}"

class MatchEvent(models.Model):
    match = models.ForeignKey(Match, on_delete=models.CASCADE, related_name='events')
    minute = models.PositiveIntegerField()
    event_type = models.CharField(max_length=20, choices=[
        ('goal', 'Goal'),
        ('miss', 'Miss'),
        ('possession', 'Possession Change'),
        ('defense_to_midfield', 'Defense to Midfield Transition'),
        ('midfield_to_attack', 'Midfield to Attack Transition'),
        ('attack_to_shot', 'Attack to Shot Opportunity'),
        ('interception', 'Interception'),
        ('yellow_card', 'Yellow Card'),
        ('red_card', 'Red Card'),
        ('substitution', 'Substitution')
    ])
    player = models.ForeignKey('players.Player', on_delete=models.CASCADE, null=True, blank=True)
    description = models.TextField()

    def __str__(self):
        return f"{self.match} - {self.event_type} at {self.minute}'"

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\pitch.py ---

import random
from typing import Dict, List, Tuple, Optional
from players.models import Player

class Pitch:
    """
    –ö–ª–∞—Å—Å, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π —Ñ—É—Ç–±–æ–ª—å–Ω–æ–µ –ø–æ–ª–µ –∫–∞–∫ —Å–µ—Ç–∫—É.
    
    WIDTH = 100: —à–∏—Ä–∏–Ω–∞ –ø–æ–ª—è –≤ –∫–ª–µ—Ç–∫–∞—Ö
    HEIGHT = 60: –≤—ã—Å–æ—Ç–∞ –ø–æ–ª—è –≤ –∫–ª–µ—Ç–∫–∞—Ö
    """
    WIDTH = 100
    HEIGHT = 60
    
    def __init__(self):
        # –ü–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ {(team_type, player_id): (x, y)}
        self.positions: Dict[Tuple[str, int], Tuple[int, int]] = {}
        # –ü–æ–∑–∏—Ü–∏—è –º—è—á–∞ (x, y)
        self.ball_position: Tuple[int, int] = (self.WIDTH // 2, self.HEIGHT // 2)
        # ID –∏–≥—Ä–æ–∫–∞, –≤–ª–∞–¥–µ—é—â–µ–≥–æ –º—è—á–æ–º
        self.ball_owner: Optional[Tuple[str, int]] = None
        
    def set_initial_positions(self, home_players: List[Player], away_players: List[Player]):
        """
        –†–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –Ω–∞—á–∞–ª—å–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Ö —Ä–æ–ª–µ–π.
        """
        # –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏
        self.positions.clear()
        
        # –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –¥–æ–º–∞—à–Ω—é—é –∫–æ–º–∞–Ω–¥—É (–∞—Ç–∞–∫—É–µ—Ç —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ)
        self._set_team_positions(home_players, 'home')
        # –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º –≥–æ—Å—Ç–µ–≤—É—é –∫–æ–º–∞–Ω–¥—É (–∞—Ç–∞–∫—É–µ—Ç —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ)
        self._set_team_positions(away_players, 'away')
        
    def _set_team_positions(self, players: List[Player], team_type: str):
        """
        –†–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É –ø–æ –ø–æ–∑–∏—Ü–∏—è–º.
        """
        for player in players:
            x, y = self._get_initial_position(player.position, team_type)
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            x += random.randint(-5, 5)
            y += random.randint(-3, 3)
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—è
            x = max(0, min(self.WIDTH - 1, x))
            y = max(0, min(self.HEIGHT - 1, y))
            self.positions[(team_type, player.id)] = (x, y)
    
    def _get_initial_position(self, position: str, team_type: str) -> Tuple[int, int]:
        """
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∏–≥—Ä–æ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ —Ä–æ–ª–∏.
        """
        # –ë–∞–∑–æ–≤–∞—è x-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–º–∞–Ω–¥—ã
        if team_type == 'home':
            base_x = self.WIDTH * 3 // 4  # –ø—Ä–∞–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞
        else:
            base_x = self.WIDTH // 4  # –ª–µ–≤–∞—è –ø–æ–ª–æ–≤–∏–Ω–∞
            
        # Y-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –∏ —Å–º–µ—â–µ–Ω–∏–µ –ø–æ X –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
        if 'Goalkeeper' in position:
            return (5 if team_type == 'away' else self.WIDTH - 5, self.HEIGHT // 2)
        elif 'Center Back' in position:
            return (base_x + (-10 if team_type == 'home' else 10), self.HEIGHT // 2)
        elif 'Right Back' in position:
            return (base_x + (-10 if team_type == 'home' else 10), self.HEIGHT * 3 // 4)
        elif 'Left Back' in position:
            return (base_x + (-10 if team_type == 'home' else 10), self.HEIGHT // 4)
        elif 'Defensive Midfielder' in position:
            return (base_x + (-5 if team_type == 'home' else 5), self.HEIGHT // 2)
        elif 'Central Midfielder' in position:
            return (base_x, self.HEIGHT // 2)
        elif 'Right Midfielder' in position:
            return (base_x, self.HEIGHT * 3 // 4)
        elif 'Left Midfielder' in position:
            return (base_x, self.HEIGHT // 4)
        elif 'Attacking Midfielder' in position:
            return (base_x + (5 if team_type == 'home' else -5), self.HEIGHT // 2)
        elif 'Center Forward' in position:
            return (base_x + (10 if team_type == 'home' else -10), self.HEIGHT // 2)
        else:
            return (base_x, self.HEIGHT // 2)

    def move_player(self, team_type: str, player_id: int, dx: int, dy: int) -> bool:
        """
        –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –Ω–∞ dx, dy –∫–ª–µ—Ç–æ–∫.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ.
        """
        if (team_type, player_id) not in self.positions:
            return False
            
        x, y = self.positions[(team_type, player_id)]
        new_x = max(0, min(self.WIDTH - 1, x + dx))
        new_y = max(0, min(self.HEIGHT - 1, y + dy))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç–∞ –ª–∏ –Ω–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è
        for pos in self.positions.values():
            if pos == (new_x, new_y):
                return False
                
        self.positions[(team_type, player_id)] = (new_x, new_y)
        
        # –ï—Å–ª–∏ —É –∏–≥—Ä–æ–∫–∞ –±—ã–ª –º—è—á, –º—è—á –¥–≤–∏–∂–µ—Ç—Å—è —Å –Ω–∏–º
        if self.ball_owner == (team_type, player_id):
            self.ball_position = (new_x, new_y)
            
        return True
        
    def move_towards(self, team_type: str, player_id: int, target_x: int, target_y: int, 
                    speed: int = 1) -> bool:
        """
        –ü–µ—Ä–µ–º–µ—â–∞–µ—Ç –∏–≥—Ä–æ–∫–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Ü–µ–ª–µ–≤–æ–π —Ç–æ—á–∫–∏.
        """
        if (team_type, player_id) not in self.positions:
            return False
            
        x, y = self.positions[(team_type, player_id)]
        dx = 0
        dy = 0
        
        if x < target_x:
            dx = min(speed, target_x - x)
        elif x > target_x:
            dx = max(-speed, target_x - x)
            
        if y < target_y:
            dy = min(speed, target_y - y)
        elif y > target_y:
            dy = max(-speed, target_y - y)
            
        return self.move_player(team_type, player_id, dx, dy)
        
    def get_distance(self, pos1: Tuple[int, int], pos2: Tuple[int, int]) -> float:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ø–æ–ª–µ.
        """
        x1, y1 = pos1
        x2, y2 = pos2
        return ((x2 - x1) ** 2 + (y2 - y1) ** 2) ** 0.5
        
    def get_nearest_players(self, x: int, y: int, team_type: str = None, 
                          max_distance: float = None) -> List[Tuple[Tuple[str, int], float]]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∫ –∑–∞–¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ.
        –ú–æ–∂–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–æ–º–∞–Ω–¥–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π ((team_type, player_id), distance).
        """
        players = []
        for (t, pid), pos in self.positions.items():
            if team_type and t != team_type:
                continue
                
            dist = self.get_distance((x, y), pos)
            if max_distance is None or dist <= max_distance:
                players.append(((t, pid), dist))
                
        return sorted(players, key=lambda x: x[1])
        
    def is_position_free(self, x: int, y: int, radius: int = 1) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–Ω–∞ –ª–∏ –ø–æ–∑–∏—Ü–∏—è (—Å —É—á–µ—Ç–æ–º —Ä–∞–¥–∏—É—Å–∞).
        """
        for pos in self.positions.values():
            if self.get_distance((x, y), pos) <= radius:
                return False
        return True
        
    def get_team_average_position(self, team_type: str) -> Tuple[float, float]:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω—é—é –ø–æ–∑–∏—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –ø–æ–ª–µ.
        """
        positions = [(x, y) for (t, _), (x, y) in self.positions.items() if t == team_type]
        if not positions:
            return (0, 0)
            
        avg_x = sum(x for x, _ in positions) / len(positions)
        avg_y = sum(y for _, y in positions) / len(positions)
        return (avg_x, avg_y)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\pitch.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\player_agent.py ---

import random

class PlayerAgent:
    def __init__(self, player_model):
        # –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        self.player_model = player_model
        self.full_name = player_model.full_name
        self.position = player_model.position
        
        # –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        self.condition = 100  # –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        self.morale = 100    # –ú–æ—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        
    def decide_action(self, match_state):
        """–ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è –æ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–π—Å—Ç–≤–∏–∏"""
        if self.position in ['Center Forward', 'Attacking Midfielder']:
            return 'attack' if random.random() < 0.7 else 'position'
        elif self.position == 'Midfielder':
            return 'attack' if random.random() < 0.5 else 'position'
        else:
            return 'position'

    def perform_action(self, action, match_state):
        """–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è"""
        # –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º True/False –¥–ª—è —É—Å–ø–µ—Ö–∞/–Ω–µ—É–¥–∞—á–∏
        if action == 'attack':
            return random.random() < 0.4
        elif action == 'position':
            return True
        return False

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\player_agent.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\tests.py ---

from django.test import TestCase

# Create your tests here.

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\urls.py ---

from django.urls import path
from . import views

app_name = 'matches'

urlpatterns = [
    path('', views.MatchListView.as_view(), name='match_list'),
    path('create/', views.CreateMatchView.as_view(), name='create_match'),
    path('<int:pk>/', views.MatchDetailView.as_view(), name='match_detail'),
    path('<int:match_id>/simulate/', views.simulate_match_view, name='simulate_match'),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\views.py ---

from django.shortcuts import render, redirect, get_object_or_404
from django.views.generic import CreateView, DetailView, ListView
from django.urls import reverse
from django.contrib.auth.decorators import login_required
from django.utils.decorators import method_decorator
from django.utils import timezone
from .models import Match, MatchEvent
from clubs.models import Club
#from .match_simulation import simulate_match

class CreateMatchView(CreateView):
    model = Match
    fields = ['home_team', 'away_team', 'datetime']  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å date –Ω–∞ datetime
    template_name = 'matches/create_match.html'

    def form_valid(self, form):
        match = form.save()
        return redirect(reverse('matches:match_detail', kwargs={'pk': match.pk}))

class MatchDetailView(DetailView):
    model = Match
    template_name = 'matches/match_detail.html'
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['match_events'] = MatchEvent.objects.filter(match=self.object).order_by('minute')
        return context

@login_required
def simulate_match_view(request, match_id):
    # –ï—Å–ª–∏ match_id = 0, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç—á
    if match_id == 0:
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª—É–± –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        club = request.user.club
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–≥–æ –±–æ—Ç–∞-—Å–æ–ø–µ—Ä–Ω–∏–∫–∞
        opponent = Club.objects.filter(is_bot=True).exclude(id=club.id).order_by('?').first()
        if not opponent:
            return render(request, 'matches/no_opponent.html', {'club': club})
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ç—á
        match = Match.objects.create(
            home_team=club,
            away_team=opponent,
            datetime=timezone.now(),  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å date –Ω–∞ datetime
            status='scheduled'
        )
        match_id = match.id
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é –º–∞—Ç—á–∞
    simulate_match(match_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∞—Ç—á –∏ —Å–æ–±—ã—Ç–∏—è
    match = get_object_or_404(Match, id=match_id)
    match_events = MatchEvent.objects.filter(match=match).order_by('minute')
    
    # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –º–∞—Ç—á–∞
    return render(request, 'matches/match_detail.html', {
        'match': match,
        'match_events': match_events,
    })

@method_decorator(login_required, name='dispatch')
class MatchListView(ListView):
    model = Match
    template_name = 'matches/match_list.html'
    context_object_name = 'matches'

    def get_queryset(self):
        return Match.objects.filter(home_team=self.request.user.club) | \
               Match.objects.filter(away_team=self.request.user.club)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\matches\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\matches\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\management\commands\update_player_attributes.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from players.models import Player
from players.utils import generate_player_stats
from tqdm import tqdm

class Command(BaseCommand):
    help = 'Updates existing players with new attributes'

    def add_arguments(self, parser):
        parser.add_argument(
            '--batch-size',
            type=int,
            default=100,
            help='How many players to update in one batch'
        )

    def handle(self, *args, **options):
        batch_size = options['batch_size']
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤
            total_players = Player.objects.count()
            self.stdout.write(f"Found {total_players} players to update")

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º tqdm –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            with tqdm(total=total_players) as pbar:
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ –±–∞—Ç—á–∞–º–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏
                for i in range(0, total_players, batch_size):
                    with transaction.atomic():
                        players = Player.objects.all()[i:i+batch_size]
                        
                        for player in players:
                            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                            stats = generate_player_stats(
                                player.position,
                                player.player_class
                            )
                            
                            # –û–±–Ω–æ–≤–ª—è–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
                            for attr, value in stats.items():
                                setattr(player, attr, value)
                            
                            player.save()
                            pbar.update(1)
                
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Successfully updated {total_players} players'
                    )
                )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(
                    f'Error updating players: {str(e)}'
                )
            )
            raise e

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\management\commands\update_player_attributes.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\0001_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import django.db.models.deletion
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('clubs', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Player',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(default='', max_length=100, verbose_name='First Name')),
                ('last_name', models.CharField(default='', max_length=100, verbose_name='Last Name')),
                ('age', models.PositiveIntegerField(default=17, verbose_name='Age')),
                ('nationality', django_countries.fields.CountryField(default='Unknown', max_length=2, verbose_name='Nationality')),
                ('position', models.CharField(choices=[('Goalkeeper', 'Goalkeeper'), ('Right Back', 'Right Back'), ('Left Back', 'Left Back'), ('Center Back', 'Center Back'), ('Defensive Midfielder', 'Central Defensive Midfielder'), ('Right Midfielder', 'Right Midfielder'), ('Central Midfielder', 'Central Midfielder'), ('Left Midfielder', 'Left Midfielder'), ('Attacking Midfielder', 'Attacking Midfielder'), ('Center Forward', 'Center Forward')], default='Unknown', max_length=50, verbose_name='Position')),
                ('player_class', models.IntegerField(default=1, verbose_name='Player Class')),
                ('strength', models.IntegerField(default=0, verbose_name='Strength')),
                ('stamina', models.IntegerField(default=0, verbose_name='Stamina')),
                ('pace', models.IntegerField(default=0, verbose_name='Pace')),
                ('positioning', models.IntegerField(default=0, verbose_name='Positioning')),
                ('reflexes', models.IntegerField(default=0, verbose_name='Reflexes')),
                ('handling', models.IntegerField(default=0, verbose_name='Handling')),
                ('aerial', models.IntegerField(default=0, verbose_name='Aerial')),
                ('command', models.IntegerField(default=0, verbose_name='Command')),
                ('distribution', models.IntegerField(default=0, verbose_name='Distribution')),
                ('one_on_one', models.IntegerField(default=0, verbose_name='One on One')),
                ('rebound_control', models.IntegerField(default=0, verbose_name='Rebound Control')),
                ('shot_reading', models.IntegerField(default=0, verbose_name='Shot Reading')),
                ('marking', models.IntegerField(default=0, verbose_name='Marking')),
                ('tackling', models.IntegerField(default=0, verbose_name='Tackling')),
                ('work_rate', models.IntegerField(default=0, verbose_name='Work Rate')),
                ('passing', models.IntegerField(default=0, verbose_name='Passing')),
                ('crossing', models.IntegerField(default=0, verbose_name='Crossing')),
                ('dribbling', models.IntegerField(default=0, verbose_name='Dribbling')),
                ('flair', models.IntegerField(default=0, verbose_name='Flair')),
                ('heading', models.IntegerField(default=0, verbose_name='Heading')),
                ('finishing', models.IntegerField(default=0, verbose_name='Finishing')),
                ('long_range', models.IntegerField(default=0, verbose_name='Long Range')),
                ('vision', models.IntegerField(default=0, verbose_name='Vision')),
                ('accuracy', models.IntegerField(default=0, verbose_name='Accuracy')),
                ('club', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='clubs.club', verbose_name='Club')),
            ],
            options={
                'verbose_name': 'Player',
                'verbose_name_plural': 'Players',
                'ordering': ['last_name', 'first_name'],
                'unique_together': {('first_name', 'last_name')},
            },
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\0001_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\0002_player_experience.py ---

# Generated by Django 5.0.1 on 2024-12-11 14:56

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('players', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='player',
            name='experience',
            field=models.FloatField(default=0.0, verbose_name='Experience'),
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\0002_player_experience.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\templates\players\player_detail.html ---

{% extends 'core/base.html' %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h3 mb-0">{{ player.first_name }} {{ player.last_name }}</h1>
                        <span class="badge bg-primary">{{ player.position }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Player Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="h5 mb-3">Player Info</h4>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>Club:</strong> 
                                    <a href="{% url 'clubs:club_detail' player.club.id %}" class="text-decoration-none">
                                        {{ player.club.name }}
                                        {% if player.club.is_bot %}<small>(Bot)</small>{% endif %}
                                    </a>
                                </li>
                                <li class="mb-2"><strong>Age:</strong> {{ player.age }}</li>
                                <li class="mb-2"><strong>Nationality:</strong> {{ player.nationality }}</li>
                                {% if player.player_class %}
                                <li class="mb-2">
                                    <strong>Class:</strong> 
                                    <span class="badge bg-info">Class {{ player.player_class }}</span>
                                </li>
                                {% endif %}
                                <!-- –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–ø—ã—Ç–∞ -->
                                <li class="mb-2">
                                    <strong>Experience:</strong> {{ player.experience|floatformat:1 }}
                                </li>
                                <li class="mb-2">
                                    <strong>Overall Rating:</strong> 
                                    <span class="badge bg-success">{{ player.overall_rating }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Attributes -->
                    <div class="row">
                        {% if player.position == 'Goalkeeper' %}
                            <!-- Physical Attributes -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Physical</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Strength:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.strength }}%" aria-valuenow="{{ player.strength }}" aria-valuemin="0" aria-valuemax="100">{{ player.strength }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Stamina:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.stamina }}%" aria-valuenow="{{ player.stamina }}" aria-valuemin="0" aria-valuemax="100">{{ player.stamina }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Pace:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.pace }}%" aria-valuenow="{{ player.pace }}" aria-valuemin="0" aria-valuemax="100">{{ player.pace }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Goalkeeper Core Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Core Goalkeeper Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Reflexes:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.reflexes }}%" aria-valuenow="{{ player.reflexes }}" aria-valuemin="0" aria-valuemax="100">{{ player.reflexes }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Handling:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.handling }}%" aria-valuenow="{{ player.handling }}" aria-valuemin="0" aria-valuemax="100">{{ player.handling }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Positioning:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.positioning }}%" aria-valuenow="{{ player.positioning }}" aria-valuemin="0" aria-valuemax="100">{{ player.positioning }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Aerial:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.aerial }}%" aria-valuenow="{{ player.aerial }}" aria-valuemin="0" aria-valuemax="100">{{ player.aerial }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Goalkeeper Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Additional Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Command:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.command }}%" aria-valuenow="{{ player.command }}" aria-valuemin="0" aria-valuemax="100">{{ player.command }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Distribution:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.distribution }}%" aria-valuenow="{{ player.distribution }}" aria-valuemin="0" aria-valuemax="100">{{ player.distribution }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>One on One:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.one_on_one }}%" aria-valuenow="{{ player.one_on_one }}" aria-valuemin="0" aria-valuemax="100">{{ player.one_on_one }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Shot Reading:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.shot_reading }}%" aria-valuenow="{{ player.shot_reading }}" aria-valuemin="0" aria-valuemax="100">{{ player.shot_reading }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Rebound Control:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.rebound_control }}%" aria-valuenow="{{ player.rebound_control }}" aria-valuemin="0" aria-valuemax="100">{{ player.rebound_control }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Physical Attributes -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Physical</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Strength:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.strength }}%" aria-valuenow="{{ player.strength }}" aria-valuemin="0" aria-valuemax="100">{{ player.strength }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Stamina:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.stamina }}%" aria-valuenow="{{ player.stamina }}" aria-valuemin="0" aria-valuemax="100">{{ player.stamina }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Pace:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.pace }}%" aria-valuenow="{{ player.pace }}" aria-valuemin="0" aria-valuemax="100">{{ player.pace }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Work Rate:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.work_rate }}%" aria-valuenow="{{ player.work_rate }}" aria-valuemin="0" aria-valuemax="100">{{ player.work_rate }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Technical Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Technical Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Passing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.passing }}%" aria-valuenow="{{ player.passing }}" aria-valuemin="0" aria-valuemax="100">{{ player.passing }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Dribbling:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.dribbling }}%" aria-valuenow="{{ player.dribbling }}" aria-valuemin="0" aria-valuemax="100">{{ player.dribbling }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Crossing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.crossing }}%" aria-valuenow="{{ player.crossing }}" aria-valuemin="0" aria-valuemax="100">{{ player.crossing }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Heading:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.heading }}%" aria-valuenow="{{ player.heading }}" aria-valuemin="0" aria-valuemax="100">{{ player.heading }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Finishing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.finishing }}%" aria-valuenow="{{ player.finishing }}" aria-valuemin="0" aria-valuemax="100">{{ player.finishing }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mental & Additional Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Mental & Additional Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Vision:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.vision }}%" aria-valuenow="{{ player.vision }}" aria-valuemin="0" aria-valuemax="100">{{ player.vision }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Flair:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.flair }}%" aria-valuenow="{{ player.flair }}" aria-valuemin="0" aria-valuemax="100">{{ player.flair }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Accuracy:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.accuracy }}%" aria-valuenow="{{ player.accuracy }}" aria-valuemin="0" aria-valuemax="100">{{ player.accuracy }}</div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Long Range:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar" role="progressbar" style="width: {{ player.long_range }}%" aria-valuenow="{{ player.long_range }}" aria-valuemin="0" aria-valuemax="100">{{ player.long_range }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Defense Skills -->
                            <div class="col-md-12 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Defense Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Marking:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar" role="progressbar" style="width: {{ player.marking }}%" aria-valuenow="{{ player.marking }}" aria-valuemin="0" aria-valuemax="100">{{ player.marking }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Tackling:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar" role="progressbar" style="width: {{ player.tackling }}%" aria-valuenow="{{ player.tackling }}" aria-valuemin="0" aria-valuemax="100">{{ player.tackling }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Positioning:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar" role="progressbar" style="width: {{ player.positioning }}%" aria-valuenow="{{ player.positioning }}" aria-valuemin="0" aria-valuemax="100">{{ player.positioning }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\templates\players\player_detail.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\admin.py ---

from django.contrib import admin
from .models import Player

@admin.register(Player)
class PlayerAdmin(admin.ModelAdmin):
    list_display = ('last_name', 'first_name', 'club', 'nationality')
    list_filter = ('club', 'nationality')
    search_fields = ('last_name', 'first_name', 'club__name', 'nationality')

# –∏–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
# admin.site.register(Player, PlayerAdmin)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\apps.py ---

from django.apps import AppConfig


class PlayersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'players'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\models.py ---

from django.db import models
from django_countries.fields import CountryField

class Player(models.Model):
    POSITIONS = [
        ('Goalkeeper', 'Goalkeeper'),
        ('Right Back', 'Right Back'), 
        ('Left Back', 'Left Back'),
        ('Center Back', 'Center Back'),
        ('Defensive Midfielder', 'Central Defensive Midfielder'),
        ('Right Midfielder', 'Right Midfielder'),
        ('Central Midfielder', 'Central Midfielder'),
        ('Left Midfielder', 'Left Midfielder'),
        ('Attacking Midfielder', 'Attacking Midfielder'),
        ('Center Forward', 'Center Forward'),
    ]

    # –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    first_name = models.CharField(max_length=100, default='', verbose_name="First Name")
    last_name = models.CharField(max_length=100, default='', verbose_name="Last Name")
    age = models.PositiveIntegerField(default=17, verbose_name="Age")
    club = models.ForeignKey('clubs.Club', on_delete=models.CASCADE, verbose_name="Club", null=True, blank=True)
    nationality = CountryField(blank_label='(select country)', verbose_name="Nationality", default="Unknown")
    position = models.CharField(max_length=50, choices=POSITIONS, default='Unknown', verbose_name="Position")
    player_class = models.IntegerField(default=1, verbose_name="Player Class")

    # –û–±—â–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    strength = models.IntegerField(default=0, verbose_name="Strength")
    stamina = models.IntegerField(default=0, verbose_name="Stamina")
    pace = models.IntegerField(default=0, verbose_name="Pace")
    positioning = models.IntegerField(default=0, verbose_name="Positioning")

    # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤—Ä–∞—Ç–∞—Ä–µ–π
    reflexes = models.IntegerField(default=0, verbose_name="Reflexes")
    handling = models.IntegerField(default=0, verbose_name="Handling")
    aerial = models.IntegerField(default=0, verbose_name="Aerial")
    command = models.IntegerField(default=0, verbose_name="Command")
    distribution = models.IntegerField(default=0, verbose_name="Distribution")
    one_on_one = models.IntegerField(default=0, verbose_name="One on One")
    rebound_control = models.IntegerField(default=0, verbose_name="Rebound Control")
    shot_reading = models.IntegerField(default=0, verbose_name="Shot Reading")

    # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–æ–ª–µ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    marking = models.IntegerField(default=0, verbose_name="Marking")
    tackling = models.IntegerField(default=0, verbose_name="Tackling")
    work_rate = models.IntegerField(default=0, verbose_name="Work Rate")
    passing = models.IntegerField(default=0, verbose_name="Passing")
    crossing = models.IntegerField(default=0, verbose_name="Crossing")
    dribbling = models.IntegerField(default=0, verbose_name="Dribbling")
    flair = models.IntegerField(default=0, verbose_name="Flair")
    heading = models.IntegerField(default=0, verbose_name="Heading")
    finishing = models.IntegerField(default=0, verbose_name="Finishing")
    long_range = models.IntegerField(default=0, verbose_name="Long Range")
    vision = models.IntegerField(default=0, verbose_name="Vision")
    accuracy = models.IntegerField(default=0, verbose_name="Accuracy")

    # –ù–æ–≤–æ–µ –ø–æ–ª–µ –æ–ø—ã—Ç–∞
    experience = models.FloatField(default=0.0, verbose_name="Experience")

    class Meta:
        unique_together = ('first_name', 'last_name')
        verbose_name = 'Player'
        verbose_name_plural = 'Players'
        ordering = ['last_name', 'first_name']

    def __str__(self):
        return f"{self.first_name} {self.last_name} ({self.club.name if self.club else 'No Club'}) - {self.position}"

    def save(self, *args, **kwargs):
        if not self.nationality and self.club:
            self.nationality = self.club.country
        super().save(*args, **kwargs)

    @property
    def full_name(self):
        return f"{self.first_name} {self.last_name}"

    @property
    def is_goalkeeper(self):
        return self.position == 'Goalkeeper'

    @property
    def overall_rating(self):
        """–í—ã—á–∏—Å–ª—è–µ—Ç –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫,
        —É—á–∏—Ç—ã–≤–∞—è –æ–ø—ã—Ç. –î–æ–ø—É—Å—Ç–∏–º, –∑–∞ –∫–∞–∂–¥—ã–π 1.0 –æ–ø—ã—Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ä–∞—Å—Ç—É—Ç –Ω–∞ 1%."""

        # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–ª–∏—è–Ω–∏—è –æ–ø—ã—Ç–∞ (1% –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –æ–ø—ã—Ç–∞)
        experience_multiplier = 1 + self.experience * 0.01

        if self.is_goalkeeper:
            attributes = [
                self.reflexes, self.handling, self.aerial,
                self.command, self.distribution, self.one_on_one,
                self.rebound_control, self.shot_reading,
                self.strength, self.stamina, self.pace, self.positioning
            ]
        else:
            attributes = [
                self.strength, self.stamina, self.pace,
                self.marking, self.tackling, self.work_rate,
                self.positioning, self.passing, self.crossing,
                self.dribbling, self.flair, self.heading,
                self.finishing, self.long_range, self.vision,
                self.accuracy
            ]

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—ã—Ç–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å –∫ –∫–∞–∂–¥–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–µ
        adjusted_attributes = [int(attr * experience_multiplier) for attr in attributes]

        return sum(adjusted_attributes) // len(adjusted_attributes)

    def get_position_specific_attributes(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞—Ç—Ä–∏–±—É—Ç—ã, —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞"""
        if self.is_goalkeeper:
            return {
                'reflexes': self.reflexes,
                'handling': self.handling,
                'aerial': self.aerial,
                'command': self.command,
                'distribution': self.distribution,
                'one_on_one': self.one_on_one,
                'rebound_control': self.rebound_control,
                'shot_reading': self.shot_reading
            }
        else:
            return {
                'marking': self.marking,
                'tackling': self.tackling,
                'work_rate': self.work_rate,
                'passing': self.passing,
                'crossing': self.crossing,
                'dribbling': self.dribbling,
                'flair': self.flair,
                'heading': self.heading,
                'finishing': self.finishing,
                'long_range': self.long_range,
                'vision': self.vision,
                'accuracy': self.accuracy
            }

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\player_attributes_config.py ---

# player_attributes_config.py

CLASS_1_WEIGHTS = {
    'Goalkeeper': {
        'attributes': {
            'reflexes': [(1.0, 0.40), (1.0, 0.35), (1.0, 0.25)],
            'handling': [(1.0, 0.40), (1.0, 0.35), (1.0, 0.25)],
            'positioning': [(1.0, 0.40), (1.0, 0.35), (1.0, 0.25)],
            'aerial': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'jumping': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'command': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'throwing': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'kicking': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'strength': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'stamina': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
            'pace': [(1.0, 0.50), (1.0, 0.30), (1.0, 0.20)],
        }
    },
    'Right Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Left Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Center Back': {
        'attributes': {
            'marking': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'tackling': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'heading': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'stamina': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'ball_control': [(1.0, 1.0)],
            'crossing': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Defensive Midfielder': {
        'attributes': {
            'tackling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'marking': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'passing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Central Midfielder': {
        'attributes': {
            'passing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'work_rate': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'tackling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'marking': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'long_range': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)]
        }
    },
    'Right Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Left Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Attacking Midfielder': {
        'attributes': {
            'dribbling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'ball_control': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'finishing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'long_range': [(2.0, 0.50)],
            'strength': [(1.0, 1.0)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)],
            'work_rate': [(1.0, 1.0)],
            'positioning': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)]
        }
    },
    'Center Forward': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
}

CLASS_2_WEIGHTS = {
    'Goalkeeper': {
        'attributes': {
            'reflexes': [(3.3, 0.40), (2.3, 0.35), (1.3, 0.25)],
            'handling': [(3.2, 0.40), (2.2, 0.35), (1.2, 0.25)],
            'positioning': [(3.1, 0.40), (2.1, 0.35), (1.1, 0.25)],
            'aerial': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'jumping': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'command': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'throwing': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'kicking': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)]
        }
    },
    'Right Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Left Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Center Back': {
        'attributes': {
            'marking': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'tackling': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'heading': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'stamina': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'ball_control': [(1.0, 1.0)],
            'crossing': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Defensive Midfielder': {
        'attributes': {
            'tackling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'marking': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'passing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Central Midfielder': {
        'attributes': {
            'passing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'work_rate': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'tackling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'marking': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'long_range': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)]
        }
    },
    'Right Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Left Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Attacking Midfielder': {
        'attributes': {
            'dribbling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'ball_control': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'finishing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'long_range': [(2.0, 0.50)],
            'strength': [(1.0, 1.0)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)],
            'work_rate': [(1.0, 1.0)],
            'positioning': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)]
        }
    },
    'Center Forward': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
}

CLASS_3_WEIGHTS = {
    'Goalkeeper': {
        'attributes': {
            'reflexes':  [(3.7, 0.40), (3.7, 0.35), (0.7, 0.25)],
            'handling':  [(3.7, 0.40), (3.7, 0.35), (0.7, 0.25)],
            'positioning':  [(3.7, 0.40), (3.7, 0.35), (0.7, 0.25)],
            'aerial': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'jumping': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'command': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'throwing': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'kicking': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)]
        }
    },
    'Right Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Left Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Center Back': {
        'attributes': {
            'marking': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'tackling': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'heading': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'stamina': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'ball_control': [(1.0, 1.0)],
            'crossing': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Defensive Midfielder': {
        'attributes': {
            'tackling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'marking': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'passing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Central Midfielder': {
        'attributes': {
            'passing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'work_rate': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'tackling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'marking': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'long_range': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)]
        }
    },
    'Right Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Left Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Attacking Midfielder': {
        'attributes': {
            'dribbling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'ball_control': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'finishing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'long_range': [(2.0, 0.50)],
            'strength': [(1.0, 1.0)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)],
            'work_rate': [(1.0, 1.0)],
            'positioning': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)]
        }
    },
    'Center Forward': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
}

CLASS_4_WEIGHTS = {
    'Goalkeeper': {
        'attributes': {
            'reflexes': [(0.7, 0.40), (0.7, 0.35), (0.7, 0.25)],
            'handling':  [(0.7, 0.40), (0.7, 0.35), (0.7, 0.25)],
            'positioning':  [(0.7, 0.40), (0.7, 0.35), (0.7, 0.25)],
            'aerial': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'jumping': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'command': [(2.0, 0.50), (1.5, 0.30), (1.0, 0.20)],
            'throwing': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'kicking': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (0.5, 0.20)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)]
        }
    },
    'Right Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Left Back': {
        'attributes': {
            'tackling': [(2.3, 0.40), (1.3, 0.35), (3.3, 0.25)],
            'marking': [(2.2, 0.40), (1.2, 0.35), (3.2, 0.25)],
            'crossing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'passing': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Center Back': {
        'attributes': {
            'marking': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'tackling': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'heading': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'stamina': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'ball_control': [(1.0, 1.0)],
            'crossing': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)],
            'vision': [(1.0, 1.0)]
        }
    },
    'Defensive Midfielder': {
        'attributes': {
            'tackling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'marking': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'passing': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'strength': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'work_rate': [(2.5, 0.50), (2.0, 0.30), (3.0, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'ball_control': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'heading': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'dribbling': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Central Midfielder': {
        'attributes': {
            'passing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'work_rate': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'positioning': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'strength': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'pace': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'tackling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'marking': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'dribbling': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'long_range': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'crossing': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)]
        }
    },
    'Right Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Left Midfielder': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
    'Attacking Midfielder': {
        'attributes': {
            'dribbling': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'vision': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'ball_control': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'finishing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'long_range': [(2.0, 0.50)],
            'strength': [(1.0, 1.0)],
            'stamina': [(1.0, 1.0)],
            'pace': [(1.0, 1.0)],
            'work_rate': [(1.0, 1.0)],
            'positioning': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)]
        }
    },
    'Center Forward': {
        'attributes': {
            'crossing': [(3.3, 0.40), (2.3, 0.35), (2.3, 0.25)],
            'pace': [(2.2, 0.40), (3.2, 0.35), (2.2, 0.25)],
            'dribbling': [(2.1, 0.40), (3.1, 0.35), (1.1, 0.25)],
            'stamina': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'ball_control': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'passing': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'work_rate': [(2.0, 0.50), (1.5, 0.30), (2.5, 0.20)],
            'vision': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'positioning': [(1.5, 0.50), (1.0, 0.30), (2.0, 0.20)],
            'strength': [(1.0, 1.0)],
            'marking': [(1.0, 1.0)],
            'tackling': [(1.0, 1.0)],
            'heading': [(1.0, 1.0)],
            'finishing': [(1.0, 1.0)],
            'long_range': [(1.0, 1.0)]
        }
    },
}

POSITIONS_WEIGHTS = {
    1: CLASS_1_WEIGHTS,
    2: CLASS_2_WEIGHTS,
    3: CLASS_3_WEIGHTS,
    4: CLASS_4_WEIGHTS
}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\player_attributes_config.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\tests.py ---

# players/tests.py
from django.test import TestCase, Client
from django.urls import reverse
from accounts.models import CustomUser  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫—É—é –º–æ–¥–µ–ª—å
from clubs.models import Club
from players.models import Player

class PlayerTests(TestCase):
    def setUp(self):
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CustomUser
        self.user = CustomUser.objects.create_user(username='testuser', email='testuser@example.com', password='password123')

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª—É–± –∏ –Ω–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–µ–º
        self.club = Club.objects.create(name='Test Club', country='Test Country', owner=self.user)

        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
        self.client = Client()
        self.client.login(username='testuser', password='password123')

        # URL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        self.create_player_url = reverse('create_player', kwargs={'pk': self.club.pk})

    def test_generate_player(self):
        """–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞"""
        response = self.client.get(self.create_player_url, {'position': 'Midfielder'})

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–≥—Ä–æ–∫–∞
        self.assertEqual(response.status_code, 302)
        player = Player.objects.first()
        self.assertIsNotNone(player)
        self.assertEqual(player.position, 'Midfielder')
        self.assertEqual(player.club, self.club)

    def test_player_detail_page(self):
        """–¢–µ—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π –∏–≥—Ä–æ–∫–∞, –≤–∫–ª—é—á–∞—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫"""
        player = Player.objects.create(
            club=self.club,
            first_name='Test',
            last_name='Player',
            nationality='Test Country',
            age=18,
            position='Midfielder',
            strength=80,
            stamina=75,
            pace=70
        )
        detail_url = reverse('players:player_detail', args=[player.pk])
        response = self.client.get(detail_url)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π –∏–≥—Ä–æ–∫–∞
        self.assertEqual(response.status_code, 200)
        self.assertContains(response, player.first_name)
        self.assertContains(response, player.last_name)
        self.assertContains(response, 'Strength: 80')
        self.assertContains(response, 'Stamina: 75')
        self.assertContains(response, 'Pace: 70')

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\urls.py ---

from django.urls import path
from .views import PlayerDetailView

urlpatterns = [
    path('detail/<int:pk>/', PlayerDetailView.as_view(), name='player_detail'),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\utils.py ---

from scipy.stats import norm
import random
import sys
import os

def generate_stat(weight=1):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –±–∞–∑–æ–≤—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É"""
    base_value = norm.rvs(50, 10)
    weighted_value = base_value * weight
    return max(1, min(99, int(weighted_value)))

def generate_player_stats(position, player_class):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏"""
    # –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    base_stats = {
        'strength': generate_stat(),
        'stamina': generate_stat(),
        'pace': generate_stat(),
        'positioning': generate_stat(),
    }

    if position == 'Goalkeeper':
        # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤—Ä–∞—Ç–∞—Ä—è (12 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫)
        gk_stats = {
            'reflexes': generate_stat(),
            'handling': generate_stat(),
            'aerial': generate_stat(),
            'command': generate_stat(),
            'distribution': generate_stat(),
            'one_on_one': generate_stat(),
            'rebound_control': generate_stat(),
            'shot_reading': generate_stat()
        }
        stats = {**base_stats, **gk_stats}
    else:
        # –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (16 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫)
        field_stats = {
            'marking': generate_stat(),
            'tackling': generate_stat(),
            'work_rate': generate_stat(),
            'passing': generate_stat(),
            'crossing': generate_stat(),
            'dribbling': generate_stat(),
            'flair': generate_stat(),
            'heading': generate_stat(),
            'finishing': generate_stat(),
            'long_range': generate_stat(),
            'vision': generate_stat(),
            'accuracy': generate_stat()
        }
        stats = {**base_stats, **field_stats}

        # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–∑–∏—Ü–∏–π
        position_modifiers = {
            'Center Back': {
                'marking': 1.2, 'tackling': 1.2, 'heading': 1.1,
                'strength': 1.1, 'finishing': 0.8, 'dribbling': 0.8
            },
            'Right Back': {
                'pace': 1.1, 'crossing': 1.1, 'stamina': 1.1,
                'tackling': 1.1, 'marking': 1.1
            },
            'Left Back': {
                'pace': 1.1, 'crossing': 1.1, 'stamina': 1.1,
                'tackling': 1.1, 'marking': 1.1
            },
            'Defensive Midfielder': {
                'tackling': 1.2, 'marking': 1.1, 'passing': 1.1,
                'work_rate': 1.2, 'vision': 1.1
            },
            'Central Midfielder': {
                'passing': 1.2, 'vision': 1.2, 'work_rate': 1.1,
                'stamina': 1.1, 'positioning': 1.1
            },
            'Attacking Midfielder': {
                'vision': 1.2, 'passing': 1.2, 'dribbling': 1.1,
                'flair': 1.2, 'finishing': 1.1
            },
            'Center Forward': {
                'finishing': 1.3, 'heading': 1.2, 'positioning': 1.2,
                'strength': 1.1, 'dribbling': 1.1
            }
        }

        # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–∑–∏—Ü–∏–∏
        if position in position_modifiers:
            for attr, mod in position_modifiers[position].items():
                if attr in stats:
                    stats[attr] = min(99, int(stats[attr] * mod))

    # –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ –∏–≥—Ä–æ–∫–∞
    class_modifier = (5 - player_class) * 0.1  # +10% –∑–∞ –∫–∞–∂–¥—ã–π –∫–ª–∞—Å—Å –≤—ã—à–µ 1
    for key in stats:
        stats[key] = min(99, int(stats[key] * (1 + class_modifier)))

    return stats

def print_player_stats(stats):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫"""
    print("\n–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞:")
    total = 0
    count = 0
    for attr, value in sorted(stats.items()):
        print(f"{attr}: {value}")
        total += value
        count += 1
    if count > 0:
        print(f"\n–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥: {total/count:.1f}")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\utils.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\views.py ---

from django.views.generic import DetailView
from .models import Player

class PlayerDetailView(DetailView):
    model = Player
    template_name = 'players/player_detail.html'

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\players\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\players\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\asgi.py ---

"""
ASGI config for realfootballsim project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'realfootballsim.settings')

application = get_asgi_application()

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\asgi.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\celery.py ---

import os
from celery import Celery

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'realfootballsim.settings')

app = Celery('realfootballsim')

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ settings.py
app.config_from_object('django.conf:settings', namespace='CELERY')

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ –≤—Å–µ—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π Django
app.autodiscover_tasks()

@app.task(bind=True)
def debug_task(self):
    print(f'Request: {self.request!r}')

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\celery.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\routing.py ---

from channels.routing import ProtocolTypeRouter, URLRouter
from django.urls import path
from matches.consumers import MatchConsumer

application = ProtocolTypeRouter({
    "websocket": URLRouter([
        path("ws/match/<int:match_id>/", MatchConsumer.as_asgi()),
    ]),
})

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\routing.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\settings.py ---

from pathlib import Path
import os
from celery.schedules import crontab

BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = 'django-insecure-0p3aqax2r2xolyvtfda6q_aa@q1l6n!w4$8sjo1ed&*)h*2l37'

DEBUG = True

ALLOWED_HOSTS = []

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'accounts',
    'core',
    'players',
    'clubs',
    'matches',
    'tournaments.apps.TournamentsConfig',
    'django_celery_beat',
    'channels',  # –î–æ–±–∞–≤–ª—è–µ–º channels
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'tournaments.timezone_middleware.TimezoneMiddleware',
]

ROOT_URLCONF = 'realfootballsim.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'tournaments.context_processors.timezone_context',
            ],
        },
    },
]

WSGI_APPLICATION = 'realfootballsim.wsgi.application'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Channels
ASGI_APPLICATION = 'realfootballsim.asgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
        'OPTIONS': {
            'timeout': 60,
            'isolation_level': 'IMMEDIATE'
        },
        'ATOMIC_REQUESTS': False,
    }
}

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True

STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

AUTH_USER_MODEL = 'accounts.CustomUser'

LOGIN_REDIRECT_URL = 'clubs:club_detail'
LOGIN_URL = 'accounts:login'
LOGOUT_REDIRECT_URL = 'accounts:login'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Celery
CELERY_BROKER_URL = 'redis://localhost:6379/0'
CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'UTC'
CELERY_BROKER_CONNECTION_RETRY_ON_STARTUP = True
CELERY_TASK_TIME_LIMIT = 300
CELERY_TASK_SOFT_TIME_LIMIT = 240

CELERY_WORKER_MAX_TASKS_PER_CHILD = 50
CELERY_WORKER_PREFETCH_MULTIPLIER = 1

# –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á Celery Beat
CELERY_BEAT_SCHEDULE = {
    'simulate-every-5-seconds': {
        'task': 'tournaments.simulate_active_matches',
        'schedule': 5.0,  # –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    },
    'check-season-end': {
        'task': 'tournaments.check_season_end',
        'schedule': crontab(hour=0, minute=0),
    },
    'start-scheduled-matches-every-minute': {
        'task': 'tournaments.start_scheduled_matches',
        'schedule': crontab(minute='*'),  # –ö–∞–∂–¥—ã–π 1 –º–∏–Ω
    },
}

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
        'file': {
            'class': 'logging.FileHandler',
            'filename': 'debug.log',
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'clubs': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': True,
        },
        'matches': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': True,
        },
        'tournaments': {
            'handlers': ['console', 'file'],
            'level': 'DEBUG',
            'propagate': True,
        },
    },
}

TOURNAMENT_TIMEZONES = [
    ('UTC', 'UTC'),
    ('Europe/London', 'London'),
    ('Europe/Moscow', 'Moscow'),
    ('America/New_York', 'New York'),
    ('Asia/Tokyo', 'Tokyo'),
]

CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {
            "hosts": [("127.0.0.1", 6379)],
        },
    },
}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\settings.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\urls.py ---

from django.contrib import admin
from django.urls import path, include
from core.views import home

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', home, name='home'),
    path('accounts/', include(('accounts.urls', 'accounts'), namespace='accounts')),  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
    path('core/', include('core.urls')),
    path('players/', include(('players.urls', 'players'), namespace='players')),
    path('clubs/', include(('clubs.urls', 'clubs'), namespace='clubs')),
    path('matches/', include(('matches.urls', 'matches'), namespace='matches')),
    path('tournaments/', include(('tournaments.urls', 'tournaments'), namespace='tournaments')),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\wsgi.py ---

"""
WSGI config for realfootballsim project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'realfootballsim.settings')

application = get_wsgi_application()

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\wsgi.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\__init__.py ---

from .celery import app as celery_app

__all__ = ('celery_app',)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\realfootballsim\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\check_matches.py ---

# tournaments/management/commands/check_matches.py
from django.core.management.base import BaseCommand
from django.utils import timezone
from matches.models import Match
from matches.match_simulation import simulate_match
import logging
from datetime import datetime

logger = logging.getLogger('matches')

class Command(BaseCommand):
    help = 'Checks and simulates matches that should start now'

    def add_arguments(self, parser):
        # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        parser.add_argument(
            '--debug',
            action='store_true',
            help='Print additional debug information',
        )

    def handle(self, *args, **options):
        now = timezone.now()
        debug = options['debug']

        if debug:
            self.stdout.write(f'Current time: {now}')
            logger.info(f'Starting match check at {now}')

        # –ù–∞—Ö–æ–¥–∏–º –º–∞—Ç—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏ –Ω–∞—á–∞—Ç—å—Å—è
        matches = Match.objects.filter(
            status='scheduled',
            date__lte=now
        ).select_related('home_team', 'away_team')

        if debug:
            self.stdout.write(f'Found {matches.count()} matches to simulate')
            for match in matches:
                self.stdout.write(
                    f'- {match.date}: {match.home_team} vs {match.away_team}'
                )

        if matches.exists():
            logger.info(f'Found {matches.count()} matches to simulate')
            
            for match in matches:
                try:
                    msg = f'Simulating match: {match.home_team} vs {match.away_team} (scheduled for {match.date})'
                    self.stdout.write(msg)
                    logger.info(msg)
                    
                    simulate_match(match.id)
                    
                    logger.info(
                        f'Match completed: {match.home_team} {match.home_score} - {match.away_score} {match.away_team}'
                    )
                except Exception as e:
                    error_msg = f'Error simulating match {match.id}: {str(e)}'
                    self.stdout.write(self.style.ERROR(error_msg))
                    logger.error(error_msg)

            self.stdout.write(
                self.style.SUCCESS(f'Successfully simulated {matches.count()} matches')
            )
        else:
            if debug:
                self.stdout.write('No matches to simulate')

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\check_matches.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_new_season.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from tournaments.models import Championship, Season, League
from tournaments.utils import create_championship_matches
from datetime import timedelta

class Command(BaseCommand):
    help = 'Creates new season with championships based on current league assignments'

    def add_arguments(self, parser):
        parser.add_argument(
            '--days',
            type=int,
            default=30,
            help='Duration of the season in days'
        )

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–∑–æ–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –Ω–æ–≤–æ–≥–æ
                last_season = Season.objects.order_by('-number').first()
                new_season_number = 1 if not last_season else last_season.number + 1
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—ã —Å–µ–∑–æ–Ω–∞
                start_date = timezone.now().date()
                duration = timedelta(days=options['days'])
                end_date = start_date + duration

                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω
                new_season = Season.objects.create(
                    number=new_season_number,
                    name=f"Season {new_season_number}",
                    start_date=start_date,
                    end_date=end_date,
                    is_active=True
                )
                
                self.stdout.write(f"Created new season: {new_season}")

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ª–∏–≥–∏
                leagues = League.objects.all().order_by('country', 'level')
                
                championships_created = 0
                matches_created = 0

                # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ª–∏–≥–∏
                for league in leagues:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –≤ –ª–∏–≥–µ
                    teams_in_league = league.clubs.count()
                    if teams_in_league != 16:
                        self.stdout.write(
                            self.style.WARNING(
                                f"Skipping {league}: has {teams_in_league} teams instead of 16"
                            )
                        )
                        continue

                    # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç
                    championship = Championship.objects.create(
                        season=new_season,
                        league=league,
                        status='pending',
                        start_date=start_date,
                        end_date=end_date
                    )

                    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
                    for team in league.clubs.all():
                        championship.teams.add(team)

                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π
                    create_championship_matches(championship)
                    
                    championships_created += 1
                    matches_created += championship.championshipmatch_set.count()

                    self.stdout.write(
                        f"Created championship for {league.name} with "
                        f"{championship.teams.count()} teams"
                    )

                self.stdout.write(
                    self.style.SUCCESS(
                        f"Successfully created new season {new_season_number} with "
                        f"{championships_created} championships and "
                        f"{matches_created} matches"
                    )
                )

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error creating new season: {str(e)}")
            )
            raise

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_new_season.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_second_divisions.py ---

# tournaments/management/commands/create_second_divisions.py
from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import League
from django_countries import countries

class Command(BaseCommand):
    help = 'Creates second divisions for all countries'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                top_leagues = League.objects.filter(level=1)
                
                for league in top_leagues:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
                    second_div_exists = League.objects.filter(
                        country=league.country,
                        level=2
                    ).exists()
                    
                    if not second_div_exists:
                        League.objects.create(
                            name=f"{league.country.name} Second Division",
                            country=league.country,
                            level=2,
                            max_teams=16,
                            foreign_players_limit=5
                        )
                        self.stdout.write(
                            self.style.SUCCESS(
                                f"Created second division for {league.country.name}"
                            )
                        )
                
                self.stdout.write(self.style.SUCCESS("All second divisions created!"))
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error creating second divisions: {str(e)}")
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_second_divisions.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_second_division_championships.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import League, Championship, Season
from django.utils import timezone

class Command(BaseCommand):
    help = 'Creates championships for second divisions in current season'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–µ–∑–æ–Ω
                current_season = Season.objects.get(is_active=True)
                
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤—Ç–æ—Ä—ã–µ –¥–∏–≤–∏–∑–∏–æ–Ω—ã
                second_divisions = League.objects.filter(level=2)
                
                championships_created = 0
                for league in second_divisions:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞ –¥–ª—è —ç—Ç–æ–π –ª–∏–≥–∏ –≤ —Ç–µ–∫—É—â–µ–º —Å–µ–∑–æ–Ω–µ
                    exists = Championship.objects.filter(
                        season=current_season,
                        league=league
                    ).exists()
                    
                    if not exists:
                        # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç
                        championship = Championship.objects.create(
                            season=current_season,
                            league=league,
                            status='in_progress',
                            start_date=current_season.start_date,
                            end_date=current_season.end_date,
                            match_time=timezone.now().time().replace(hour=18, minute=0)
                        )
                        
                        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –ª–∏–≥–∏ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
                        for club in league.clubs.all():
                            championship.teams.add(club)
                            
                        championships_created += 1
                        self.stdout.write(f"Created championship for {league.name}")
                
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Successfully created {championships_created} championships'
                    )
                )
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error creating championships: {str(e)}')
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\create_second_division_championships.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\end_season.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from tournaments.models import Season, Championship
from django.core.management import call_command
from django.db.models import Count, Q

class Command(BaseCommand):
    help = 'Handles the end of season process'

    def add_arguments(self, parser):
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force end season even if not all matches are finished'
        )

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —Å–µ–∑–æ–Ω
                current_season = Season.objects.get(is_active=True)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
                championships = Championship.objects.filter(season=current_season)
                
                unfinished_matches = 0
                for championship in championships:
                    unfinished = championship.championshipmatch_set.filter(
                        ~Q(match__status='finished')
                    ).count()
                    unfinished_matches += unfinished
                
                if unfinished_matches > 0 and not options['force']:
                    self.stdout.write(
                        self.style.WARNING(
                            f"Cannot end season: {unfinished_matches} matches not finished. "
                            "Use --force to override."
                        )
                    )
                    return
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥
                invalid_championships = []
                for championship in championships:
                    team_count = championship.teams.count()
                    if team_count != 16:
                        invalid_championships.append(
                            f"{championship}: {team_count} teams"
                        )
                
                if invalid_championships and not options['force']:
                    self.stdout.write(
                        self.style.WARNING(
                            "Invalid team counts in championships:\n" + 
                            "\n".join(invalid_championships) +
                            "\nUse --force to override."
                        )
                    )
                    return

                # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω
                self.stdout.write("Processing end of season transitions...")
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏
                call_command('handle_season_transitions')
                
                # –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω
                current_season.is_active = False
                current_season.save()
                
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω
                self.stdout.write("Creating new season...")
                call_command('create_new_season')
                
                self.stdout.write(
                    self.style.SUCCESS(
                        f"Successfully ended season {current_season.number}"
                    )
                )

        except Season.DoesNotExist:
            self.stdout.write(
                self.style.ERROR("No active season found")
            )
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error ending season: {str(e)}")
            )
            raise

    def validate_championship_results(self, championship):
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—ã–≥—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        team_stats = championship.championshipteam_set.all()
        total_teams = team_stats.count()
        expected_matches = (total_teams - 1) * 2  # –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–≥—Ä–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ –¥–≤–∞–∂–¥—ã
        
        for stats in team_stats:
            if stats.matches_played != expected_matches:
                return False, f"Team {stats.team.name} played {stats.matches_played} matches instead of {expected_matches}"
        
        return True, None

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\end_season.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_all_matches.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import Championship
from tournaments.utils import create_championship_matches
import logging

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Generates matches for all divisions'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã
                championships = Championship.objects.filter(
                    status='in_progress'
                ).select_related('league')
                
                total_matches = 0
                for championship in championships:
                    self.stdout.write(
                        f"Generating matches for {championship} "
                        f"(Division {championship.league.level})"
                    )
                    create_championship_matches(championship)
                    matches_count = championship.championshipmatch_set.count()
                    total_matches += matches_count
                    self.stdout.write(
                        f"Created {matches_count} matches for "
                        f"{championship.league.name} (Division {championship.league.level})"
                    )
                    
                self.stdout.write(
                    self.style.SUCCESS(
                        f'Successfully generated {total_matches} matches '
                        f'for {championships.count()} championships'
                    )
                )
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error generating matches: {str(e)}')
            )
            logger.error(f"Error generating matches: {str(e)}")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_all_matches.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_championships.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django_countries import countries
from faker import Faker
from tournaments.models import League, Championship, Season
from clubs.models import Club
from tqdm import tqdm
import sys
import random  # –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç random

class Command(BaseCommand):
    help = 'Generates championships for all countries with bot teams'

    def __init__(self):
        super().__init__()
        self.fake = Faker()
        self.team_adjectives = [
            'Red', 'Blue', 'Golden', 'Silver', 'Black', 'White', 'Royal',
            'Imperial', 'Northern', 'United', 'Real', 'Crystal', 'Athletic',
            'Sporting', 'Racing', 'Phoenix', 'Elite', 'Supreme', 'Ancient',
            'Mighty', 'Green', 'Purple', 'Bronze', 'Iron', 'Steel', 
            'Eastern', 'Western', 'Southern', 'Central', 'Inter',
            'Dynamic', 'Olympic', 'Spartak', 'Victoria', 'Glory',
            'Freedom', 'Unity', 'Progressive', 'Classic', 'Modern'
        ]
        self.team_nouns = [
            'Lions', 'Eagles', 'Dragons', 'Warriors', 'Knights', 'Rovers',
            'Rangers', 'Wanderers', 'Stars', 'Kings', 'Legends', 'Phoenix',
            'Tigers', 'Panthers', 'Wolves', 'Falcons', 'Titans', 'Giants',
            'Heroes', 'Guardians', 'Hawks', 'Bears', 'Sharks', 'Vipers',
            'Scorpions', 'Pythons', 'Cobras', 'Stallions', 'Bulls', 'Raiders',
            'Hunters', 'Hornets', 'Ravens', 'Demons', 'Angels', 'Thunder',
            'Lightning', 'Storm', 'United', 'City'
        ]
        self.team_suffixes = ['FC', 'United', 'City', 'Athletic', 'Sporting']
        self.stats = {
            'leagues_created': 0,
            'championships_created': 0,
            'teams_created': 0,
            'countries_processed': 0
        }

    def generate_team_name(self):
        """Generates a unique random team name with more variations"""
        attempts = 0
        max_attempts = 100
        while attempts < max_attempts:
            # 70% chance of standard name (Adjective + Noun)
            # 30% chance of name with suffix (Adjective + Noun + Suffix)
            if random.random() < 0.7:
                adj = self.fake.random_element(self.team_adjectives)
                noun = self.fake.random_element(self.team_nouns)
                name = f"{adj} {noun}"
            else:
                adj = self.fake.random_element(self.team_adjectives)
                noun = self.fake.random_element(self.team_nouns)
                suffix = self.fake.random_element(self.team_suffixes)
                name = f"{adj} {noun} {suffix}"

            if not Club.objects.filter(name=name).exists():
                return name
            attempts += 1
        raise Exception(f"Could not generate unique team name after {max_attempts} attempts")

    def add_arguments(self, parser):
        parser.add_argument(
            '--start-from',
            type=str,
            help='Start from specific country code (e.g., "FR" for France)',
        )
        parser.add_argument(
            '--force',
            action='store_true',
            help='Force recreation of championships even if they exist',
        )

    def handle(self, *args, **options):
        self.stdout.write('Starting championship generation process...')
        
        # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ start_from
        start_from = (options.get('start_from') or '').upper()
        force = options.get('force', False)

        # –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        existing_leagues = League.objects.count()
        existing_championships = Championship.objects.count()
        existing_clubs = Club.objects.count()

        self.stdout.write(f'Current state:')
        self.stdout.write(f'- Existing leagues: {existing_leagues}')
        self.stdout.write(f'- Existing championships: {existing_championships}')
        self.stdout.write(f'- Existing clubs: {existing_clubs}')
        
        try:
            with transaction.atomic():
                # Create active season if not exists
                season, created = Season.objects.get_or_create(
                    name="2024/2025",
                    defaults={
                        'start_date': '2024-08-01',
                        'end_date': '2025-05-31',
                        'is_active': True
                    }
                )
                
                if created:
                    self.stdout.write(self.style.SUCCESS(f'Created new season: {season.name}'))
                else:
                    self.stdout.write(f'Using existing season: {season.name}')

                # Get list of countries and filter if needed
                country_list = list(countries)
                if start_from:
                    try:
                        start_index = next(i for i, (code, _) in enumerate(country_list) 
                                         if code == start_from)
                        country_list = country_list[start_index:]
                        self.stdout.write(f'Starting from country: {start_from}')
                    except StopIteration:
                        self.stdout.write(
                            self.style.WARNING(f'Country code {start_from} not found, starting from beginning')
                        )

                self.stdout.write(f'Processing {len(country_list)} countries...')

                with tqdm(total=len(country_list), desc="Processing countries") as pbar:
                    for country_code, country_name in country_list:
                        try:
                            # Check if league exists
                            league = League.objects.filter(
                                country=country_code,
                                level=1
                            ).first()

                            if not league:
                                league = League.objects.create(
                                    country=country_code,
                                    level=1,
                                    name=f"{country_name} Premier League",
                                    max_teams=16,
                                    foreign_players_limit=5
                                )
                                self.stats['leagues_created'] += 1

                            # Check if championship exists
                            championship = Championship.objects.filter(
                                season=season,
                                league=league
                            ).first()

                            if not championship or force:
                                if force and championship:
                                    championship.delete()
                                
                                championship = Championship.objects.create(
                                    season=season,
                                    league=league,
                                    status='pending',
                                    start_date=season.start_date,
                                    end_date=season.end_date
                                )
                                self.stats['championships_created'] += 1

                                # Create teams
                                for i in range(16):
                                    team_name = self.generate_team_name()
                                    team = Club.objects.create(
                                        name=team_name,
                                        country=country_code,
                                        is_bot=True,
                                        owner=None
                                    )
                                    championship.teams.add(team)
                                    self.stats['teams_created'] += 1

                            self.stats['countries_processed'] += 1

                        except Exception as e:
                            self.stdout.write(
                                self.style.ERROR(f'Error processing {country_name}: {str(e)}')
                            )
                            continue
                        finally:
                            pbar.update(1)

                # Print final statistics
                self.stdout.write(self.style.SUCCESS('\nGeneration completed successfully!'))
                self.stdout.write(f"Countries processed: {self.stats['countries_processed']}")
                self.stdout.write(f"Leagues created: {self.stats['leagues_created']}")
                self.stdout.write(f"Championships created: {self.stats['championships_created']}")
                self.stdout.write(f"Teams created: {self.stats['teams_created']}")
                
        except KeyboardInterrupt:
            self.stdout.write(self.style.WARNING('\nProcess interrupted by user'))
            self.stdout.write(f"Countries processed: {self.stats['countries_processed']}")
            self.stdout.write(f"Leagues created: {self.stats['leagues_created']}")
            self.stdout.write(f"Championships created: {self.stats['championships_created']}")
            self.stdout.write(f"Teams created: {self.stats['teams_created']}")
            sys.exit(1)
            
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'\nError during championship generation: {str(e)}')
            )
            raise e

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_championships.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_players_for_all_teams.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from clubs.models import Club
from players.models import Player
from faker import Faker
from players.utils import generate_player_stats
import random

class Command(BaseCommand):
    help = 'Generates players for all teams'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                clubs = Club.objects.all()
                
                for club in clubs:
                    self.stdout.write(f"Generating players for {club.name}...")
                    
                    # –°–æ–∑–¥–∞–µ–º Faker –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞–Ω—ã
                    fake = Faker(['en_GB'])
                    
                    # –ü–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤
                    positions = [
                        "Goalkeeper",
                        "Right Back",
                        "Center Back",
                        "Left Back",
                        "Defensive Midfielder",
                        "Central Midfielder",
                        "Attacking Midfielder",
                        "Right Midfielder",
                        "Left Midfielder",
                        "Center Forward"
                    ]
                    
                    # –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º—É–º 25 –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
                    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–µ–º –≤—Ä–∞—Ç–∞—Ä—è
                    self.create_player(club, "Goalkeeper", fake)
                    
                    # –°–æ–∑–¥–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
                    for _ in range(24):
                        position = random.choice(positions)
                        self.create_player(club, position, fake)
                    
                    self.stdout.write(f"Created 25 players for {club.name}")
                
                self.stdout.write(self.style.SUCCESS("All teams populated with players!"))
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error generating players: {str(e)}")
            )
    
    def create_player(self, club, position, fake):
        """–°–æ–∑–¥–∞–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞"""
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
        while True:
            first_name = fake.first_name_male()
            last_name = fake.last_name_male()
            if not Player.objects.filter(first_name=first_name, last_name=last_name).exists():
                break
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
        stats = generate_player_stats(position, random.randint(1, 4))
        
        if position == 'Goalkeeper':
            Player.objects.create(
                club=club,
                first_name=first_name,
                last_name=last_name,
                nationality=club.country,
                age=random.randint(17, 35),
                position=position,
                player_class=random.randint(1, 4),
                strength=stats['strength'],
                stamina=stats['stamina'],
                pace=stats['pace'],
                positioning=stats['positioning'],
                reflexes=stats['reflexes'],
                handling=stats['handling'],
                aerial=stats['aerial'],
                jumping=stats['jumping'],
                command=stats['command'],
                throwing=stats['throwing'],
                kicking=stats['kicking']
            )
        else:
            Player.objects.create(
                club=club,
                first_name=first_name,
                last_name=last_name,
                nationality=club.country,
                age=random.randint(17, 35),
                position=position,
                player_class=random.randint(1, 4),
                strength=stats['strength'],
                stamina=stats['stamina'],
                pace=stats['pace'],
                marking=stats['marking'],
                tackling=stats['tackling'],
                work_rate=stats['work_rate'],
                positioning=stats['positioning'],
                passing=stats['passing'],
                crossing=stats['crossing'],
                dribbling=stats['dribbling'],
                ball_control=stats['ball_control'],
                heading=stats['heading'],
                finishing=stats['finishing'],
                long_range=stats['long_range'],
                vision=stats['vision']
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_players_for_all_teams.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_schedule.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import Championship
from tournaments.utils import create_championship_matches, validate_championship_schedule
from django.utils import timezone

class Command(BaseCommand):
    help = 'Generates match schedule for championships'

    def add_arguments(self, parser):
        parser.add_argument(
            '--championship',
            type=int,
            help='ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö)'
        )

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                if options['championship']:
                    championships = Championship.objects.filter(
                        id=options['championship'],
                        status='pending'
                    )
                else:
                    championships = Championship.objects.filter(
                        season__is_active=True,
                        status='pending'
                    )

                if not championships:
                    self.stdout.write(
                        self.style.WARNING('–ù–µ—Ç —á–µ–º–ø–∏–æ–Ω–∞—Ç–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è')
                    )
                    return

                for championship in championships:
                    try:
                        self.stdout.write(
                            f'–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è {championship}...'
                        )
                        
                        create_championship_matches(championship)
                        
                        if validate_championship_schedule(championship):
                            championship.status = 'in_progress'
                            championship.save()
                            
                            self.stdout.write(
                                self.style.SUCCESS(
                                    f'–£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è {championship}'
                                )
                            )
                        else:
                            raise ValueError(
                                f'–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è {championship}'
                            )
                            
                    except Exception as e:
                        self.stdout.write(
                            self.style.ERROR(f'–û—à–∏–±–∫–∞ –¥–ª—è {championship}: {str(e)}')
                        )
                        raise

        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: {str(e)}')
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\generate_schedule.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\handle_season_transitions.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import Championship, Season, League
from django.db.models import F
from django.core.exceptions import ValidationError

class Command(BaseCommand):
    help = 'Process end of season transitions between divisions'

    def add_arguments(self, parser):
        parser.add_argument(
            '--season',
            type=int,
            help='Season number to process (defaults to active season)'
        )

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º —Å–µ–∑–æ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                season_number = options.get('season')
                if season_number:
                    season = Season.objects.get(number=season_number)
                else:
                    season = Season.objects.get(is_active=True)

                self.stdout.write(f"Processing end of season transitions for {season}")

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞
                championships = Championship.objects.filter(
                    season=season
                ).select_related('league')

                # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –ø–æ —Å—Ç—Ä–∞–Ω–∞–º
                countries = {}
                for champ in championships:
                    country_code = champ.league.country.code
                    if country_code not in countries:
                        countries[country_code] = {'div1': None, 'div2': None}
                    
                    if champ.league.level == 1:
                        countries[country_code]['div1'] = champ
                    elif champ.league.level == 2:
                        countries[country_code]['div2'] = champ

                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–∞–Ω—É
                for country_code, divisions in countries.items():
                    if not divisions['div1'] or not divisions['div2']:
                        self.stdout.write(
                            self.style.WARNING(
                                f"Skipping {country_code} - missing division"
                            )
                        )
                        continue

                    self.process_country_transitions(
                        divisions['div1'], 
                        divisions['div2']
                    )

        except Season.DoesNotExist:
            self.stdout.write(
                self.style.ERROR("No active season found!")
            )
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error during transitions: {str(e)}")
            )
            raise

    def process_country_transitions(self, div1_championship, div2_championship):
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã
        """
        country_name = div1_championship.league.country.name
        self.stdout.write(f"\nProcessing {country_name}:")

        try:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–Ω–∏–∂–µ–Ω–∏—è (2 –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞)
            relegated_teams = (
                div1_championship.championshipteam_set
                .annotate(
                    goals_diff=F('goals_for') - F('goals_against')
                )
                .order_by(
                    'points',
                    'goals_diff',
                    'goals_for'
                )[:2]
            )

            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è (2 –ø–µ—Ä–≤—ã–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞)
            promoted_teams = (
                div2_championship.championshipteam_set
                .annotate(
                    goals_diff=F('goals_for') - F('goals_against')
                )
                .order_by(
                    '-points',
                    '-goals_diff',
                    '-goals_for'
                )[:2]
            )

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã
            div2_league = div2_championship.league
            div1_league = div1_championship.league

            # –ü–æ–Ω–∏–∂–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
            for team_stats in relegated_teams:
                team = team_stats.team
                team.league = div2_league
                team.save()
                self.stdout.write(
                    f"  Relegated: {team.name} "
                    f"(Points: {team_stats.points}, "
                    f"GD: {team_stats.goals_diff})"
                )

            # –ü–æ–≤—ã—à–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
            for team_stats in promoted_teams:
                team = team_stats.team
                team.league = div1_league
                team.save()
                self.stdout.write(
                    f"  Promoted: {team.name} "
                    f"(Points: {team_stats.points}, "
                    f"GD: {team_stats.goals_diff})"
                )

        except Exception as e:
            raise ValidationError(
                f"Error processing transitions for {country_name}: {str(e)}"
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\handle_season_transitions.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\initialize_football_world.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from tournaments.models import League, Championship, Season
from clubs.models import Club
from players.models import Player
from players.utils import generate_player_stats
from faker import Faker
import random
from datetime import datetime, timedelta
import logging

logger = logging.getLogger(__name__)

class Command(BaseCommand):
    help = 'Initialize complete football world with leagues, teams, and players'

    def __init__(self):
        super().__init__()
        self.TOP_LEAGUES = [
            {
                'country': 'GB',
                'div1_name': 'Premier League',
                'div2_name': 'Championship'
            },
            {
                'country': 'ES',
                'div1_name': 'La Liga',
                'div2_name': 'La Liga 2'
            },
            {
                'country': 'IT',
                'div1_name': 'Serie A',
                'div2_name': 'Serie B'
            },
            {
                'country': 'DE',
                'div1_name': 'Bundesliga',
                'div2_name': '2. Bundesliga'
            },
            {
                'country': 'FR',
                'div1_name': 'Ligue 1',
                'div2_name': 'Ligue 2'
            },
            {
                'country': 'PT',
                'div1_name': 'Primeira Liga',
                'div2_name': 'Liga Portugal 2'
            },
            {
                'country': 'GR',
                'div1_name': 'Super League',
                'div2_name': 'Super League 2'
            },
            {
                'country': 'RU',
                'div1_name': 'Premier League',
                'div2_name': 'First League'
            },
            {
                'country': 'AR',
                'div1_name': 'Primera Divisi√≥n',
                'div2_name': 'Primera Nacional'
            },
            {
                'country': 'BR',
                'div1_name': 'S√©rie A',
                'div2_name': 'S√©rie B'
            },
        ]
        self.team_names = [
            'United', 'City', 'Athletic', 'Rovers', 'Wanderers', 
            'Rangers', 'Dynamo', 'Sporting', 'Real', 'Inter',
            'Academy', 'Warriors', 'Legion', 'Phoenix', 'Union'
        ]
        self.team_suffixes = ['FC', 'CF', 'SC', 'AF']
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–º–∞–Ω–¥—ã
        self.team_structure = {
            "Goalkeeper": {"count": 3, "class_distribution": [1, 2, 3]},
            "Right Back": {"count": 2, "class_distribution": [2, 3]},
            "Center Back": {"count": 4, "class_distribution": [1, 2, 3, 4]},
            "Left Back": {"count": 2, "class_distribution": [2, 3]},
            "Defensive Midfielder": {"count": 2, "class_distribution": [2, 3]},
            "Central Midfielder": {"count": 3, "class_distribution": [1, 2, 3]},
            "Attacking Midfielder": {"count": 2, "class_distribution": [2, 3]},
            "Right Midfielder": {"count": 2, "class_distribution": [2, 3]},
            "Left Midfielder": {"count": 2, "class_distribution": [2, 3]},
            "Center Forward": {"count": 3, "class_distribution": [1, 2, 3]}
        }

    def generate_team_name(self, fake):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"""
        attempts = 0
        while attempts < 100:
            city = fake.city()
            variant = random.choice([
                f"{city} {random.choice(self.team_names)}",
                f"{random.choice(self.team_names)} {city}",
                f"{city} {random.choice(self.team_suffixes)}"
            ])
            if not Club.objects.filter(name=variant).exists():
                return variant
            attempts += 1
        raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã")

    def create_league_structure(self):
        """–°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ª–∏–≥"""
        self.stdout.write("Creating league structure...")
        try:
            for league_info in self.TOP_LEAGUES:
                # –ü–µ—Ä–≤—ã–π –¥–∏–≤–∏–∑–∏–æ–Ω
                League.objects.create(
                    name=f"{league_info['country']} {league_info['div1_name']}",
                    country=league_info['country'],
                    level=1,
                    max_teams=16,
                    foreign_players_limit=5
                )
                
                # –í—Ç–æ—Ä–æ–π –¥–∏–≤–∏–∑–∏–æ–Ω
                League.objects.create(
                    name=f"{league_info['country']} {league_info['div2_name']}",
                    country=league_info['country'],
                    level=2,
                    max_teams=16,
                    foreign_players_limit=5
                )
            self.stdout.write(self.style.SUCCESS(f"Created {len(self.TOP_LEAGUES) * 2} leagues"))
            return True
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error creating leagues: {str(e)}"))
            return False

    def create_teams(self):
        """–°–æ–∑–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö –ª–∏–≥"""
        self.stdout.write("Creating teams...")
        try:
            for league in League.objects.all():
                fake = Faker(['en_GB'])
                for _ in range(16):  # 16 –∫–æ–º–∞–Ω–¥ –≤ –∫–∞–∂–¥–æ–π –ª–∏–≥–µ
                    team_name = self.generate_team_name(fake)
                    Club.objects.create(
                        name=team_name,
                        country=league.country,
                        league=league,
                        is_bot=True
                    )
                self.stdout.write(f"Created 16 teams for {league.name}")
            return True
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error creating teams: {str(e)}"))
            return False

    def create_player(self, club, position, fake, player_class):
        """–°–æ–∑–¥–∞–µ—Ç –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞"""
        while True:
            first_name = fake.first_name_male()
            last_name = fake.last_name_male()
            if not Player.objects.filter(first_name=first_name, last_name=last_name).exists():
                break

        stats = generate_player_stats(position, player_class)

        # –ë–∞–∑–æ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
        base_stats = {
            'club': club,
            'first_name': first_name,
            'last_name': last_name,
            'nationality': club.country,
            'age': random.randint(17, 35),
            'position': position,
            'player_class': player_class,
            'strength': stats['strength'],
            'stamina': stats['stamina'],
            'pace': stats['pace'],
            'positioning': stats['positioning'],
        }

        if position == 'Goalkeeper':
            # –î–æ–±–∞–≤–ª—è–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤—Ä–∞—Ç–∞—Ä—è
            goalkeeper_stats = {
                'reflexes': stats['reflexes'],
                'handling': stats['handling'],
                'aerial': stats['aerial'],
                'command': stats['command'],
                'distribution': stats['distribution'],
                'one_on_one': stats['one_on_one'],
                'rebound_control': stats['rebound_control'],
                'shot_reading': stats['shot_reading']
            }
            player_stats = {**base_stats, **goalkeeper_stats}
        else:
            # –î–æ–±–∞–≤–ª—è–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–æ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            field_stats = {
                'marking': stats['marking'],
                'tackling': stats['tackling'],
                'work_rate': stats['work_rate'],
                'passing': stats['passing'],
                'crossing': stats['crossing'],
                'dribbling': stats['dribbling'],
                'flair': stats['flair'],
                'heading': stats['heading'],
                'finishing': stats['finishing'],
                'long_range': stats['long_range'],
                'vision': stats['vision'],
                'accuracy': stats['accuracy']
            }
            player_stats = {**base_stats, **field_stats}

        return Player.objects.create(**player_stats)

    def create_players(self):
        """–°–æ–∑–¥–∞–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥"""
        self.stdout.write("Creating players...")
        try:
            for club in Club.objects.all():
                fake = Faker(['en_GB'])
                players_created = 0
                
                # –°–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–∫–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∫–æ–º–∞–Ω–¥—ã
                for position, details in self.team_structure.items():
                    count = details["count"]
                    class_distribution = details["class_distribution"]
                    
                    # –°–æ–∑–¥–∞–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø–æ–∑–∏—Ü–∏—é
                    for i in range(count):
                        # –í—ã–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∏–≥—Ä–æ–∫–∞ –∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                        player_class = class_distribution[i % len(class_distribution)]
                        self.create_player(club, position, fake, player_class)
                        players_created += 1
                
                self.stdout.write(f"Created {players_created} players for {club.name}")
            return True
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error creating players: {str(e)}"))
            return False

    def create_season_and_championships(self):
        """–°–æ–∑–¥–∞–µ—Ç —Å–µ–∑–æ–Ω –∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã"""
        self.stdout.write("Creating season and championships...")
        try:
            # –°–æ–∑–¥–∞–µ–º —Å–µ–∑–æ–Ω (–∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞—á–∞–ª–æ –Ω–∞ 1 –¥–µ–∫–∞–±—Ä—è)
            season = Season.objects.create(
                name="2024/2025",
                number=1,
                start_date=datetime(2024, 12, 1).date(),  # –ò–∑–º–µ–Ω–µ–Ω–æ —Å 11, 1 –Ω–∞ 12, 1
                end_date=datetime(2024, 12, 31).date(),
                is_active=True
            )

            # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ª–∏–≥
            for league in League.objects.all():
                championship = Championship.objects.create(
                    season=season,
                    league=league,
                    status='in_progress',
                    start_date=season.start_date,  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                    end_date=season.end_date,
                    match_time=timezone.now().time().replace(hour=18, minute=0)
                )
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
                teams = Club.objects.filter(league=league)
                for team in teams:
                    championship.teams.add(team)

                self.stdout.write(f"Created championship for {league.name}")
            return True
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error creating season and championships: {str(e)}"))
            return False

    def handle(self, *args, **options):
        self.stdout.write("Starting football world initialization...")
        
        # –ü–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
        if not self.create_league_structure():
            return
            
        if not self.create_teams():
            return
            
        if not self.create_players():
            return
            
        if not self.create_season_and_championships():
            return
            
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Ç—á–∏ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É
        try:
            from django.core.management import call_command
            call_command('generate_all_matches')
            self.stdout.write(self.style.SUCCESS("Football world initialization completed!"))
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error generating matches: {str(e)}')
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\initialize_football_world.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\initialize_top_leagues.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import League

class Command(BaseCommand):
    help = 'Initialize leagues for top 10 football countries'

    def handle(self, *args, **options):
        # –¢–æ–ø-10 —Ñ—É—Ç–±–æ–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω
        TOP_LEAGUES = [
            {
                'country': 'GB',
                'div1_name': 'Premier League',
                'div2_name': 'Championship'
            },
            {
                'country': 'ES',
                'div1_name': 'La Liga',
                'div2_name': 'La Liga 2'
            },
            {
                'country': 'IT',
                'div1_name': 'Serie A',
                'div2_name': 'Serie B'
            },
            {
                'country': 'DE',
                'div1_name': 'Bundesliga',
                'div2_name': '2. Bundesliga'
            },
            {
                'country': 'FR',
                'div1_name': 'Ligue 1',
                'div2_name': 'Ligue 2'
            },
            {
                'country': 'PT',
                'div1_name': 'Primeira Liga',
                'div2_name': 'Liga Portugal 2'
            },
            {
                'country': 'GR',
                'div1_name': 'Super League',
                'div2_name': 'Super League 2'
            },
            {
                'country': 'RU',
                'div1_name': 'Premier League',
                'div2_name': 'First League'
            },
            {
                'country': 'AR',
                'div1_name': 'Primera Divisi√≥n',
                'div2_name': 'Primera Nacional'
            },
            {
                'country': 'BR',
                'div1_name': 'S√©rie A',
                'div2_name': 'S√©rie B'
            },
        ]

        try:
            with transaction.atomic():
                # –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ª–∏–≥–∏
                League.objects.all().delete()
                
                for league_info in TOP_LEAGUES:
                    # –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–∏–≤–∏–∑–∏–æ–Ω
                    League.objects.create(
                        name=f"{league_info['country']} {league_info['div1_name']}", # –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        country=league_info['country'],
                        level=1,
                        max_teams=16,
                        foreign_players_limit=5
                    )
                    self.stdout.write(
                        f"Created {league_info['div1_name']} for {league_info['country']}"
                    )
                    
                    # –°–æ–∑–¥–∞–µ–º –≤—Ç–æ—Ä–æ–π –¥–∏–≤–∏–∑–∏–æ–Ω
                    League.objects.create(
                        name=f"{league_info['country']} {league_info['div2_name']}", # –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω—É –≤ –Ω–∞–∑–≤–∞–Ω–∏–µ
                        country=league_info['country'],
                        level=2,
                        max_teams=16,
                        foreign_players_limit=5
                    )
                    self.stdout.write(
                        f"Created {league_info['div2_name']} for {league_info['country']}"
                    )

                self.stdout.write(
                    self.style.SUCCESS(
                        f'Successfully created leagues for {len(TOP_LEAGUES)} countries'
                    )
                )
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'Error creating leagues: {str(e)}')
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\initialize_top_leagues.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\populate_first_divisions.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import League
from clubs.models import Club
from faker import Faker
import random

class Command(BaseCommand):
    help = 'Populates first divisions with bot teams'

    def __init__(self):
        super().__init__()
        self.team_adjectives = [
            'United', 'City', 'Athletic', 'Rovers', 'Wanderers', 
            'Rangers', 'Dynamo', 'Sporting', 'Real', 'Inter',
            'Academy', 'Warriors', 'Legion', 'Phoenix', 'Union'
        ]
        self.team_suffixes = ['FC', 'CF', 'SC', 'AF']

    def generate_team_name(self, fake):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"""
        attempts = 0
        while attempts < 100:
            city = fake.city()
            variant = random.choice([
                f"{city} {random.choice(self.team_adjectives)}",
                f"{random.choice(self.team_adjectives)} {city}",
                f"{city} {random.choice(self.team_suffixes)}"
            ])
            if not Club.objects.filter(name=variant).exists():
                return variant
            attempts += 1
        raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã")

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–µ—Ä–≤—ã–µ –¥–∏–≤–∏–∑–∏–æ–Ω—ã
                first_divisions = League.objects.filter(level=1)
                
                for league in first_divisions:
                    self.stdout.write(f"Populating {league.name}...")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥ —É–∂–µ –µ—Å—Ç—å
                    existing_teams = Club.objects.filter(league=league).count()
                    if existing_teams >= 16:
                        self.stdout.write(f"League {league.name} already has {existing_teams} teams")
                        continue
                    
                    # –°–æ–∑–¥–∞–µ–º Faker –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞–Ω—ã
                    fake = Faker(['en_GB'])  # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–∫–∞–ª–µ–π
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–æ 16
                    teams_to_create = 16 - existing_teams
                    for _ in range(teams_to_create):
                        team_name = self.generate_team_name(fake)
                        Club.objects.create(
                            name=team_name,
                            country=league.country,
                            league=league,
                            is_bot=True
                        )
                        self.stdout.write(f"Created team: {team_name}")
                    
                    self.stdout.write(
                        self.style.SUCCESS(
                            f"Successfully populated {league.name} with {teams_to_create} teams"
                        )
                    )
                
                self.stdout.write(self.style.SUCCESS("All first divisions populated!"))
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error populating first divisions: {str(e)}")
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\populate_first_divisions.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\populate_second_divisions.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from tournaments.models import League
from clubs.models import Club
from faker import Faker
import random

class Command(BaseCommand):
    help = 'Populates second divisions with bot teams'

    def __init__(self):
        super().__init__()
        self.team_adjectives = [
            'United', 'City', 'Athletic', 'Rovers', 'Wanderers', 
            'Rangers', 'Dynamo', 'Sporting', 'Real', 'Inter',
            'Academy', 'Warriors', 'Legion', 'Phoenix', 'Union'
        ]
        self.team_suffixes = ['FC', 'CF', 'SC', 'AF']

    def generate_team_name(self, fake):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"""
        attempts = 0
        while attempts < 100:
            city = fake.city()
            variant = random.choice([
                f"{city} {random.choice(self.team_adjectives)}",
                f"{random.choice(self.team_adjectives)} {city}",
                f"{city} {random.choice(self.team_suffixes)}"
            ])
            if not Club.objects.filter(name=variant).exists():
                return variant
            attempts += 1
        raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–º–∞–Ω–¥—ã")

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤—Ç–æ—Ä—ã–µ –¥–∏–≤–∏–∑–∏–æ–Ω—ã
                second_divisions = League.objects.filter(level=2)
                
                for league in second_divisions:
                    self.stdout.write(f"Populating {league.name}...")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥ —É–∂–µ –µ—Å—Ç—å
                    existing_teams = Club.objects.filter(league=league).count()
                    if existing_teams >= 16:
                        self.stdout.write(f"League {league.name} already has {existing_teams} teams")
                        continue
                    
                    # –°–æ–∑–¥–∞–µ–º Faker –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä–∞–Ω—ã
                    fake = Faker(['en_GB'])  # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–∫–∞–ª–µ–π
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–æ 16
                    teams_to_create = 16 - existing_teams
                    for _ in range(teams_to_create):
                        team_name = self.generate_team_name(fake)
                        Club.objects.create(
                            name=team_name,
                            country=league.country,
                            league=league,
                            is_bot=True
                        )
                        self.stdout.write(f"Created team: {team_name}")
                    
                    self.stdout.write(
                        self.style.SUCCESS(
                            f"Successfully populated {league.name} with {teams_to_create} teams"
                        )
                    )
                
                self.stdout.write(self.style.SUCCESS("All second divisions populated!"))
                
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f"Error populating second divisions: {str(e)}")
            )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\populate_second_divisions.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\reset_season.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django.utils import timezone
from datetime import datetime, date
from tournaments.models import Season, Championship, ChampionshipMatch
from tournaments.utils import create_championship_matches
from matches.match_simulation import simulate_match
from matches.models import Match
from clubs.models import Club

class Command(BaseCommand):
    help = 'Resets and creates new first season starting from November 2024'

    def handle(self, *args, **options):
        try:
            with transaction.atomic():
                # 1. –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ–∑–æ–Ω—ã –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                self.stdout.write("Deleting existing seasons and matches...")
                Season.objects.all().delete()  # –≠—Ç–æ —Ç–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç —Å–≤—è–∑–∞–Ω–Ω—ã–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –∏ –º–∞—Ç—á–∏

                # 2. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–µ—Ä–≤—ã–π —Å–µ–∑–æ–Ω
                season = Season.objects.create(
                    name="November 2024",
                    number=1,  # –ü–µ—Ä–≤—ã–π —Å–µ–∑–æ–Ω
                    start_date=date(2024, 11, 1),
                    end_date=date(2025, 5, 31),
                    is_active=True
                )
                self.stdout.write(self.style.SUCCESS(f"Created new season: {season.name}"))

                # 3. –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã –¥–ª—è –≤—Å–µ—Ö –ª–∏–≥
                from tournaments.models import League
                leagues = League.objects.all()
                championships_created = 0

                for league in leagues:
                    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —ç—Ç–æ–π –ª–∏–≥–∏
                    bot_teams = Club.objects.filter(league=league, is_bot=True)
                    human_teams = Club.objects.filter(league=league, is_bot=False)
                    total_teams = bot_teams.count() + human_teams.count()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ª–∏–≥–µ —Ä–æ–≤–Ω–æ 16 –∫–æ–º–∞–Ω–¥ (–±–æ—Ç—ã + —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ)
                    if total_teams != 16:
                        self.stdout.write(self.style.WARNING(
                            f"Skipping {league.name} - has {total_teams} teams "
                            f"({bot_teams.count()} bots, {human_teams.count()} human)"
                        ))
                        continue

                    championship = Championship.objects.create(
                        season=season,
                        league=league,
                        status='in_progress',  # –¢–∞–∫ –∫–∞–∫ —Å–µ–∑–æ–Ω —É–∂–µ –∏–¥—ë—Ç
                        start_date=season.start_date,
                        end_date=season.end_date
                    )
                    
                    # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
                    for team in list(bot_teams) + list(human_teams):
                        championship.teams.add(team)

                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                    create_championship_matches(championship)
                    championships_created += 1

                self.stdout.write(self.style.SUCCESS(
                    f"Created {championships_created} championships"
                ))

                # 4. –°–∏–º—É–ª–∏—Ä—É–µ–º –º–∞—Ç—á–∏ —Å 1 –ø–æ 7 –Ω–æ—è–±—Ä—è
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º timezone.make_aware –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è datetime —Å —á–∞—Å–æ–≤—ã–º –ø–æ—è—Å–æ–º
                current_date = timezone.make_aware(
                    datetime(2024, 11, 8, 0, 0, 0)
                )
                
                past_matches = Match.objects.filter(
                    date__lt=current_date,
                    status='scheduled'
                )

                matches_simulated = 0
                for match in past_matches:
                    simulate_match(match.id)
                    matches_simulated += 1

                self.stdout.write(self.style.SUCCESS(
                    f"Simulated {matches_simulated} past matches"
                ))

        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error occurred: {str(e)}"))
            raise e

        self.stdout.write(self.style.SUCCESS("Season reset completed successfully!"))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\reset_season.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\run_match_checker.py ---

from django.core.management.base import BaseCommand
from django.utils import timezone
import time
from matches.models import Match
from matches.match_simulation import simulate_match
import logging

logger = logging.getLogger('matches')

class Command(BaseCommand):
    help = 'Continuously checks and simulates matches'

    def handle(self, *args, **options):
        self.stdout.write('Starting match checker...')
        
        while True:
            try:
                now = timezone.now()
                self.stdout.write(f'Checking matches at {now}')
                
                # –ù–∞—Ö–æ–¥–∏–º –º–∞—Ç—á–∏ –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏
                matches = Match.objects.filter(
                    status='scheduled',
                    date__lte=now
                ).select_related('home_team', 'away_team')
                
                if matches.exists():
                    self.stdout.write(f'Found {matches.count()} matches to simulate')
                    
                    for match in matches:
                        try:
                            self.stdout.write(f'Simulating: {match.home_team} vs {match.away_team}')
                            simulate_match(match.id)
                            match.refresh_from_db()
                            self.stdout.write(
                                self.style.SUCCESS(
                                    f'Simulated: {match.home_team} {match.home_score} - {match.away_score} {match.away_team}'
                                )
                            )
                        except Exception as e:
                            self.stdout.write(
                                self.style.ERROR(f'Error simulating match {match.id}: {str(e)}')
                            )
                
                # –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
                time.sleep(10)
                
            except Exception as e:
                self.stdout.write(
                    self.style.ERROR(f'Error in match checker: {str(e)}')
                )
                time.sleep(10)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\run_match_checker.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\test_match.py ---

from django.core.management.base import BaseCommand
from django.utils import timezone
from clubs.models import Club
from matches.models import Match
from matches.match_simulation import MatchSimulation
import random

class Command(BaseCommand):
    help = 'Tests match simulation with random teams'

    def handle(self, *args, **options):
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–≤–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            teams = list(Club.objects.all().order_by('?')[:2])
            if len(teams) < 2:
                self.stdout.write(self.style.ERROR('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–º–∞–Ω–¥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö'))
                return

            home_team = teams[0]
            away_team = teams[1]

            # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–∞—Ö –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—á–∞
            self.stdout.write('\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–∞—Ö:')
            self.stdout.write(f'\n–î–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: {home_team.name}')
            self.stdout.write(f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {home_team.player_set.count()}')
            
            self.stdout.write(f'\n–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: {away_team.name}')
            self.stdout.write(f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {away_team.player_set.count()}\n')

            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç—á
            match = Match.objects.create(
                home_team=home_team,
                away_team=away_team,
                date=timezone.now(),
                status='scheduled'
            )

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏–º—É–ª—è—Ü–∏—é
            simulation = MatchSimulation(match)
            
            # –°–∏–º—É–ª–∏—Ä—É–µ–º –º–∞—Ç—á
            self.stdout.write('\n=== –ù–ê–ß–ê–õ–û –ú–ê–¢–ß–ê ===\n')
            
            for minute in range(90):
                if minute % 15 == 0:  # –ö–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    self.stdout.write(f'\n=== {minute} –ú–ò–ù–£–¢–ê ===')
                    self.stdout.write(f'–°—á–µ—Ç: {match.home_score} - {match.away_score}')
                    self.stdout.write(f'–í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º: {simulation.match_stats["home"]["possession"]}% - {simulation.match_stats["away"]["possession"]}%')
                    self.stdout.write(f'–£–¥–∞—Ä—ã (–≤ —Å—Ç–≤–æ—Ä): {simulation.match_stats["home"]["shots"]} ({simulation.match_stats["home"]["shots_on_target"]}) - {simulation.match_stats["away"]["shots"]} ({simulation.match_stats["away"]["shots_on_target"]})')
                
                simulation.simulate_minute(minute)
            
            # –í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            self.stdout.write('\n=== –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===')
            self.stdout.write(f'\n–ò—Ç–æ–≥–æ–≤—ã–π —Å—á–µ—Ç: {match.home_score} - {match.away_score}')
            self.stdout.write('\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–º–∞—à–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã:')
            self.stdout.write(f'–í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º: {simulation.match_stats["home"]["possession"]}%')
            self.stdout.write(f'–£–¥–∞—Ä—ã (–≤ —Å—Ç–≤–æ—Ä): {simulation.match_stats["home"]["shots"]} ({simulation.match_stats["home"]["shots_on_target"]})')
            self.stdout.write(f'–£–≥–ª–æ–≤—ã–µ: {simulation.match_stats["home"]["corners"]}')
            self.stdout.write(f'–§–æ–ª—ã: {simulation.match_stats["home"]["fouls"]}')
            self.stdout.write(f'–ê—Ç–∞–∫–∏ (–æ–ø–∞—Å–Ω—ã–µ): {simulation.match_stats["home"]["attacks"]} ({simulation.match_stats["home"]["dangerous_attacks"]})')
            
            self.stdout.write('\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥–æ—Å—Ç–µ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã:')
            self.stdout.write(f'–í–ª–∞–¥–µ–Ω–∏–µ –º—è—á–æ–º: {simulation.match_stats["away"]["possession"]}%')
            self.stdout.write(f'–£–¥–∞—Ä—ã (–≤ —Å—Ç–≤–æ—Ä): {simulation.match_stats["away"]["shots"]} ({simulation.match_stats["away"]["shots_on_target"]})')
            self.stdout.write(f'–£–≥–ª–æ–≤—ã–µ: {simulation.match_stats["away"]["corners"]}')
            self.stdout.write(f'–§–æ–ª—ã: {simulation.match_stats["away"]["fouls"]}')
            self.stdout.write(f'–ê—Ç–∞–∫–∏ (–æ–ø–∞—Å–Ω—ã–µ): {simulation.match_stats["away"]["attacks"]} ({simulation.match_stats["away"]["dangerous_attacks"]})')
            
            # –°–æ–±—ã—Ç–∏—è –º–∞—Ç—á–∞
            self.stdout.write('\n=== –°–û–ë–´–¢–ò–Ø –ú–ê–¢–ß–ê ===')
            events = match.events.all().order_by('minute')
            for event in events:
                self.stdout.write(f'{event.minute}\' - {event.description}')

        except Exception as e:
            self.stdout.write(self.style.ERROR(f'\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}'))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\test_match.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\test_prematch.py ---

from django.core.management.base import BaseCommand
from django.utils import timezone
from clubs.models import Club
from matches.models import Match
from matches.match_preparation import PreMatchPreparation
import random

class Command(BaseCommand):
    help = 'Tests prematch preparation with random teams'

    def handle(self, *args, **options):
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–≤–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
            teams = list(Club.objects.all().order_by('?')[:2])
            if len(teams) < 2:
                self.stdout.write(self.style.ERROR('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–º–∞–Ω–¥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö'))
                return

            home_team = teams[0]
            away_team = teams[1]

            # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–∞—Ö –¥–æ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ç—á–∞
            self.stdout.write('\n–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–∞—Ö:')
            self.stdout.write(f'\n–î–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: {home_team.name}')
            self.stdout.write(f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {home_team.player_set.count()}')
            
            self.stdout.write(f'\n–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: {away_team.name}')
            self.stdout.write(f'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤: {away_team.player_set.count()}\n')

            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç—á
            match = Match.objects.create(
                home_team=home_team,
                away_team=away_team,
                date=timezone.now(),
                status='scheduled'
            )

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –º–∞—Ç—á–∞
            prep = PreMatchPreparation(match)
            
            # –ü—Ä–æ–≤–æ–¥–∏–º –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É
            if prep.prepare_match():
                self.stdout.write(self.style.SUCCESS('\n–ü—Ä–µ–¥–º–∞—Ç—á–µ–≤–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞!\n'))
                
                # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–∞—Ö
                self.stdout.write('\n=== –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ö–û–ú–ê–ù–î–ê–• ===')
                self.stdout.write(f'\n–î–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: {home_team.name}')
                self.stdout.write(f'–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: {away_team.name}\n')
                
                # –í—ã–≤–æ–¥–∏–º –æ–±—â—É—é —Å–∏–ª—É –∫–æ–º–∞–Ω–¥
                self.stdout.write('\n=== –û–ë–©–ê–Ø –°–ò–õ–ê –ö–û–ú–ê–ù–î ===')
                self.stdout.write(f'–î–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞: {prep.team_strengths["home"]}')
                self.stdout.write(f'–ì–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞: {prep.team_strengths["away"]}\n')
                
                # –í—ã–≤–æ–¥–∏–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                self.stdout.write('\n=== –ü–ê–†–ê–ú–ï–¢–†–´ –î–û–ú–ê–®–ù–ï–ô –ö–û–ú–ê–ù–î–´ ===')
                home_params = prep.match_parameters['home']
                self.stdout.write(f'–ê—Ç–∞–∫–∞: {home_params["team_attack"]}')
                self.stdout.write(f'–û–±–æ—Ä–æ–Ω–∞: {home_params["team_defense"]}')
                self.stdout.write(f'–ü–æ–ª—É–∑–∞—â–∏—Ç–∞: {home_params["team_midfield"]}')
                self.stdout.write(f'–°–∏–ª–∞ –≤—Ä–∞—Ç–∞—Ä—è: {home_params["goalkeeper_strength"]}\n')
                
                self.stdout.write('\n=== –ü–ê–†–ê–ú–ï–¢–†–´ –ì–û–°–¢–ï–í–û–ô –ö–û–ú–ê–ù–î–´ ===')
                away_params = prep.match_parameters['away']
                self.stdout.write(f'–ê—Ç–∞–∫–∞: {away_params["team_attack"]}')
                self.stdout.write(f'–û–±–æ—Ä–æ–Ω–∞: {away_params["team_defense"]}')
                self.stdout.write(f'–ü–æ–ª—É–∑–∞—â–∏—Ç–∞: {away_params["team_midfield"]}')
                self.stdout.write(f'–°–∏–ª–∞ –≤—Ä–∞—Ç–∞—Ä—è: {away_params["goalkeeper_strength"]}\n')
                
            else:
                self.stdout.write(self.style.ERROR('\n–û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –º–∞—Ç—á–∞:'))
                for error in prep.get_validation_errors():
                    self.stdout.write(self.style.ERROR(f'- {error}'))
            
            # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞—Ç—á
            match.delete()

        except Exception as e:
            self.stdout.write(self.style.ERROR(f'\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}'))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\test_prematch.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\update_club_matches.py ---

from django.core.management.base import BaseCommand
from django.db import transaction
from django.db.models import Q
from tournaments.models import Championship, ChampionshipMatch
from matches.models import Match
from clubs.models import Club
import logging

logger = logging.getLogger(__name__)

def update_matches_for_replaced_team(championship, old_team_id, new_team):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –º–∞—Ç—á–∏, –∑–∞–º–µ–Ω—è—è old_team –Ω–∞ new_team
    """
    try:
        with transaction.atomic():
            # –ù–∞–π—Ç–∏ –≤—Å–µ –º–∞—Ç—á–∏, –≥–¥–µ —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∞ —Å—Ç–∞—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞
            matches = Match.objects.filter(
                championshipmatch__championship=championship
            ).filter(
                Q(home_team_id=old_team_id) |
                Q(away_team_id=old_team_id)
            )
            
            updated_count = 0
            # –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –º–∞—Ç—á–∏
            for match in matches:
                if match.home_team_id == old_team_id:
                    match.home_team = new_team
                    updated_count += 1
                if match.away_team_id == old_team_id:
                    match.away_team = new_team
                    updated_count += 1
                match.save()
                logger.info(f"Updated match {match.id}: {match.home_team} vs {match.away_team}")
            
            return updated_count  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π
    except Exception as e:
        logger.error(f"Error updating matches: {str(e)}")
        raise

class Command(BaseCommand):
    help = 'Updates championship matches for a club, replacing a bot team'

    def add_arguments(self, parser):
        parser.add_argument('club_id', type=int, help='ID of the club to update matches for')

    def handle(self, *args, **options):
        club_id = options['club_id']
        
        try:
            with transaction.atomic():
                # –ü–æ–ª—É—á–∞–µ–º –∫–ª—É–±
                club = Club.objects.get(id=club_id)
                self.stdout.write(f"Found club: {club.name} (ID: {club.id})")
                
                # –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω—ã –∫–ª—É–±–∞
                championship = Championship.objects.get(
                    league__country=club.country,
                    league__level=1,
                    season__is_active=True
                )
                self.stdout.write(f"Found championship: {championship}")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–ª—É–± –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ
                is_in_championship = championship.teams.filter(id=club.id).exists()
                if not is_in_championship:
                    self.stdout.write(self.style.ERROR(f"Club {club.name} is not part of championship {championship}"))
                    return

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∞—Ç—á–∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞
                matches = Match.objects.filter(
                    championshipmatch__championship=championship
                )

                # –ù–∞—Ö–æ–¥–∏–º –º–∞—Ç—á–∏, –≥–¥–µ –∫–ª—É–± –¥–æ–ª–∂–µ–Ω —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å
                team_matches = matches.filter(
                    Q(home_team=club) |
                    Q(away_team=club)
                ).count()

                if team_matches == 0:
                    # –ö–ª—É–± –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ, –Ω–æ –Ω–µ—Ç –º–∞—Ç—á–µ–π - –∏—â–µ–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–Ω –∑–∞–º–µ–Ω–∏–ª
                    self.stdout.write("Looking for replaced bot team...")
                    
                    # –í—ã–≤–æ–¥–∏–º –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    self.stdout.write("\nTeams in championship:")
                    for team in championship.teams.all():
                        self.stdout.write(f"- {team.name} (ID: {team.id}, Bot: {team.is_bot})")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    from tournaments.models import ChampionshipTeam
                    team_stats = ChampionshipTeam.objects.filter(
                        championship=championship,
                        team=club
                    ).first()
                    
                    if team_stats:
                        self.stdout.write(f"\nFound team statistics:")
                        self.stdout.write(f"Points: {team_stats.points}")
                        self.stdout.write(f"Matches played: {team_stats.matches_played}")
                    else:
                        self.stdout.write(self.style.WARNING("No team statistics found!"))

                    # –í—ã–≤–æ–¥–∏–º –ø—Ä–∏–º–µ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∞—Ç—á–µ–π –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    self.stdout.write("\nSample matches in championship:")
                    for match in matches[:5]:
                        self.stdout.write(
                            f"- {match.home_team.name} vs {match.away_team.name}"
                        )

                    # –ù–∞—Ö–æ–¥–∏–º –∫–æ–º–∞–Ω–¥—ã-–±–æ—Ç—ã —Å —Ç–∞–∫–∏–º –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –æ—á–∫–æ–≤
                    if team_stats:
                        potential_bots = ChampionshipTeam.objects.filter(
                            championship=championship,
                            points=team_stats.points,
                            team__is_bot=True
                        )
                        
                        self.stdout.write(f"\nFound {potential_bots.count()} potential bot matches:")
                        for bot_stats in potential_bots:
                            self.stdout.write(
                                f"- {bot_stats.team.name} "
                                f"(Points: {bot_stats.points}, "
                                f"Matches: {bot_stats.matches_played})"
                            )
                    
                    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± ID –±–æ—Ç–∞
                    bot_id = input("\nEnter the ID of the bot team to replace: ")
                    try:
                        bot_id = int(bot_id)
                        replaced_matches = update_matches_for_replaced_team(
                            championship=championship,
                            old_team_id=bot_id,
                            new_team=club
                        )
                        self.stdout.write(
                            self.style.SUCCESS(
                                f"Successfully updated {replaced_matches} matches "
                                f"for club {club.name}"
                            )
                        )
                    except ValueError:
                        self.stdout.write(self.style.ERROR("Invalid bot ID!"))
                else:
                    self.stdout.write(
                        self.style.SUCCESS(
                            f"Club {club.name} already has {team_matches} matches "
                            f"in championship {championship}"
                        )
                    )

        except Club.DoesNotExist:
            self.stdout.write(self.style.ERROR(f"Club with ID {club_id} not found"))
        except Championship.DoesNotExist:
            self.stdout.write(
                self.style.ERROR(
                    f"No active championship found for club {club.name} "
                    f"in country {club.country}"
                )
            )
        except Exception as e:
            self.stdout.write(self.style.ERROR(f"Error: {str(e)}"))

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\management\commands\update_club_matches.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\migrations\0001_initial.py ---

# Generated by Django 5.0.1 on 2024-12-07 04:02

import datetime
import django.db.models.deletion
import django_countries.fields
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('clubs', '0001_initial'),
        ('matches', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Championship',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('in_progress', 'In Progress'), ('finished', 'Finished')], default='pending', max_length=20)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('match_time', models.TimeField(default=datetime.time(18, 0), help_text='Match start time (UTC)')),
            ],
        ),
        migrations.CreateModel(
            name='Season',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('number', models.PositiveIntegerField(help_text='–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞', unique=True)),
                ('name', models.CharField(max_length=100)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField()),
                ('is_active', models.BooleanField(default=False)),
            ],
            options={
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='ChampionshipMatch',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('round', models.PositiveIntegerField()),
                ('match_day', models.PositiveIntegerField()),
                ('processed', models.BooleanField(default=False)),
                ('championship', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='tournaments.championship')),
                ('match', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, to='matches.match')),
            ],
            options={
                'ordering': ['round', 'match_day'],
            },
        ),
        migrations.CreateModel(
            name='ChampionshipTeam',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('points', models.PositiveIntegerField(default=0)),
                ('matches_played', models.PositiveIntegerField(default=0)),
                ('wins', models.PositiveIntegerField(default=0)),
                ('draws', models.PositiveIntegerField(default=0)),
                ('losses', models.PositiveIntegerField(default=0)),
                ('goals_for', models.PositiveIntegerField(default=0)),
                ('goals_against', models.PositiveIntegerField(default=0)),
                ('championship', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='tournaments.championship')),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='clubs.club')),
            ],
            options={
                'ordering': ['-points', '-goals_for'],
                'unique_together': {('championship', 'team')},
            },
        ),
        migrations.AddField(
            model_name='championship',
            name='teams',
            field=models.ManyToManyField(through='tournaments.ChampionshipTeam', to='clubs.club'),
        ),
        migrations.CreateModel(
            name='League',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('country', django_countries.fields.CountryField(max_length=2)),
                ('level', models.PositiveIntegerField()),
                ('max_teams', models.PositiveIntegerField(default=16)),
                ('foreign_players_limit', models.PositiveIntegerField(default=5, help_text='Maximum number of foreign players allowed in match squad')),
            ],
            options={
                'ordering': ['country', 'level'],
                'unique_together': {('country', 'level')},
            },
        ),
        migrations.AddField(
            model_name='championship',
            name='league',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='tournaments.league'),
        ),
        migrations.AddField(
            model_name='championship',
            name='season',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='tournaments.season'),
        ),
        migrations.AlterUniqueTogether(
            name='championship',
            unique_together={('season', 'league')},
        ),
    ]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\migrations\0001_initial.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\migrations\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\migrations\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\static\tournaments\js\calendar.js ---

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: calendarEvents,
        eventTimeFormat: {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false,
            meridiem: false
        },
        eventClick: function(info) {
            if (info.event.url) {
                window.location.href = info.event.url;
                info.jsEvent.preventDefault();
            }
        },
        eventDidMount: function(info) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø —Å –¥–µ—Ç–∞–ª—è–º–∏ –º–∞—Ç—á–∞
            const event = info.event;
            let tooltipContent = `${event.title}<br>`;
            if (event.extendedProps.status === 'finished') {
                tooltipContent += `Score: ${event.extendedProps.score}`;
            } else {
                tooltipContent += event.extendedProps.status;
            }
            
            new bootstrap.Tooltip(info.el, {
                title: tooltipContent,
                html: true,
                placement: 'top',
                customClass: 'match-tooltip'
            });
        }
    });

    calendar.render();
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
function updateMatchTimes(timezone) {
    document.querySelectorAll('.match-time').forEach(function(el) {
        const utcTime = moment.utc(el.dataset.utc);
        el.textContent = utcTime.tz(timezone).format('DD MMM HH:mm');
    });
    
    if (typeof calendar !== 'undefined') {
        calendar.setOption('timeZone', timezone);
        calendar.refetchEvents();
    }
}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\static\tournaments\js\calendar.js ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\base.html ---

{% extends 'core/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'championship_list' %}active{% endif %}" 
                           href="{% url 'tournaments:championship_list' %}">Championships</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'season_list' %}active{% endif %}" 
                           href="{% url 'tournaments:season_list' %}">Seasons</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'league_list' %}active{% endif %}" 
                           href="{% url 'tournaments:league_list' %}">Leagues</a>
                    </li>
                </ul>
                
                <div style="width: 200px;">
                    {% include 'tournaments/timezone_selector.html' %}
                </div>
            </div>
        </nav>
        
        {% block tournament_content %}{% endblock %}
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\base.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\championship_detail.html ---

{% extends 'tournaments/base.html' %}
{% load static %}

{% block tournament_content %}
<div class="row">
    <!-- Header Section - –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>{{ championship.league.name }}</h2>
                        <p class="text-muted mb-0">
                            {{ championship.league.country.name }} - Division {{ championship.league.level }}
                        </p>
                        <p class="text-muted">
                            Season: {{ championship.season.name }} | 
                            Status: {{ championship.get_status_display }} |
                            Match Time: <span id="match-time" utc-time="{{ championship.match_time|time:'H:i' }}"></span>
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#timezonesModal">
                            Change Timezone
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League Table -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">League Table</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Team</th>
                                <th>MP</th>
                                <th>W</th>
                                <th>D</th>
                                <th>L</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in standings %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <a href="{% url 'clubs:club_detail' team.team.id %}" class="text-decoration-none">
                                        {{ team.team.name }}
                                        {% if team.team.is_bot %}
                                            <small class="text-muted">(Bot)</small>
                                        {% endif %}
                                    </a>
                                </td>
                                <td>{{ team.matches_played }}</td>
                                <td>{{ team.wins }}</td>
                                <td>{{ team.draws }}</td>
                                <td>{{ team.losses }}</td>
                                <td>{{ team.goals_for }}</td>
                                <td>{{ team.goals_against }}</td>
                                <td>{% if team.goals_diff > 0 %}+{% endif %}{{ team.goals_diff }}</td>
                                <td><strong>{{ team.points }}</strong></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center">No teams in championship</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Matches Section -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">Matches</h3>
            </div>
            <div class="card-body">
                {% if matches %}
                    {% regroup matches by round as round_list %}
                    {% for round in round_list %}
                    <div class="mb-4">
                        <h4 class="h6">Round {{ round.grouper }}</h4>
                        <div class="list-group">
                            {% for match in round.list %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small>{{ match.match.date }}</small>
                                    <span class="badge {% if match.match.status == 'finished' %}bg-success{% elif match.match.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ match.match.get_status_display }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <a href="{% url 'clubs:club_detail' match.match.home_team.id %}" class="text-decoration-none">
                                        {{ match.match.home_team.name }}
                                        {% if match.match.home_team.is_bot %}
                                            <small>(Bot)</small>
                                        {% endif %}
                                    </a>
                                    {% if match.match.status == 'finished' %}
                                        <strong>{{ match.match.home_score }} - {{ match.match.away_score }}</strong>
                                    {% else %}
                                        <span>vs</span>
                                    {% endif %}
                                    <a href="{% url 'clubs:club_detail' match.match.away_team.id %}" class="text-decoration-none">
                                        {{ match.match.away_team.name }}
                                        {% if match.match.away_team.is_bot %}
                                            <small>(Bot)</small>
                                        {% endif %}
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center">No matches scheduled</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Timezone Modal -->
<div class="modal fade timezone-modal" id="timezonesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Timezone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% include 'tournaments/timezone_selector.html' %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\championship_detail.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\championship_list.html ---

{% extends 'tournaments/base.html' %}

{% block tournament_content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Championships</h2>

        {% if active_seasons %}
        <div class="mb-5">
            <h3>Active Seasons</h3>
            {% for season in active_seasons %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">{{ season.name }}</h4>
                </div>
                <div class="card-body">
                    {% regroup championships|dictsort:"league.country" by league.country as country_list %}
                    {% for country in country_list %}
                    {% if country.list|length > 0 %}
                    <h5 class="mt-3">{{ country.grouper }}</h5>
                    <div class="row">
                        {% for championship in country.list %}
                        {% if championship.season == season %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">{{ championship.league.name }}</h5>
                                    <p class="text-muted small">Division {{ championship.league.level }}</p>
                                    <p class="card-text">
                                        Status: {{ championship.get_status_display }}<br>
                                        Teams: {{ championship.teams.count }}/{{ championship.league.max_teams }}
                                    </p>
                                    {% if championship.teams.count > 0 %}
                                    <small class="text-muted">Participating teams:</small>
                                    <div class="mt-2 small">
                                        {% for team in championship.teams.all|slice:":5" %}
                                        <a href="{% url 'clubs:club_detail' team.id %}" class="text-decoration-none">
                                            {{ team.name }}{% if not forloop.last %}, {% endif %}
                                        </a>
                                        {% endfor %}
                                        {% if championship.teams.count > 5 %}
                                        <span class="text-muted">and {{ championship.teams.count|add:"-5" }} more...</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer bg-transparent">
                                    <a href="{% url 'tournaments:championship_detail' championship.pk %}" 
                                       class="btn btn-primary btn-sm">View Details</a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="mb-4">
            <h3>All Championships</h3>
            {% regroup championships|dictsort:"league.country.name" by league.country.name as country_list %}
            {% for country in country_list %}
            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">{{ country.grouper }}</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for championship in country.list %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">{{ championship.league.name }}</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">{{ championship.season.name }}</h6>
                                    <p class="small">Division {{ championship.league.level }}</p>
                                    <p class="card-text">
                                        Status: {{ championship.get_status_display }}<br>
                                        Teams: {{ championship.teams.count }}/{{ championship.league.max_teams }}
                                    </p>
                                    {% if championship.teams.count > 0 %}
                                    <small class="text-muted">Teams:</small>
                                    <div class="mt-2 small">
                                        {% for team in championship.teams.all|slice:":5" %}
                                        <a href="{% url 'clubs:club_detail' team.id %}" class="text-decoration-none">
                                            {{ team.name }}{% if not forloop.last %}, {% endif %}
                                        </a>
                                        {% endfor %}
                                        {% if championship.teams.count > 5 %}
                                        <span class="text-muted">and {{ championship.teams.count|add:"-5" }} more...</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="card-footer bg-transparent">
                                    <a href="{% url 'tournaments:championship_detail' championship.pk %}" 
                                       class="btn btn-primary btn-sm">View Details</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info">
                No championships available.
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\championship_list.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\league_list.html ---

{% extends 'tournaments/base.html' %}
{% block tournament_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Leagues</h2>
            {% if user.is_staff %}
            <a href="{% url 'admin:tournaments_league_add' %}" class="btn btn-primary">
                Create New League
            </a>
            {% endif %}
        </div>

        {% for country, leagues in countries.items %}
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="h5 mb-0">{{ country.name }}</h3>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for league in leagues %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h4 class="h5 card-title">{{ league.name }}</h4>
                                <p class="text-muted small mb-3">Division {{ league.level }}</p>
                                
                                <div class="mb-3">
                                    <strong>League Info:</strong>
                                    <ul class="list-unstyled mt-2">
                                        <li><i class="bi bi-people"></i> Teams: {{ league.clubs.count }}/{{ league.max_teams }}</li>
                                        <li><i class="bi bi-globe"></i> Foreign Players Limit: {{ league.foreign_players_limit }}</li>
                                        {% with championship_count=league.championship_set.count %}
                                        <li><i class="bi bi-trophy"></i> Championships: {{ championship_count }}</li>
                                        {% endwith %}
                                    </ul>
                                </div>

                                {% if league.clubs.exists %}
                                <div class="mb-3">
                                    <strong>Current Teams:</strong>
                                    <div class="mt-2 small">
                                        {% for club in league.clubs.all|slice:":5" %}
                                        <a href="{% url 'clubs:club_detail' club.id %}" class="text-decoration-none">
                                            {{ club.name }}
                                            {% if club.is_bot %}<small>(Bot)</small>{% endif %}
                                            {% if not forloop.last %}, {% endif %}
                                        </a>
                                        {% endfor %}
                                        {% if league.clubs.count > 5 %}
                                        <span class="text-muted">and {{ league.clubs.count|add:"-5" }} more...</span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}

                                {% if league.championship_set.exists %}
                                <div class="mb-3">
                                    <strong>Current Season:</strong>
                                    {% with current_championship=league.championship_set.filter.first %}
                                    <p class="small mt-2 mb-0">
                                        {{ current_championship.season.name }}
                                        ({{ current_championship.get_status_display }})
                                    </p>
                                    {% endwith %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-transparent">
                                <div class="btn-group w-100">
                                    {% if league.championship_set.exists %}
                                    <a href="{% url 'tournaments:championship_detail' league.championship_set.first.id %}" 
                                       class="btn btn-outline-primary">View Current Season</a>
                                    {% endif %}
                                    {% if user.is_staff %}
                                    <a href="{% url 'admin:tournaments_league_change' league.id %}" 
                                       class="btn btn-outline-secondary">Edit</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info">
            No leagues available yet.
            {% if user.is_staff %}
            <a href="{% url 'admin:tournaments_league_add' %}" class="alert-link">Create one</a>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\league_list.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\my_championship.html ---

{% extends 'tournaments/base.html' %}

{% block tournament_content %}
<div class="row">
    <!-- Header Section -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2>{{ championship.league.name }}</h2>
                        <p class="text-muted mb-0">
                            {{ championship.league.country.name }} - Division {{ championship.league.level }}
                        </p>
                        <p class="text-muted">
                            Season: {{ championship.season.name }} | 
                            Status: {{ championship.get_status_display }}
                        </p>
                    </div>
                    <div>
                        <a href="{% url 'tournaments:championship_list' %}" class="btn btn-outline-primary">
                            View All Championships
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- League Table -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">League Table</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Team</th>
                                <th>MP</th>
                                <th>W</th>
                                <th>D</th>
                                <th>L</th>
                                <th>GF</th>
                                <th>GA</th>
                                <th>GD</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in standings %}
                            <tr {% if team.team == user.club %}class="table-active"{% endif %}>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    {{ team.team.name }}
                                    {% if team.team == user.club %}
                                        <span class="badge bg-primary">Your Club</span>
                                    {% endif %}
                                </td>
                                <td>{{ team.matches_played }}</td>
                                <td>{{ team.wins }}</td>
                                <td>{{ team.draws }}</td>
                                <td>{{ team.losses }}</td>
                                <td>{{ team.goals_for }}</td>
                                <td>{{ team.goals_against }}</td>
                                <td>{% if team.goals_difference > 0 %}+{% endif %}{{ team.goals_difference }}</td>
                                <td><strong>{{ team.points }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Matches -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title h5 mb-0">Your Team's Matches</h3>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for match in team_matches %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <small>
                                Round {{ match.round }} | 
                                <a href="{% url 'matches:match_detail' match.match.id %}">
                                    {{ match.match.datetime|date:"d M H:i" }}
                                </a>
                            </small>
                            <span class="badge {% if match.match.status == 'finished' %}bg-success{% elif match.match.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                {{ match.match.get_status_display }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span {% if match.match.home_team == user.club %}class="fw-bold"{% endif %}>
                                {{ match.match.home_team.name }}
                            </span>
                            {% if match.match.status == 'finished' %}
                                <strong>{{ match.match.home_score }} - {{ match.match.away_score }}</strong>
                            {% else %}
                                <span>vs</span>
                            {% endif %}
                            <span {% if match.match.away_team == user.club %}class="fw-bold"{% endif %}>
                                {{ match.match.away_team.name }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="alert alert-warning">
                        No matches found for your team.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\my_championship.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\season_list.html ---

{% extends 'tournaments/base.html' %}
{% block tournament_content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Seasons</h2>
            {% if user.is_staff %}
            <a href="{% url 'admin:tournaments_season_add' %}" class="btn btn-primary">
                Create New Season
            </a>
            {% endif %}
        </div>

        <div class="row">
            {% for season in seasons %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            {{ season.name }}
                            {% if season.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Season Info:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><i class="bi bi-calendar"></i> Start Date: {{ season.start_date }}</li>
                                <li><i class="bi bi-calendar"></i> End Date: {{ season.end_date }}</li>
                                {% with championship_count=season.championship_set.count %}
                                <li><i class="bi bi-trophy"></i> Championships: {{ championship_count }}</li>
                                {% endwith %}
                            </ul>
                        </div>

                        {% if season.championship_set.exists %}
                        <div class="mb-3">
                            <strong>Active Championships:</strong>
                            <div class="list-group mt-2">
                                {% for championship in season.championship_set.all %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ championship.league.name }}</strong>
                                            <small class="text-muted">(Division {{ championship.league.level }})</small>
                                        </div>
                                        <a href="{% url 'tournaments:championship_detail' championship.id %}" 
                                           class="btn btn-sm btn-outline-primary">View</a>
                                    </div>
                                    {% if championship.teams.exists %}
                                    <div class="small mt-2">
                                        <strong>Teams:</strong>
                                        {% for team in championship.teams.all|slice:":3" %}
                                        <a href="{% url 'clubs:club_detail' team.id %}" class="text-decoration-none">
                                            {{ team.name }}{% if not forloop.last %}, {% endif %}
                                        </a>
                                        {% endfor %}
                                        {% if championship.teams.count > 3 %}
                                        <span class="text-muted">and {{ championship.teams.count|add:"-3" }} more...</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100">
                            {% if user.is_staff %}
                            <a href="{% url 'admin:tournaments_season_change' season.id %}" 
                               class="btn btn-outline-secondary">Edit</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info">
                    No seasons available yet.
                    {% if user.is_staff %}
                    <a href="{% url 'admin:tournaments_season_add' %}" class="alert-link">Create one</a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\season_list.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\timezone_selector.html ---

<form method="post" action="{% url 'tournaments:set_timezone' %}" class="timezone-form">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.path }}">
    <select name="timezone" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for tz, name in TOURNAMENT_TIMEZONES %}
            <option value="{{ tz }}" {% if tz == user_timezone %}selected{% endif %}>
                {{ name }}
            </option>
        {% endfor %}
    </select>
</form>

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\templates\tournaments\timezone_selector.html ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\test_championships.py ---

# tournaments/tests/test_championships.py
from django.test import TestCase
from django.utils import timezone
from datetime import datetime, timedelta
from django.core.exceptions import ValidationError
from django_countries import countries
from tournaments.models import Season, League, Championship, ChampionshipTeam
from tournaments.utils import generate_league_schedule, create_championship_matches, validate_championship_schedule
from clubs.models import Club

class ChampionshipSystemTests(TestCase):
    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        # –°–æ–∑–¥–∞–µ–º —Å–µ–∑–æ–Ω
        self.season = Season.objects.create(
            name="–°–µ–∑–æ–Ω 1",
            number=1,  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ number
            start_date=datetime(2024, 3, 1).date(),
            end_date=datetime(2024, 3, 30).date(),
            is_active=True
        )

        # –°–æ–∑–¥–∞–µ–º –ª–∏–≥—É
        self.league = League.objects.create(
            name="Test League",
            country='GB',  # –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è
            level=1,
            max_teams=16
        )

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—É–±—ã
        self.clubs = []
        for i in range(16):
            club = Club.objects.create(
                name=f"Test Club {i+1}",
                country='GB',
                is_bot=True
            )
            self.clubs.append(club)

        # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç
        self.championship = Championship.objects.create(
            season=self.season,
            league=self.league,
            status='pending',
            start_date=self.season.start_date,
            end_date=self.season.end_date
        )

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
        for club in self.clubs:
            ChampionshipTeam.objects.create(
                championship=self.championship,
                team=club
            )

    def test_schedule_generation_basic(self):
        """–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
        schedule = generate_league_schedule(self.championship)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π
        # 16 –∫–æ–º–∞–Ω–¥, –∫–∞–∂–¥–∞—è –∏–≥—Ä–∞–µ—Ç —Å –∫–∞–∂–¥–æ–π –¥–≤–∞–∂–¥—ã = 16 * 15 = 240 –º–∞—Ç—á–µ–π
        self.assertEqual(len(schedule), 240, 
                        "–ù–µ–≤–µ—Ä–Ω–æ–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—É—Ä–æ–≤
        rounds = {match[0] for match in schedule}
        self.assertEqual(len(rounds), 30, 
                        "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 30 —Ç—É—Ä–æ–≤")

    def test_home_away_balance(self):
        """–¢–µ—Å—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–æ–º–∞—à–Ω–∏—Ö/–≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π"""
        schedule = generate_league_schedule(self.championship)
        
        # –ü–æ–¥—Å—á–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∏ –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        home_games = {club: 0 for club in self.clubs}
        away_games = {club: 0 for club in self.clubs}
        
        for round_num, day, home, away in schedule:
            home_games[home] += 1
            away_games[away] += 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        for club in self.clubs:
            self.assertEqual(home_games[club], 15, 
                           f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {home_games[club]} –¥–æ–º–∞—à–Ω–∏—Ö –º–∞—Ç—á–µ–π –≤–º–µ—Å—Ç–æ 15")
            self.assertEqual(away_games[club], 15, 
                           f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {away_games[club]} –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –≤–º–µ—Å—Ç–æ 15")

    def test_consecutive_matches(self):
        """–¢–µ—Å—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ/–≤—ã–µ–∑–¥–Ω—ã–µ –º–∞—Ç—á–∏"""
        schedule = generate_league_schedule(self.championship)
        
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        team_schedules = {club: [] for club in self.clubs}
        for round_num, day, home, away in sorted(schedule):
            team_schedules[home].append(('home', round_num))
            team_schedules[away].append(('away', round_num))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É
        for club, matches in team_schedules.items():
            matches.sort(key=lambda x: x[1])  # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —Ç—É—Ä–∞
            
            consecutive_home = 0
            consecutive_away = 0
            max_consecutive_home = 0
            max_consecutive_away = 0
            
            for match_type, _ in matches:
                if match_type == 'home':
                    consecutive_home += 1
                    consecutive_away = 0
                    max_consecutive_home = max(max_consecutive_home, consecutive_home)
                else:
                    consecutive_away += 1
                    consecutive_home = 0
                    max_consecutive_away = max(max_consecutive_away, consecutive_away)
                
            self.assertLess(max_consecutive_home, 3,
                          f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {max_consecutive_home} –¥–æ–º–∞—à–Ω–∏—Ö –º–∞—Ç—á–µ–π –ø–æ–¥—Ä—è–¥")
            self.assertLess(max_consecutive_away, 3,
                          f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {max_consecutive_away} –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –ø–æ–¥—Ä—è–¥")

    def test_all_matches_in_round_same_time(self):
        """–¢–µ—Å—Ç, —á—Ç–æ –≤—Å–µ –º–∞—Ç—á–∏ —Ç—É—Ä–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ –æ–¥–Ω–æ –≤—Ä–µ–º—è"""
        create_championship_matches(self.championship)
        
        matches = self.championship.championshipmatch_set.all()
        rounds = matches.values('round').distinct()
        
        for round_data in rounds:
            round_num = round_data['round']
            round_matches = matches.filter(round=round_num)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –º–∞—Ç—á–µ–π –≤ —ç—Ç–æ–º —Ç—É—Ä–µ
            match_times = set()
            for match in round_matches:
                match_times.add(match.match.date)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–∞—Ç—á–∏ –≤ –æ–¥–Ω–æ –≤—Ä–µ–º—è
            self.assertEqual(len(match_times), 1,
                           f"–ú–∞—Ç—á–∏ —Ç—É—Ä–∞ {round_num} –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è")

    def test_regular_season_schedule(self):
        """–¢–µ—Å—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞"""
        create_championship_matches(self.championship)
        
        matches = self.championship.championshipmatch_set.all()
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ–≤–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç—É—Ä
        match_dates = matches.values_list('match__date__date', flat=True).distinct()
        self.assertEqual(len(match_dates), 30, 
                        "–î–æ–ª–∂–Ω–æ –±—ã—Ç—å 30 –∏–≥—Ä–æ–≤—ã—Ö –¥–Ω–µ–π –¥–ª—è 30 —Ç—É—Ä–æ–≤")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –º–∞—Ç—á–µ–π
        for match_date in match_dates:
            date_matches = matches.filter(match__date__date=match_date)
            match_times = set(date_matches.values_list('match__date__hour', flat=True))
            self.assertEqual(len(match_times), 1,
                           f"–í –æ–±—ã—á–Ω—ã–π –¥–µ–Ω—å {match_date} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç—É—Ä")
            self.assertEqual(list(match_times)[0], 18,
                           "–í—Å–µ –º–∞—Ç—á–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –≤ 18:00")

   # –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ñ–∞–π–ª–µ
def test_february_schedule(self):
    """–¢–µ—Å—Ç –¥–ª—è —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
    # –°–æ–∑–¥–∞–µ–º —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–∏–π —Å–µ–∑–æ–Ω
    february_season = Season.objects.create(
        name="–°–µ–∑–æ–Ω 2",
        number=2,
        start_date=datetime(2024, 2, 1).date(),
        end_date=datetime(2024, 2, 28).date(),
        is_active=False
    )
    
    february_championship = Championship.objects.create(
        season=february_season,
        league=self.league,
        status='pending',
        start_date=february_season.start_date,
        end_date=february_season.end_date
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ –∂–µ –∫–æ–º–∞–Ω–¥—ã
    for club in self.clubs:
        ChampionshipTeam.objects.create(
            championship=february_championship,
            team=club
        )
    
    create_championship_matches(february_championship)
    matches = february_championship.championshipmatch_set.all()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –æ–±—ã—á–Ω—ã–µ –¥–Ω–∏ –≤—Å–µ –º–∞—Ç—á–∏ —Ç—É—Ä–∞ –≤ 18:00
    for day in range(1, 29):
        if day not in [15, 16]:  # –ù–µ –¥–≤–æ–π–Ω—ã–µ —Ç—É—Ä—ã
            date_matches = matches.filter(
                match__date__date=datetime(2024, 2, day).date()
            )
            if date_matches.exists():
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                match_hours = set(date_matches.values_list(
                    'match__date__hour', flat=True
                ))
                self.assertEqual(match_hours, {18},
                               f"–ú–∞—Ç—á–∏ –≤ –¥–µ–Ω—å {day} —Ñ–µ–≤—Ä–∞–ª—è –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –≤ 18:00")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–≤–æ–π–Ω—ã–µ —Ç—É—Ä—ã (15 –∏ 16 —Ñ–µ–≤—Ä–∞–ª—è)
    for day in [15, 16]:
        date_matches = matches.filter(
            match__date__date=datetime(2024, 2, day).date()
        )
        match_hours = set(date_matches.values_list(
            'match__date__hour', flat=True
        ))
        self.assertEqual(match_hours, {18, 20},
                       f"–í –¥–≤–æ–π–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –¥–µ–Ω—å {day} —Ñ–µ–≤—Ä–∞–ª—è –º–∞—Ç—á–∏ –¥–æ–ª–∂–Ω—ã –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è –≤ 18:00 –∏ 20:00")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\test_championships.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\test_season_transitions.py ---

from django.test import TestCase
from django.utils import timezone
from django.core.management import call_command
from tournaments.models import Season, League, Championship, ChampionshipTeam
from tournaments.tasks import check_season_end
from clubs.models import Club
from datetime import timedelta
from django.db import transaction

class SeasonTransitionTests(TestCase):
    def setUp(self):
        """
        –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
        –°–æ–∑–¥–∞—ë–º —Å–µ–∑–æ–Ω, –ª–∏–≥–∏, –∫–æ–º–∞–Ω–¥—ã –∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã
        """
        # –°–æ–∑–¥–∞–µ–º —Å–µ–∑–æ–Ω
        self.season = Season.objects.create(
            number=1,
            name="Test Season",
            start_date=timezone.now().date(),
            end_date=timezone.now().date() + timedelta(days=30),
            is_active=True
        )

        # –°–æ–∑–¥–∞–µ–º –¥–≤–µ –ª–∏–≥–∏ –¥–ª—è –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω—ã
        self.league_div1 = League.objects.create(
            name="Test League D1",
            country='GB',
            level=1,
            max_teams=16
        )
        
        self.league_div2 = League.objects.create(
            name="Test League D2",
            country='GB',
            level=2,
            max_teams=16
        )

        # –°–æ–∑–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –æ–±–æ–∏—Ö –¥–∏–≤–∏–∑–∏–æ–Ω–æ–≤
        self.div1_teams = []
        self.div2_teams = []

        with transaction.atomic():
            # –°–æ–∑–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–≤–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
            for i in range(16):
                team = Club.objects.create(
                    name=f"D1 Team {i+1}",
                    country='GB',
                    league=self.league_div1,
                    is_bot=True
                )
                self.div1_teams.append(team)

            # –°–æ–∑–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—ã –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
            for i in range(16):
                team = Club.objects.create(
                    name=f"D2 Team {i+1}",
                    country='GB',
                    league=self.league_div2,
                    is_bot=True
                )
                self.div2_teams.append(team)

            # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã
            self.championship_div1 = Championship.objects.create(
                season=self.season,
                league=self.league_div1,
                status='in_progress',
                start_date=self.season.start_date,
                end_date=self.season.end_date
            )

            self.championship_div2 = Championship.objects.create(
                season=self.season,
                league=self.league_div2,
                status='in_progress',
                start_date=self.season.start_date,
                end_date=self.season.end_date
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
            for team in self.div1_teams:
                self.championship_div1.teams.add(team)
                ChampionshipTeam.objects.filter(
                    championship=self.championship_div1,
                    team=team
                ).update(
                    points=0,
                    matches_played=0,
                    wins=0,
                    draws=0,
                    losses=0,
                    goals_for=0,
                    goals_against=0
                )

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
            for team in self.div2_teams:
                self.championship_div2.teams.add(team)
                ChampionshipTeam.objects.filter(
                    championship=self.championship_div2,
                    team=team
                ).update(
                    points=0,
                    matches_played=0,
                    wins=0,
                    draws=0,
                    losses=0,
                    goals_for=0,
                    goals_against=0
                )

    def test_season_transitions(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏"""
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥ –ø–µ—Ä–≤–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
        div1_teams = ChampionshipTeam.objects.filter(
            championship=self.championship_div1
        )
        for i, team_stats in enumerate(div1_teams):
            team_stats.points = 80 - i * 5  # –û—Ç 80 –¥–æ 5 –æ—á–∫–æ–≤
            team_stats.matches_played = 30
            team_stats.save()

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–æ–º–∞–Ω–¥ –≤—Ç–æ—Ä–æ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
        div2_teams = ChampionshipTeam.objects.filter(
            championship=self.championship_div2
        )
        for i, team_stats in enumerate(div2_teams):
            team_stats.points = 80 - i * 5  # –û—Ç 80 –¥–æ 5 –æ—á–∫–æ–≤
            team_stats.matches_played = 30
            team_stats.save()

        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–µ–∑–æ–Ω –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã
        self.season.end_date = timezone.now().date() - timedelta(days=1)
        self.season.save()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        call_command('handle_season_transitions')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–≤–µ —Ö—É–¥—à–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ D1 –ø–µ—Ä–µ—à–ª–∏ –≤ D2
        relegated_teams = div1_teams.order_by('points')[:2]
        for team_stats in relegated_teams:
            team = Club.objects.get(id=team_stats.team.id)
            self.assertEqual(
                team.league, 
                self.league_div2,
                f"Team {team.name} should be relegated to D2"
            )

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–≤–µ –ª—É—á—à–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ D2 –ø–µ—Ä–µ—à–ª–∏ –≤ D1
        promoted_teams = div2_teams.order_by('-points')[:2]
        for team_stats in promoted_teams:
            team = Club.objects.get(id=team_stats.team.id)
            self.assertEqual(
                team.league, 
                self.league_div1,
                f"Team {team.name} should be promoted to D1"
            )

    def test_new_season_creation(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤"""
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω
        self.season.end_date = timezone.now().date() - timedelta(days=1)
        self.season.save()
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ–∑–æ–Ω–∞
        call_command('create_new_season')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω —Å–æ–∑–¥–∞–Ω
        new_season = Season.objects.get(number=self.season.number + 1)
        self.assertTrue(new_season.is_active)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–Ω—ã —á–µ–º–ø–∏–æ–Ω–∞—Ç—ã
        new_championships = Championship.objects.filter(season=new_season)
        self.assertEqual(new_championships.count(), 2)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
        for championship in new_championships:
            self.assertEqual(
                championship.teams.count(), 
                16,
                f"Championship {championship} should have 16 teams"
            )

    def test_full_transition_process(self):
        """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –Ω–æ–≤–æ–º—É —Å–µ–∑–æ–Ω—É"""
        
        # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω
        self.season.end_date = timezone.now().date() - timedelta(days=1)
        self.season.save()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ–∑–æ–Ω–∞ —á–µ—Ä–µ–∑ Celery –∑–∞–¥–∞—á—É
        check_season_end()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å—Ç–∞—Ä—ã–π —Å–µ–∑–æ–Ω –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω
        old_season = Season.objects.get(id=self.season.id)
        self.assertFalse(old_season.is_active)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω
        new_season = Season.objects.get(is_active=True)
        self.assertNotEqual(new_season.id, self.season.id)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        # –í –ø–µ—Ä–≤–æ–º –¥–∏–≤–∏–∑–∏–æ–Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è 14 —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥ + 2 –Ω–æ–≤—ã—Ö
        div1_championship = Championship.objects.get(
            season=new_season,
            league=self.league_div1
        )
        self.assertEqual(div1_championship.teams.count(), 16)

        # –í–æ –≤—Ç–æ—Ä–æ–º –¥–∏–≤–∏–∑–∏–æ–Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è 14 —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–∞–Ω–¥ + 2 –Ω–æ–≤—ã—Ö
        div2_championship = Championship.objects.get(
            season=new_season,
            league=self.league_div2
        )
        self.assertEqual(div2_championship.teams.count(), 16)

    def tearDown(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–æ–≤"""
        Season.objects.all().delete()
        League.objects.all().delete()
        Club.objects.all().delete()

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\test_season_transitions.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\admin.py ---

from django.contrib import admin
from django.core.management import call_command
from django.contrib import messages
from .models import Season, League, Championship, ChampionshipTeam, ChampionshipMatch

@admin.register(Season)
class SeasonAdmin(admin.ModelAdmin):
    list_display = ('number', 'name', 'start_date', 'end_date', 'is_active')
    list_filter = ('is_active',)
    search_fields = ('name',)
    ordering = ('-start_date',)
    actions = ['end_season', 'force_end_season']

    def end_season(self, request, queryset):
        if queryset.count() > 1:
            messages.error(request, "Can only end one season at a time.")
            return
        
        season = queryset.first()
        if not season.is_active:
            messages.error(request, "Can only end active season.")
            return

        try:
            call_command('end_season')
            messages.success(request, f"Successfully ended season {season.number}")
        except Exception as e:
            messages.error(request, f"Error ending season: {str(e)}")
    
    end_season.short_description = "End selected season"

    def force_end_season(self, request, queryset):
        if queryset.count() > 1:
            messages.error(request, "Can only end one season at a time.")
            return
        
        season = queryset.first()
        if not season.is_active:
            messages.error(request, "Can only end active season.")
            return

        try:
            call_command('end_season', '--force')
            messages.success(
                request, 
                f"Successfully force ended season {season.number}"
            )
        except Exception as e:
            messages.error(request, f"Error force ending season: {str(e)}")
    
    force_end_season.short_description = "Force end selected season (skip validations)"

@admin.register(League)
class LeagueAdmin(admin.ModelAdmin):
    list_display = ('name', 'country', 'level', 'max_teams')
    list_filter = ('country', 'level')
    search_fields = ('name',)
    ordering = ['country', 'level']

class ChampionshipTeamInline(admin.TabularInline):
    model = ChampionshipTeam
    extra = 0
    fields = (
        'team', 'points', 'matches_played', 
        'wins', 'draws', 'losses', 
        'goals_for', 'goals_against', 'goals_difference'
    )
    readonly_fields = (
        'points', 'matches_played', 
        'wins', 'draws', 'losses', 
        'goals_for', 'goals_against', 'goals_difference'
    )
    ordering = ('-points', '-goals_for')
    can_delete = False

    def has_add_permission(self, request, obj=None):
        return False

class ChampionshipMatchInline(admin.TabularInline):
    model = ChampionshipMatch
    extra = 0
    fields = ('match', 'round', 'match_day', 'processed')
    readonly_fields = ('processed',)

@admin.register(Championship)
class ChampionshipAdmin(admin.ModelAdmin):
    list_display = (
        'league', 'season', 'status', 'start_date', 
        'end_date', 'total_matches', 'finished_matches'
    )
    list_filter = ('status', 'season', 'league')
    search_fields = ('league__name', 'season__name')
    inlines = [ChampionshipTeamInline, ChampionshipMatchInline]
    
    def get_readonly_fields(self, request, obj=None):
        if obj and obj.status != 'pending':
            return ['season', 'league', 'start_date']
        return []

    def total_matches(self, obj):
        return obj.championshipmatch_set.count()
    total_matches.short_description = "Total Matches"

    def finished_matches(self, obj):
        return obj.championshipmatch_set.filter(
            match__status='finished'
        ).count()
    finished_matches.short_description = "Finished Matches"

@admin.register(ChampionshipTeam)
class ChampionshipTeamAdmin(admin.ModelAdmin):
    list_display = (
        'team', 'championship', 'points', 
        'matches_played', 'wins', 'draws', 
        'losses', 'goals_for', 'goals_against', 
        'goals_difference'
    )
    list_filter = ('championship',)
    search_fields = ('team__name', 'championship__league__name')
    readonly_fields = (
        'points', 'matches_played', 'wins', 
        'draws', 'losses', 'goals_for', 
        'goals_against', 'goals_difference'
    )
    ordering = ('-points', '-goals_for')

@admin.register(ChampionshipMatch)
class ChampionshipMatchAdmin(admin.ModelAdmin):
    list_display = (
        'match', 'championship', 'round', 
        'match_day', 'status', 'score'
    )
    list_filter = ('championship', 'round', 'match__status')
    search_fields = (
        'match__home_team__name', 
        'match__away_team__name'
    )
    readonly_fields = ('processed',)

    def status(self, obj):
        return obj.match.get_status_display()
    status.short_description = "Status"

    def score(self, obj):
        if obj.match.status == 'finished':
            return f"{obj.match.home_score} - {obj.match.away_score}"
        return "-"
    score.short_description = "Score"

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\admin.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\apps.py ---

from django.apps import AppConfig

class TournamentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'tournaments'
    verbose_name = 'Tournaments Management'

    def ready(self):
        import tournaments.signals

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\apps.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\context_processors.py ---

from django.conf import settings

def timezone_context(request):
    return {
        'TOURNAMENT_TIMEZONES': settings.TOURNAMENT_TIMEZONES,
        'user_timezone': request.session.get('django_timezone', 'UTC')
    }

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\context_processors.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\date_utils.py ---

import calendar
from datetime import date
from django.utils import timezone

def get_next_season_dates():
    """
    –í—ã—á–∏—Å–ª—è–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –∫–∞–∂–¥–æ–º –º–µ—Å—è—Ü–µ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (start_date, end_date).
    """
    today = timezone.now().date()
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ —Å–µ–∑–æ–Ω–∞ - –ø–µ—Ä–≤–æ–µ —á–∏—Å–ª–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    if today.day != 1:
        year = today.year
        month = today.month
        if month == 12:
            month = 1
            year += 1
        else:
            month += 1
        start_date = date(year, month, 1)
    else:
        # –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è 1 —á–∏—Å–ª–æ, –Ω–∞—á–∏–Ω–∞–µ–º —Å–µ–∑–æ–Ω —Å–µ–≥–æ–¥–Ω—è
        start_date = today

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É—è calendar.monthrange
    _, last_day = calendar.monthrange(start_date.year, start_date.month)
    end_date = start_date.replace(day=last_day)
    
    return start_date, end_date

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\date_utils.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\middleware.py ---

# tournaments/middleware.py
from django.utils import timezone
from datetime import timedelta
from matches.models import Match
from matches.match_simulation import simulate_match
import logging

logger = logging.getLogger('matches')

class MatchSimulationMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response
        self.last_check = timezone.now()
        self.check_interval = timedelta(seconds=10)  # –£–º–µ–Ω—å—à–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        logger.info("Match simulation middleware initialized")

    def __call__(self, request):
        now = timezone.now()
        
        # –î–æ–±–∞–≤–∏–º –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logger.info(f"Checking matches at {now}")
        logger.info(f"Last check was at {self.last_check}")
        
        if now - self.last_check >= self.check_interval:
            logger.info("Starting match check...")
            self.check_matches()
            self.last_check = now
            
        return self.get_response(request)

    def check_matches(self):
        now = timezone.now()
        matches = Match.objects.filter(
            status='scheduled',
            date__lte=now
        ).select_related('home_team', 'away_team')

        logger.info(f"Found {matches.count()} matches to check")
        
        for match in matches:
            try:
                logger.info(f"Simulating match: {match.home_team} vs {match.away_team}")
                simulate_match(match.id)
                
                # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ç—á –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                match.refresh_from_db()
                logger.info(
                    f"Match simulated: {match.home_team} {match.home_score} - {match.away_score} {match.away_team}"
                )
            except Exception as e:
                logger.error(f"Error simulating match {match.id}: {str(e)}")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\middleware.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\models.py ---

from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone
from django_countries.fields import CountryField
from clubs.models import Club
from matches.models import Match
from datetime import datetime, timedelta, time
import pytz
import calendar
from .date_utils import get_next_season_dates  # –ò–∑–º–µ–Ω–µ–Ω –∏–º–ø–æ—Ä—Ç

class Season(models.Model):
    """Model for representing a game season"""
    number = models.PositiveIntegerField(
        unique=True, 
        help_text="–ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å–µ–∑–æ–Ω–∞"
    )
    name = models.CharField(max_length=100)
    start_date = models.DateField()
    end_date = models.DateField()
    is_active = models.BooleanField(default=False)

    class Meta:
        ordering = ['-start_date']

    def __str__(self):
        return f"–°–µ–∑–æ–Ω {self.number} ({self.start_date.strftime('%B %Y')})"

    def clean(self):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞—Ç —Å–µ–∑–æ–Ω–∞"""
        if not self.start_date:
            return

        if self.start_date.day != 1:
            raise ValidationError({
                'start_date': '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–µ–∑–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–≤—ã–º —á–∏—Å–ª–æ–º –º–µ—Å—è—Ü–∞'
            })

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞ –∏—Å–ø–æ–ª—å–∑—É—è calendar.monthrange
        _, last_day = calendar.monthrange(self.start_date.year, self.start_date.month)
        expected_end_date = self.start_date.replace(day=last_day)
        
        if self.end_date != expected_end_date:
            raise ValidationError({
                'end_date': f'–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–µ–∑–æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å {last_day}-–º —á–∏—Å–ª–æ–º –º–µ—Å—è—Ü–∞'
            })

    @property
    def is_february(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–∏–º"""
        return self.start_date.month == 2

    @property
    def needs_double_matchday(self) -> bool:
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω—ã –ª–∏ –¥–≤–æ–π–Ω—ã–µ —Ç—É—Ä—ã –≤ —ç—Ç–æ–º —Å–µ–∑–æ–Ω–µ"""
        return self.is_february and calendar.monthrange(self.start_date.year, 2)[1] == 28

    def get_double_matchday_dates(self) -> list:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—ã –¥–ª—è –¥–≤–æ–π–Ω—ã—Ö —Ç—É—Ä–æ–≤"""
        if not self.needs_double_matchday:
            return []
        
        dates = [self.start_date.replace(day=15)]
        if self.end_date.day == 28:  # –î–ª—è –Ω–µ–≤–∏—Å–æ–∫–æ—Å–Ω–æ–≥–æ —Ñ–µ–≤—Ä–∞–ª—è
            dates.append(self.start_date.replace(day=16))
        return dates

    def save(self, *args, **kwargs):
        if not self.name:
            self.name = f"–°–µ–∑–æ–Ω {self.number}"
        super().save(*args, **kwargs)

    @classmethod
    def create_next_season(cls) -> 'Season':
        """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω"""
        last_season = cls.objects.order_by('-number').first()
        new_season_number = 1 if not last_season else last_season.number + 1

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–∑–æ–Ω–∞
        start_date, end_date = get_next_season_dates()

        season = cls(
            number=new_season_number,
            start_date=start_date,
            end_date=end_date,
            is_active=True
        )
        season.full_clean()
        season.save()
        return season

class League(models.Model):
    """Model for representing a league/division"""
    name = models.CharField(max_length=100)
    country = CountryField()
    level = models.PositiveIntegerField()  # 1 for top division, 2 for second, etc.
    max_teams = models.PositiveIntegerField(default=16)
    foreign_players_limit = models.PositiveIntegerField(
        default=5, 
        help_text="Maximum number of foreign players allowed in match squad"
    )

    class Meta:
        unique_together = ['country', 'level']
        ordering = ['country', 'level']

    def __str__(self):
        return f"{self.name} ({self.country})"

    def clean(self):
        if self.max_teams != 16:
            raise ValidationError({
                'max_teams': '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –≤ –ª–∏–≥–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–≤–Ω–æ 16'
            })

class Championship(models.Model):
    STATUS_CHOICES = [
        ('pending', 'Pending'),
        ('in_progress', 'In Progress'),
        ('finished', 'Finished')
    ]

    season = models.ForeignKey(Season, on_delete=models.CASCADE)
    league = models.ForeignKey(League, on_delete=models.CASCADE)
    teams = models.ManyToManyField(Club, through='ChampionshipTeam')
    status = models.CharField(
        max_length=20, 
        choices=STATUS_CHOICES,
        default='pending'
    )
    start_date = models.DateField()
    end_date = models.DateField()
    match_time = models.TimeField(
        default=time(18, 0),
        help_text="Match start time (UTC)"
    )

    class Meta:
        unique_together = ['season', 'league']

    def __str__(self):
        return f"{self.league.name} - {self.season.name}"

    def get_local_match_time(self, user_timezone=None):
        if not user_timezone:
            user_timezone = timezone.get_current_timezone()
        utc_time = datetime.combine(datetime.today(), self.match_time)
        utc_time = pytz.utc.localize(utc_time)
        return utc_time.astimezone(user_timezone).time()

    def clean(self):
        if self.teams.count() != 16:
            raise ValidationError('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–≤–Ω–æ 16')

    def can_participate_in_transitions(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö"""
        if not self.is_completed:
            return False
            
        valid, error = self.validate_status()
        if not valid:
            return False
            
        if self.league.level not in [1, 2]:
            return False
            
        return True

    def get_teams_for_relegation(self) -> list:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–Ω–∏–∂–µ–Ω–∏—è –≤ –¥–∏–≤–∏–∑–∏–æ–Ω–µ"""
        if self.league.level != 1:
            raise ValidationError("Relegation is only possible from the first division")

        if not self.can_participate_in_transitions():
            raise ValidationError("Championship cannot participate in transitions yet")
            
        return (
            self.championshipteam_set
            .annotate(
                goals_diff=models.F('goals_for') - models.F('goals_against')
            )
            .select_related('team')
            .order_by(
                'points',
                'goals_diff',
                'goals_for'
            )[:2]
        )

    def get_teams_for_promotion(self) -> list:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤ –¥–∏–≤–∏–∑–∏–æ–Ω–µ"""
        if self.league.level != 2:
            raise ValidationError("Promotion is only possible from the second division")

        if not self.can_participate_in_transitions():
            raise ValidationError("Championship cannot participate in transitions yet")
            
        return (
            self.championshipteam_set
            .annotate(
                goals_diff=models.F('goals_for') - models.F('goals_against')
            )
            .select_related('team')
            .order_by(
                '-points',
                '-goals_diff',
                '-goals_for'
            )[:2]
        )

    @property
    def is_completed(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–≤–µ—Ä—à–µ–Ω—ã –ª–∏ –≤—Å–µ –º–∞—Ç—á–∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞"""
        return not self.championshipmatch_set.filter(
            ~models.Q(match__status='finished')
        ).exists()

    def get_standings(self) -> list:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"""
        return (
            self.championshipteam_set
            .annotate(
                goals_diff=models.F('goals_for') - models.F('goals_against')
            )
            .select_related('team')
            .order_by(
                '-points',
                '-goals_diff',
                '-goals_for'
            )
        )

    def validate_status(self) -> tuple:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (is_valid, error_message)
        """
        if self.teams.count() != 16:
            return False, "–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥ –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç–µ"
                
        matches_count = self.championshipmatch_set.count()
        expected_matches = 16 * 15  # –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–≥—Ä–∞–µ—Ç —Å –∫–∞–∂–¥–æ–π –¥—Ä—É–≥–æ–π –¥–≤–∞–∂–¥—ã
        if matches_count != expected_matches:
            return False, f"–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π: {matches_count} –≤–º–µ—Å—Ç–æ {expected_matches}"
                
        return True, None

class ChampionshipTeam(models.Model):
    """Model for storing team statistics in championship"""
    championship = models.ForeignKey(Championship, on_delete=models.CASCADE)
    team = models.ForeignKey(Club, on_delete=models.CASCADE)
    points = models.PositiveIntegerField(default=0)
    matches_played = models.PositiveIntegerField(default=0)
    wins = models.PositiveIntegerField(default=0)
    draws = models.PositiveIntegerField(default=0)
    losses = models.PositiveIntegerField(default=0)
    goals_for = models.PositiveIntegerField(default=0)
    goals_against = models.PositiveIntegerField(default=0)

    class Meta:
        unique_together = ['championship', 'team']
        ordering = ['-points', '-goals_for']

    def __str__(self):
        return f"{self.team.name} - {self.championship}"

    @property
    def goals_difference(self):
        """Calculate goals difference"""
        return self.goals_for - self.goals_against

    @property
    def points_per_game(self):
        """Calculate average points per game"""
        if self.matches_played > 0:
            return round(self.points / self.matches_played, 2)
        return 0

    @property
    def position(self) -> int:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–∞–±–ª–∏—Ü–µ"""
        return (
            self.championship.championshipteam_set
            .annotate(
                goals_diff=models.F('goals_for') - models.F('goals_against')
            )
            .filter(
                models.Q(points__gt=self.points) |
                (models.Q(points=self.points) & models.Q(goals_diff__gt=self.goals_difference)) |
                (models.Q(points=self.points) & 
                 models.Q(goals_diff=self.goals_difference) & 
                 models.Q(goals_for__gt=self.goals_for))
            )
            .count() + 1
        )

    @property
    def is_relegation_zone(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤ –∑–æ–Ω–µ –≤—ã–ª–µ—Ç–∞"""
        return self.position >= 15

    @property
    def is_promotion_zone(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤ –∑–æ–Ω–µ –ø–æ–≤—ã—à–µ–Ω–∏—è"""
        return self.position <= 2

class ChampionshipMatch(models.Model):
    """Model for linking matches to championship"""
    championship = models.ForeignKey(Championship, on_delete=models.CASCADE)
    match = models.OneToOneField(Match, on_delete=models.CASCADE)
    round = models.PositiveIntegerField()
    match_day = models.PositiveIntegerField()
    processed = models.BooleanField(default=False)

    class Meta:
        ordering = ['round', 'match_day']

    def __str__(self):
        return f"Round {self.round}: {self.match}"

    @property
    def match_datetime(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –º–∞—Ç—á–∞"""
        return datetime.combine(
            self.championship.start_date + timedelta(days=self.match_day - 1),
            datetime.min.time().replace(hour=18)
        )

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\models.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\signals.py ---

from django.db.models.signals import post_save, pre_save
from django.dispatch import receiver
from clubs.models import Club
from tournaments.models import Championship, ChampionshipTeam, ChampionshipMatch, Season
from matches.models import Match
from django.db import transaction
from django.db.models import Q
from django.core.management import call_command

def update_matches_for_replaced_team(championship, old_team_id, new_team):
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –º–∞—Ç—á–∏, –∑–∞–º–µ–Ω—è—è old_team –Ω–∞ new_team
    """
    try:
        with transaction.atomic():
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –º–∞—Ç—á–∏ —Å—Ç–∞—Ä–æ–π –∫–æ–º–∞–Ω–¥—ã
            bot_matches = Match.objects.filter(
                championshipmatch__championship=championship
            ).filter(
                Q(home_team_id=old_team_id) | Q(away_team_id=old_team_id)
            ).select_related(
                'championshipmatch',
                'home_team',
                'away_team'
            ).order_by('championshipmatch__round')

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –º–∞—Ç—á
            updated_count = 0
            unique_opponents = set()

            for match in bot_matches:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
                opponent = match.away_team if match.home_team_id == old_team_id else match.home_team
                unique_opponents.add(opponent.id)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –º–∞—Ç—á–µ
                if match.home_team_id == old_team_id:
                    match.home_team = new_team
                else:
                    match.away_team = new_team

                match.save()
                updated_count += 1

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
            if len(unique_opponents) < 2:
                raise ValueError(
                    f"Error: team has only {len(unique_opponents)} opponents. "
                    f"Something is wrong with the schedule."
                )

            return updated_count

    except Exception as e:
        raise

@receiver(post_save, sender=Club)
def handle_club_creation(sender, instance, created, **kwargs):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—É–±–∞ –∏ –∑–∞–º–µ—â–µ–Ω–∏–µ –±–æ—Ç–∞"""
    if not created or instance.is_bot:
        return
        
    try:
        with transaction.atomic():
            # –ù–∞–π—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —á–µ–º–ø–∏–æ–Ω–∞—Ç
            championship = Championship.objects.select_related('season')\
                .filter(
                    league__country=instance.country,
                    league__level=1,
                    season__is_active=True
                ).first()
                
            if not championship:
                return

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ –∫–ª—É–±
            if championship.teams.filter(id=instance.id).exists():
                return
                
            # –ù–∞–π—Ç–∏ –∫–æ–º–∞–Ω–¥—É-–±–æ—Ç–∞ –¥–ª—è –∑–∞–º–µ–Ω—ã
            bot_team = championship.teams.filter(is_bot=True).first()
            if not bot_team:
                return
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –±–æ—Ç–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
            bot_team_id = bot_team.id
                
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–æ—Ç–∞
            bot_stats = ChampionshipTeam.objects.get(
                championship=championship,
                team=bot_team
            )
            
            # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª—É–±–∞
            ChampionshipTeam.objects.create(
                championship=championship,
                team=instance,
                points=bot_stats.points,
                matches_played=bot_stats.matches_played,
                wins=bot_stats.wins,
                draws=bot_stats.draws,
                losses=bot_stats.losses,
                goals_for=bot_stats.goals_for,
                goals_against=bot_stats.goals_against
            )
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—á–∏
            update_matches_for_replaced_team(
                championship=championship,
                old_team_id=bot_team_id,
                new_team=instance
            )
            
            # –£–¥–∞–ª—è–µ–º –±–æ—Ç–∞
            bot_stats.delete()
            bot_team.delete()
            
    except Exception as e:
        raise

@receiver(post_save, sender=Match)
def handle_match_result(sender, instance, **kwargs):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞—Ç—á–∞"""
    try:
        championship_match = ChampionshipMatch.objects.select_related(
            'championship',
            'match',
            'match__home_team',
            'match__away_team'
        ).filter(match=instance).first()

        if not championship_match or championship_match.processed or instance.status != 'finished':
            return

        max_attempts = 3
        current_attempt = 0

        while current_attempt < max_attempts:
            try:
                with transaction.atomic():
                    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–∞–Ω–¥
                    home_stats = ChampionshipTeam.objects.select_for_update().get(
                        championship=championship_match.championship,
                        team=instance.home_team
                    )
                    away_stats = ChampionshipTeam.objects.select_for_update().get(
                        championship=championship_match.championship,
                        team=instance.away_team
                    )

                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                    home_stats.matches_played += 1
                    away_stats.matches_played += 1
                    home_stats.goals_for += instance.home_score
                    home_stats.goals_against += instance.away_score
                    away_stats.goals_for += instance.away_score
                    away_stats.goals_against += instance.home_score

                    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                    if instance.home_score > instance.away_score:
                        home_stats.wins += 1
                        home_stats.points += 3
                        away_stats.losses += 1
                    elif instance.home_score < instance.away_score:
                        away_stats.wins += 1
                        away_stats.points += 3
                        home_stats.losses += 1
                    else:
                        home_stats.draws += 1
                        away_stats.draws += 1
                        home_stats.points += 1
                        away_stats.points += 1

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    home_stats.save()
                    away_stats.save()

                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞
                    championship = championship_match.championship
                    if championship.is_completed and championship.status != 'finished':
                        championship.status = 'finished'
                        championship.save()

                    championship_match.processed = True
                    championship_match.save()
                    return

            except Exception:
                current_attempt += 1
                if current_attempt == max_attempts:
                    raise
                import time
                time.sleep(1)

    except Exception:
        raise

@receiver(post_save, sender=Season)
def handle_season_end(sender, instance, **kwargs):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞"""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–∑–æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–Ω—ã–º, –Ω–æ —Å—Ç–∞–ª –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º
    if not instance.is_active and kwargs.get('update_fields') and 'is_active' in kwargs['update_fields']:
        try:
            with transaction.atomic():
                # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –¥–∏–≤–∏–∑–∏–æ–Ω–∞–º–∏
                call_command('handle_season_transitions')
        except Exception as e:
            raise

@receiver(post_save, sender=ChampionshipTeam)
def update_team_league(sender, instance, **kwargs):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏–≤—è–∑–∫—É –∫–æ–º–∞–Ω–¥—ã –∫ –ª–∏–≥–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    if instance.championship.status == 'finished':
        try:
            with transaction.atomic():
                team = instance.team
                
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã
                position = instance.position
                current_level = instance.championship.league.level
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –º–µ–Ω—è—Ç—å –ª–∏–≥—É
                if current_level == 1 and position >= 15:  # –í—ã–ª–µ—Ç –∏–∑ –≤—ã—Å—à–µ–≥–æ –¥–∏–≤–∏–∑–∏–æ–Ω–∞
                    new_league = League.objects.get(
                        country=team.country,
                        level=2
                    )
                    team.league = new_league
                    team.save()
                elif current_level == 2 and position <= 2:  # –ü–æ–≤—ã—à–µ–Ω–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–π –¥–∏–≤–∏–∑–∏–æ–Ω
                    new_league = League.objects.get(
                        country=team.country,
                        level=1
                    )
                    team.league = new_league
                    team.save()
        except Exception as e:
            raise

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\signals.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tasks.py ---

from celery import shared_task
from django.utils import timezone
from django.db import transaction, OperationalError
from django.core.management import call_command
from matches.models import Match
from django.db import models
from .models import Season, Championship, League
import logging
from datetime import timedelta
import time
from django.core.exceptions import ObjectDoesNotExist

logger = logging.getLogger(__name__)

def retry_on_db_lock(func, max_attempts=3, delay=1):
    def wrapper(*args, **kwargs):
        attempts = 0
        while attempts < max_attempts:
            try:
                return func(*args, **kwargs)
            except OperationalError as e:
                if "database is locked" in str(e) and attempts < max_attempts - 1:
                    attempts += 1
                    time.sleep(delay)
                    continue
                raise
    return wrapper

@shared_task(
    name='tournaments.simulate_active_matches',
    bind=True,
    autoretry_for=(Exception,),
    retry_kwargs={'max_retries': 3, 'countdown': 60}
)
def simulate_active_matches(self):
    """
    –ü–æ—à–∞–≥–æ–≤–∞—è —Å–∏–º—É–ª—è—Ü–∏—è –º–∞—Ç—á–µ–π.
    –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (–∏–ª–∏ –¥—Ä—É–≥–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª) –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∞—Ç—á–∏, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ 'in_progress',
    –∏ —Å–∏–º—É–ª–∏—Ä—É–µ—Ç –æ–¥–Ω—É –∏–≥—Ä–æ–≤—É—é –º–∏–Ω—É—Ç—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ –º–∞—Ç—á–∞.
    """
    now = timezone.now()
    logger.info(f"Starting active matches simulation at {now}")

    matches = Match.objects.filter(status='in_progress')
    if not matches.exists():
        logger.info("No matches in progress at the moment.")
        return "No matches in progress"

    from matches.match_simulation import simulate_one_minute

    for match in matches:
        simulate_one_minute(match.id)
        logger.info(f"Simulated one minute for match {match.id} "
                    f"({match.home_team} vs {match.away_team}, current_minute={match.current_minute})")

    return f"Simulated one minute for {matches.count()} matches"


@shared_task(
    name='tournaments.check_season_end',
    bind=True,
    autoretry_for=(Exception,),
    retry_kwargs={'max_retries': 3, 'countdown': 60}
)
def check_season_end(self):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –µ–≥–æ,
    –∑–∞—Ç–µ–º —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å–µ–∑–æ–Ω.
    """
    try:
        with transaction.atomic():
            current_season = Season.objects.select_for_update().get(is_active=True)
            today = timezone.now().date()
            
            logger.info(f"Checking season {current_season.number} (end date: {current_season.end_date})")
            
            is_end_date_passed = today > current_season.end_date
            
            finished_matches_count = Match.objects.filter(
                championshipmatch__championship__season=current_season,
                status='finished'
            ).count()

            required_matches = len(Championship.objects.filter(season=current_season)) * (16 * 15)
            
            all_matches_played = finished_matches_count >= required_matches

            if is_end_date_passed and all_matches_played:
                logger.info(f"Season {current_season.number} has ended. Starting end-season process...")
                
                unfinished_matches = Match.objects.filter(
                    championshipmatch__championship__season=current_season,
                    status__in=['scheduled', 'in_progress']
                )
                
                unfinished_count = unfinished_matches.count()
                if unfinished_count > 0:
                    logger.warning(
                        f"Found {unfinished_count} unfinished matches. "
                        "Season cannot end with unfinished matches."
                    )
                    return (f"Season {current_season.number} has {unfinished_count} unfinished matches")
                
                logger.info("Processing teams transitions between divisions...")
                call_command('handle_season_transitions')
                
                current_season.is_active = False
                current_season.save()
                logger.info(f"Deactivated season {current_season.number}")
                
                logger.info("Creating new season...")
                call_command('create_new_season')
                
                try:
                    new_season = Season.objects.get(is_active=True)
                    logger.info(f"Successfully created new season {new_season.number}")
                    
                    championships = Championship.objects.filter(season=new_season)
                    total_teams = sum(c.teams.count() for c in championships)
                    
                    return (
                        f"Season {current_season.number} ended successfully. "
                        f"Created new season {new_season.number} with "
                        f"{championships.count()} championships and {total_teams} teams"
                    )
                except Season.DoesNotExist:
                    error_msg = "Failed to create new season"
                    logger.error(error_msg)
                    raise Exception(error_msg)
                except Season.MultipleObjectsReturned:
                    error_msg = "Multiple active seasons found after creation"
                    logger.error(error_msg)
                    raise Exception(error_msg)
            
            if not all_matches_played:
                return f"Season {current_season.number} is waiting for matches completion ({finished_matches_count}/{required_matches})"
            if not is_end_date_passed:
                return f"Season {current_season.number} is still active until {current_season.end_date}"
            return f"Season {current_season.number} needs both end date and all matches to end"
            
    except Season.DoesNotExist:
        logger.warning("No active season found")
        return "No active season found"
    except Exception as e:
        logger.error(f"Error in season end check: {str(e)}")
        raise


@shared_task(name='tournaments.start_scheduled_matches')
def start_scheduled_matches():
    """
    –ü–µ—Ä–µ–≤–æ–¥–∏—Ç –º–∞—Ç—á–∏, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –≤—Ä–µ–º—è —É–∂–µ –Ω–∞—Å—Ç—É–ø–∏–ª–æ, –∏–∑ scheduled –≤ in_progress.
    –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ—à–ª—ã–µ –∏–ª–∏ —Ç–µ–∫—É—â–∏–µ –º–∞—Ç—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å (—Ö–æ—Ç—è –¥–æ–ª–∂–Ω—ã –±—ã–ª–∏),
    –æ–Ω–∏ —Ç–µ–ø–µ—Ä—å –Ω–∞—á–Ω—É—Ç—Å—è, –∏ simulate_active_matches —Å–º–æ–∂–µ—Ç –∏—Ö —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å.
    """
    now = timezone.now()
    with transaction.atomic():
        matches = Match.objects.select_for_update().filter(
            status='scheduled',
            datetime__lte=now
        )
        count = matches.count()
        if count > 0:
            logger.info(f"Found {count} scheduled matches ready to start.")
            matches.update(status='in_progress')
        else:
            logger.info("No scheduled matches ready to start.")
    return f"{count} matches started."

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tasks.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests.py ---

from django.test import TestCase
from django.utils import timezone
from datetime import datetime, timedelta
from django.core.exceptions import ValidationError
from django_countries import countries
from .models import Season, League, Championship, ChampionshipTeam
from .utils import generate_league_schedule, create_championship_matches, validate_championship_schedule
from clubs.models import Club

class ChampionshipSystemTests(TestCase):
    def setUp(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        # –°–æ–∑–¥–∞–µ–º —Å–µ–∑–æ–Ω
        self.season = Season.objects.create(
            number=1,
            start_date=datetime(2024, 3, 1).date(),
            end_date=datetime(2024, 3, 30).date(),
            is_active=True
        )

        # –°–æ–∑–¥–∞–µ–º –ª–∏–≥—É
        self.league = League.objects.create(
            name="Test League",
            country='GB',  # –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è
            level=1,
            max_teams=16
        )

        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—É–±—ã
        self.clubs = []
        for i in range(16):
            club = Club.objects.create(
                name=f"Test Club {i+1}",
                country='GB',
                is_bot=True
            )
            self.clubs.append(club)

        # –°–æ–∑–¥–∞–µ–º —á–µ–º–ø–∏–æ–Ω–∞—Ç
        self.championship = Championship.objects.create(
            season=self.season,
            league=self.league,
            status='pending',
            start_date=self.season.start_date,
            end_date=self.season.end_date
        )

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —á–µ–º–ø–∏–æ–Ω–∞—Ç
        for club in self.clubs:
            ChampionshipTeam.objects.create(
                championship=self.championship,
                team=club
            )

    def test_schedule_generation_basic(self):
        """–¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
        schedule = generate_league_schedule(self.championship)
        self.assertEqual(len(schedule), 240)  # 16 –∫–æ–º–∞–Ω–¥ = 30 —Ç—É—Ä–æ–≤ –ø–æ 8 –º–∞—Ç—á–µ–π

    def test_home_away_balance(self):
        """–¢–µ—Å—Ç –±–∞–ª–∞–Ω—Å–∞ –¥–æ–º–∞—à–Ω–∏—Ö/–≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π"""
        schedule = generate_league_schedule(self.championship)
        
        # –ü–æ–¥—Å—á–µ—Ç –¥–æ–º–∞—à–Ω–∏—Ö –∏ –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        home_games = {club: 0 for club in self.clubs}
        away_games = {club: 0 for club in self.clubs}
        
        for round_num, day, home, away in schedule:
            home_games[home] += 1
            away_games[away] += 1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        for club in self.clubs:
            self.assertEqual(home_games[club], 15, 
                           f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {home_games[club]} –¥–æ–º–∞—à–Ω–∏—Ö –º–∞—Ç—á–µ–π –≤–º–µ—Å—Ç–æ 15")
            self.assertEqual(away_games[club], 15, 
                           f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç {away_games[club]} –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –≤–º–µ—Å—Ç–æ 15")

    def test_consecutive_matches(self):
        """–¢–µ—Å—Ç –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ/–≤—ã–µ–∑–¥–Ω—ã–µ –º–∞—Ç—á–∏"""
        schedule = generate_league_schedule(self.championship)
        
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
        team_schedules = {club: [] for club in self.clubs}
        for round_num, day, home, away in sorted(schedule):
            team_schedules[home].append(('home', round_num))
            team_schedules[away].append(('away', round_num))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∫–æ–º–∞–Ω–¥—É
        for club, matches in team_schedules.items():
            matches.sort(key=lambda x: x[1])  # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É —Ç—É—Ä–∞
            
            consecutive_home = 0
            consecutive_away = 0
            
            for match_type, _ in matches:
                if match_type == 'home':
                    consecutive_home += 1
                    consecutive_away = 0
                else:
                    consecutive_away += 1
                    consecutive_home = 0
                
                self.assertLess(consecutive_home, 3,
                              f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç –±–æ–ª–µ–µ 2 –¥–æ–º–∞—à–Ω–∏—Ö –º–∞—Ç—á–µ–π –ø–æ–¥—Ä—è–¥")
                self.assertLess(consecutive_away, 3,
                              f"–ö–æ–º–∞–Ω–¥–∞ {club} –∏–º–µ–µ—Ç –±–æ–ª–µ–µ 2 –≤—ã–µ–∑–¥–Ω—ã—Ö –º–∞—Ç—á–µ–π –ø–æ–¥—Ä—è–¥")

    def test_all_matches_in_one_day(self):
        """–¢–µ—Å—Ç, —á—Ç–æ –≤—Å–µ –º–∞—Ç—á–∏ —Ç—É—Ä–∞ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ –æ–¥–∏–Ω –¥–µ–Ω—å"""
        create_championship_matches(self.championship)
        
        matches = self.championship.championshipmatch_set.all()
        rounds = matches.values('round').distinct()
        
        for round_data in rounds:
            round_num = round_data['round']
            round_matches = matches.filter(round=round_num)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞—Ç—ã –º–∞—Ç—á–µ–π –≤ —ç—Ç–æ–º —Ç—É—Ä–µ
            match_dates = set()
            for match in round_matches:
                match_dates.add(match.match.date.date())
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–∞—Ç—á–∏ –≤ –æ–¥–∏–Ω –¥–µ–Ω—å
            self.assertEqual(len(match_dates), 1,
                           f"–ú–∞—Ç—á–∏ —Ç—É—Ä–∞ {round_num} –ø—Ä–æ—Ö–æ–¥—è—Ç –≤ —Ä–∞–∑–Ω—ã–µ –¥–Ω–∏: {match_dates}")

    def test_february_schedule(self):
        """–¢–µ—Å—Ç –¥–ª—è —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è"""
        # –°–æ–∑–¥–∞–µ–º —Ñ–µ–≤—Ä–∞–ª—å—Å–∫–∏–π —Å–µ–∑–æ–Ω
        february_season = Season.objects.create(
            number=2,
            start_date=datetime(2024, 2, 1).date(),
            end_date=datetime(2024, 2, 28).date(),
            is_active=False
        )
        
        february_championship = Championship.objects.create(
            season=february_season,
            league=self.league,
            status='pending',
            start_date=february_season.start_date,
            end_date=february_season.end_date
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ –∂–µ –∫–æ–º–∞–Ω–¥—ã
        for club in self.clubs:
            ChampionshipTeam.objects.create(
                championship=february_championship,
                team=club
            )
        
        create_championship_matches(february_championship)
        self.assertTrue(validate_championship_schedule(february_championship))

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–≤–æ–π–Ω—ã—Ö —Ç—É—Ä–æ–≤ 15 —Ñ–µ–≤—Ä–∞–ª—è
        double_matchday_matches = february_championship.championshipmatch_set.filter(
            match__date__date=datetime(2024, 2, 15).date()
        )
        self.assertEqual(double_matchday_matches.count(), 16,  # 8 –º–∞—Ç—á–µ–π * 2 —Ç—É—Ä–∞
                        "–ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Ç—á–µ–π –≤ –¥–≤–æ–π–Ω–æ–π –∏–≥—Ä–æ–≤–æ–π –¥–µ–Ω—å")

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\tests.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\timezone_middleware.py ---

from django.utils import timezone
import pytz

class TimezoneMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        tzname = request.session.get('django_timezone')
        if tzname:
            timezone.activate(pytz.timezone(tzname))
        else:
            timezone.deactivate()
        return self.get_response(request)

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\timezone_middleware.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\urls.py ---

from django.urls import path
from . import views

app_name = 'tournaments'

urlpatterns = [
    path('', views.ChampionshipListView.as_view(), name='championship_list'),
    path('championship/<int:pk>/', views.ChampionshipDetailView.as_view(), name='championship_detail'),
    path('championship/<int:pk>/calendar/', views.ChampionshipCalendarView.as_view(), name='championship_calendar'),
    path('seasons/', views.SeasonListView.as_view(), name='season_list'),
    path('leagues/', views.LeagueListView.as_view(), name='league_list'),
    path('set-timezone/', views.set_timezone, name='set_timezone'),
    path('api/matches/<int:pk>/', views.get_championship_matches, name='api_matches'),
    path('my-championship/', views.MyChampionshipView.as_view(), name='my_championship'),
]

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\urls.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\utils.py ---

from typing import List, Tuple, Dict
from datetime import datetime, timedelta
from django.utils import timezone
from django.db import models, transaction
import calendar

def check_consecutive_matches(schedule: List[Tuple], team, is_home: bool) -> int:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∏–ª–∏ –≥–æ—Å—Ç–µ–≤—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–æ–º–∞–Ω–¥—ã.
    """
    max_consecutive = 0
    current_consecutive = 0

    for match in schedule:
        if is_home:
            is_match = match[2] == team  # –¥–æ–º–∞—à–Ω—è—è –∫–æ–º–∞–Ω–¥–∞
        else:
            is_match = match[3] == team  # –≥–æ—Å—Ç–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞

        if is_match:
            current_consecutive += 1
            max_consecutive = max(max_consecutive, current_consecutive)
        else:
            current_consecutive = 0

    return max_consecutive

def get_team_matches(schedule: List[Tuple], team) -> List[Tuple[int, bool]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –º–∞—Ç—á–µ–π –∫–æ–º–∞–Ω–¥—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–æ–º–∞—à–Ω–∏—Ö/–≥–æ—Å—Ç–µ–≤—ã—Ö –∏–≥—Ä–∞—Ö.
    """
    team_matches = []
    for round_num, day, home, away in schedule:
        if home == team:
            team_matches.append((round_num, True))
        elif away == team:
            team_matches.append((round_num, False))
    return sorted(team_matches)

def validate_schedule_balance(schedule: List[Tuple], teams: List) -> Dict:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∞–ª–∞–Ω—Å –¥–æ–º–∞—à–Ω–∏—Ö –∏ –≥–æ—Å—Ç–µ–≤—ã—Ö –º–∞—Ç—á–µ–π –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã.
    """
    balance = {team: {'home': 0, 'away': 0} for team in teams}

    for _, _, home, away in schedule:
        balance[home]['home'] += 1
        balance[away]['away'] += 1

    return balance

def generate_league_schedule(championship) -> List[Tuple]:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –º–∞—Ç—á–µ–π –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É –∫—Ä—É–≥–æ–≤–æ–≥–æ —Ç—É—Ä–Ω–∏—Ä–∞.
    """
    from .models import Championship  # –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    
    teams = list(championship.teams.all())
    if len(teams) != 16:
        raise ValueError(f"–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–≤–Ω–æ 16 –∫–æ–º–∞–Ω–¥, —Å–µ–π—á–∞—Å: {len(teams)}")
    
    n = len(teams)
    rounds = n - 1
    schedule = []
    
    # –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –∫–æ–º–∞–Ω–¥
    team_numbers = list(range(n))
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Ç—Ä–∏—Ü—É –≤—Å—Ç—Ä–µ—á
    matches = []
    for round_num in range(rounds):
        round_matches = []
        for i in range(n // 2):
            home = team_numbers[i]
            away = team_numbers[n - i - 1]
            # –ß–µ—Ä–µ–¥—É–µ–º –¥–æ–º–∞—à–Ω–∏–µ –∏ –≤—ã–µ–∑–¥–Ω—ã–µ –º–∞—Ç—á–∏
            if (i + round_num) % 2 == 0:
                round_matches.append((home, away))
            else:
                round_matches.append((away, home))
        matches.append(round_matches)
        # –†–æ—Ç–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥
        team_numbers = [team_numbers[0]] + team_numbers[-1:] + team_numbers[1:-1]
    
    # –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∏ –≤—Ç–æ—Ä–æ–≥–æ –∫—Ä—É–≥–æ–≤
    for half in range(2):
        for round_num in range(rounds):
            actual_round = round_num + 1 + half * rounds
            round_matches = matches[round_num]
            for match_num, (home_idx, away_idx) in enumerate(round_matches):
                if half == 1:
                    # –í–æ –≤—Ç–æ—Ä–æ–º –∫—Ä—É–≥–µ –º–µ–Ω—è–µ–º —Ö–æ–∑—è–µ–≤ –∏ –≥–æ—Å—Ç–µ–π
                    home_idx, away_idx = away_idx, home_idx
                home_team = teams[home_idx]
                away_team = teams[away_idx]
                schedule.append((actual_round, match_num + 1, home_team, away_team))
    
    return schedule

def create_championship_matches(championship) -> None:
    """
    –°–æ–∑–¥–∞–µ—Ç –º–∞—Ç—á–∏ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.
    """
    from .models import ChampionshipMatch  # –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    from matches.models import Match  # –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    
    with transaction.atomic():
        ChampionshipMatch.objects.filter(championship=championship).delete()

        schedule = generate_league_schedule(championship)
        matches_by_round = {}
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–∞—Ç—á–∏ –ø–æ —Ç—É—Ä–∞–º
        for round_num, day, home_team, away_team in schedule:
            if round_num not in matches_by_round:
                matches_by_round[round_num] = []
            matches_by_round[round_num].append((day, home_team, away_team))
            
        current_date = championship.start_date

        # –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á–∏
        for round_num in sorted(matches_by_round.keys()):
            match_time = championship.match_time
            if championship.league.level == 2:
                match_time = (
                    datetime.combine(datetime.min, match_time) - 
                    timedelta(hours=2)
                ).time()

            match_datetime = timezone.make_aware(
                datetime.combine(current_date, match_time)
            )

            for day, home_team, away_team in matches_by_round[round_num]:
                match = Match.objects.create(
                    home_team=home_team,
                    away_team=away_team,
                    datetime=match_datetime,
                    status='scheduled'
                )

                ChampionshipMatch.objects.create(
                    championship=championship,
                    match=match,
                    round=round_num,
                    match_day=current_date.day
                )

            current_date += timedelta(days=1)

def validate_championship_schedule(championship) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞.
    """
    from .models import Championship  # –ò–º–ø–æ—Ä—Ç –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏
    
    matches = championship.championshipmatch_set.select_related('match')
    teams = list(championship.teams.all())

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∞—Ç—á–µ–π
    expected_matches = len(teams) * (len(teams) - 1)
    if matches.count() != expected_matches:
        return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –º–∞—Ç—á–µ–π
    team_matches = {team: {'home': 0, 'away': 0} for team in teams}
    for match in matches:
        team_matches[match.match.home_team]['home'] += 1
        team_matches[match.match.away_team]['away'] += 1

    for team, stats in team_matches.items():
        if stats['home'] != (len(teams) - 1) or stats['away'] != (len(teams) - 1):
            return False

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–∞—Ç—á–µ–π
    for team in teams:
        team_schedule = list(matches.filter(
            models.Q(match__home_team=team) | models.Q(match__away_team=team)
        ).order_by('round'))

        home_streak = 0
        away_streak = 0
        max_home_streak = 0
        max_away_streak = 0

        for match in team_schedule:
            if match.match.home_team == team:
                home_streak += 1
                away_streak = 0
                max_home_streak = max(max_home_streak, home_streak)
            else:
                away_streak += 1
                home_streak = 0
                max_away_streak = max(max_away_streak, away_streak)

        if max_home_streak > 2 or max_away_streak > 2:
            return False

    return True

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\utils.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\views.py ---

from django.views.generic import ListView, DetailView
from django.contrib.auth.mixins import LoginRequiredMixin
from django.shortcuts import redirect
from django.contrib import messages
from django.core.exceptions import ObjectDoesNotExist
from django.http import Http404
from django.urls import reverse
from django.conf import settings
import json
from django.utils import timezone
from django.http import JsonResponse
from django.db import models
from .models import Championship, Season, League

class ChampionshipListView(LoginRequiredMixin, ListView):
    model = Championship
    template_name = 'tournaments/championship_list.html'
    context_object_name = 'championships'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        context['active_seasons'] = Season.objects.filter(is_active=True)
        context['championships'] = Championship.objects.all().select_related(
            'league', 'season'
        ).order_by('league__level')
        return context

class ChampionshipDetailView(LoginRequiredMixin, DetailView):
    model = Championship
    template_name = 'tournaments/championship_detail.html'
    context_object_name = 'championship'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        
        context['standings'] = (
            self.object.championshipteam_set
            .annotate(
                goals_diff=models.F('goals_for') - models.F('goals_against')
            )
            .order_by('-points', '-goals_diff', '-goals_for')
        )
        
        matches = self.object.championshipmatch_set.all().select_related(
            'match', 
            'match__home_team', 
            'match__away_team'
        ).order_by('round', 'match__datetime')
        
        context['matches'] = matches
        
        calendar_events = []
        for match in matches:
            calendar_events.append({
                'id': match.id,
                'title': f"{match.match.home_team} vs {match.match.away_team}",
                'start': match.match.datetime.isoformat(),
                'status': match.match.status,
                'score': f"{match.match.home_score} - {match.match.away_score}" if match.match.status == 'finished' else None,
                'url': reverse('matches:match_detail', args=[match.match.id]),
                'className': f"match-{match.match.status}"
            })
        
        context['calendar_events'] = json.dumps(calendar_events)
        context['user_timezone'] = self.request.session.get('timezone', timezone.get_current_timezone_name())
        
        return context

class MyChampionshipView(LoginRequiredMixin, DetailView):
    model = Championship
    template_name = 'tournaments/my_championship.html'
    
    def dispatch(self, request, *args, **kwargs):
        if not hasattr(request.user, 'club'):
            messages.warning(request, "You need to create a club first.")
            return redirect('clubs:create_club')
        return super().dispatch(request, *args, **kwargs)
    
    def get_object(self):
        try:
            return Championship.objects.select_related(
                'league',
                'season'
            ).get(
                teams=self.request.user.club,
                season__is_active=True
            )
        except Championship.DoesNotExist:
            raise Http404("No championship found for your club")
    
    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        championship = self.object
        user_club = self.request.user.club

        # Get standings
        context['standings'] = championship.championshipteam_set.select_related(
            'team'
        ).order_by(
            '-points', 
            '-goals_for'
        )

        # Get team matches for display
        context['team_matches'] = championship.championshipmatch_set.filter(
            models.Q(match__home_team=user_club) | 
            models.Q(match__away_team=user_club)
        ).select_related(
            'match', 
            'match__home_team', 
            'match__away_team'
        ).order_by('match__datetime')

        return context

class ChampionshipCalendarView(LoginRequiredMixin, DetailView):
    model = Championship
    template_name = 'tournaments/championship_calendar.html'
    context_object_name = 'championship'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        return context

class SeasonListView(LoginRequiredMixin, ListView):
    model = Season
    template_name = 'tournaments/season_list.html'
    context_object_name = 'seasons'

class LeagueListView(LoginRequiredMixin, ListView):
    model = League
    template_name = 'tournaments/league_list.html'
    context_object_name = 'leagues'

    def get_context_data(self, **kwargs):
        context = super().get_context_data(**kwargs)
        countries = {}
        for league in self.get_queryset().order_by('country', 'level'):
            if league.country not in countries:
                countries[league.country] = []
            countries[league.country].append(league)
        context['countries'] = countries
        return context

def set_timezone(request):
    if request.method == 'POST':
        request.session['django_timezone'] = request.POST['timezone']
        return redirect(request.POST.get('next', '/'))
    else:
        return redirect('/')

def get_championship_matches(request, pk):
    championship = Championship.objects.get(pk=pk)
    matches = championship.championshipmatch_set.all().select_related(
        'match', 
        'match__home_team', 
        'match__away_team'
    )
    
    match_data = [{
        'id': match.id,
        'round': match.round,
        'date': match.match.datetime.isoformat(),
        'home_team': match.match.home_team.name,
        'away_team': match.match.away_team.name,
        'status': match.match.status,
        'score': f"{match.match.home_score}-{match.match.away_score}" if match.match.status == 'finished' else None
    } for match in matches]
    
    return JsonResponse({'matches': match_data})

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\views.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\__init__.py ---


# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\tournaments\__init__.py ---


# --- Õ‡˜‡ÎÓ Ù‡ÈÎ‡ C:\realfootballsim\static\js\team_selection.js ---

document.addEventListener('DOMContentLoaded', function() {
    const pitch = document.getElementById('pitch');
    const playerList = document.getElementById('playerList');
    const clubId = document.getElementById('clubId').value;
    const resetButton = document.getElementById('resetButton');
    const saveStatus = document.getElementById('saveStatus');

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –Ω–∞ –ø–æ–ª–µ
    const positions = [
        { top: '10%', left: '50%', type: 'goalkeeper', label: 'GK' },  // GK
        { top: '30%', left: '20%', type: 'defender', label: 'LB' },   // DEF
        { top: '30%', left: '40%', type: 'defender', label: 'CB' },
        { top: '30%', left: '60%', type: 'defender', label: 'CB' },
        { top: '30%', left: '80%', type: 'defender', label: 'RB' },
        { top: '60%', left: '30%', type: 'midfielder', label: 'LM' }, // MID
        { top: '60%', left: '50%', type: 'midfielder', label: 'CM' },
        { top: '60%', left: '70%', type: 'midfielder', label: 'RM' },
        { top: '80%', left: '30%', type: 'forward', label: 'LF' },    // FWD
        { top: '80%', left: '50%', type: 'forward', label: 'ST' },
        { top: '80%', left: '70%', type: 'forward', label: 'RF' }
    ];

    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤ –Ω–∞ –ø–æ–ª–µ
    positions.forEach((pos, index) => {
        const slot = document.createElement('div');
        slot.className = 'player-slot';
        slot.style.top = pos.top;
        slot.style.left = pos.left;
        slot.dataset.position = index;
        slot.dataset.type = pos.type;

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –ø–æ–∑–∏—Ü–∏–∏
        const label = document.createElement('div');
        label.className = 'position-label';
        label.textContent = pos.label;
        slot.appendChild(label);

        pitch.appendChild(slot);
    });

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
    function getPlayerType(position) {
        if (position.includes('Goalkeeper')) return 'goalkeeper';
        if (position.includes('Back') || position.includes('Center Back')) return 'defender';
        if (position.includes('Midfielder')) return 'midfielder';
        if (position.includes('Forward') || position.includes('Striker')) return 'forward';
        return 'other';
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–≥—Ä–æ–∫–∞
    function createPlayerElement(player) {
        const playerElement = document.createElement('div');
        const playerType = getPlayerType(player.position);
        playerElement.className = `player-item ${playerType}`;
        playerElement.dataset.playerId = player.id;
        playerElement.dataset.position = player.position;

        const nameElement = document.createElement('div');
        nameElement.className = 'player-name';
        nameElement.textContent = player.name;

        const positionElement = document.createElement('div');
        positionElement.className = 'player-position text-muted';
        positionElement.textContent = player.position;

        playerElement.appendChild(nameElement);
        playerElement.appendChild(positionElement);

        return playerElement;
    }

    // –ü–æ–∫–∞–∑ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showMessage(text, type = 'success') {
        saveStatus.textContent = text;
        saveStatus.className = `alert alert-${type} mt-2`;
        setTimeout(() => {
            saveStatus.textContent = '';
            saveStatus.className = '';
        }, 3000);
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞
    function saveTeamLineup() {
        const lineup = {};
        document.querySelectorAll('.player-slot').forEach(slot => {
            const playerElem = slot.querySelector('.player-item');
            if (playerElem) {
                lineup[slot.dataset.position] = playerElem.dataset.playerId;
            }
        });

        showMessage('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
        fetch(`/clubs/detail/${clubId}/save-team-lineup/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(lineup)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage('–°–æ—Å—Ç–∞–≤ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } else {
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'danger');
            }
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
            console.error('Error saving lineup:', error);
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞
    function loadTeamLineup() {
        fetch(`/clubs/detail/${clubId}/get-team-lineup/`)
            .then(response => response.json())
            .then(data => {
                if (data.lineup) {
                    Object.entries(data.lineup).forEach(([position, playerId]) => {
                        const slot = document.querySelector(`.player-slot[data-position="${position}"]`);
                        const player = document.querySelector(`.player-item[data-player-id="${playerId}"]`);
                        if (slot && player) {
                            slot.appendChild(player);
                        }
                    });
                }
            })
            .catch(error => {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–∞–≤–∞', 'danger');
                console.error('Error loading lineup:', error);
            });
    }

    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–∞–≤–∞
    function resetLineup() {
        document.querySelectorAll('.player-slot .player-item').forEach(player => {
            playerList.appendChild(player);
        });
        saveTeamLineup();
        showMessage('–°–æ—Å—Ç–∞–≤ —Å–±—Ä–æ—à–µ–Ω');
    }

    resetButton.addEventListener('click', resetLineup);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Sortable
    function initializeSortable() {
        new Sortable(playerList, {
            group: 'shared',
            animation: 150,
            onEnd: saveTeamLineup
        });

        document.querySelectorAll('.player-slot').forEach(slot => {
            new Sortable(slot, {
                group: 'shared',
                animation: 150,
                onAdd: function(evt) {
                    const slotElement = evt.to;
                    const newPlayer = evt.item;
                    const slotType = slotElement.dataset.type;
                    const playerPosition = newPlayer.dataset.position;

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ–∑–∏—Ü–∏–∏
                    let isValid = false;
                    switch (slotType) {
                        case 'goalkeeper':
                            isValid = playerPosition.includes('Goalkeeper');
                            break;
                        case 'defender':
                            isValid = playerPosition.includes('Back') || playerPosition.includes('Center Back');
                            break;
                        case 'midfielder':
                            isValid = playerPosition.includes('Midfielder');
                            break;
                        case 'forward':
                            isValid = playerPosition.includes('Forward') || playerPosition.includes('Striker');
                            break;
                    }

                    if (!isValid) {
                        playerList.appendChild(newPlayer);
                        showMessage('–ù–µ–≤–µ—Ä–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞!', 'danger');
                        return;
                    }
                    
                    // –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Å–ª–æ—Ç–∞
                    slotElement.querySelectorAll('.player-item').forEach(player => {
                        if (player !== newPlayer) {
                            playerList.appendChild(player);
                        }
                    });
                    
                    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ —Å–ª–æ—Ç
                    slotElement.appendChild(newPlayer);
                    saveTeamLineup();
                }
            });
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    fetch(`/clubs/detail/${clubId}/get-players/`)
        .then(response => response.json())
        .then(players => {
            players.forEach(player => {
                const playerElement = createPlayerElement(player);
                playerList.appendChild(playerElement);
            });

            initializeSortable();
            loadTeamLineup();
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä–æ–∫–æ–≤', 'danger');
            console.error('Error loading players:', error);
        });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});

# ---  ÓÌÂˆ Ù‡ÈÎ‡ C:\realfootballsim\static\js\team_selection.js ---

