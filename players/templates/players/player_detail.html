{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1 class="h3 mb-0">{{ player.first_name }} {{ player.last_name }}</h1>
                        <span class="badge bg-primary">{{ player.position }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Player Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="h5 mb-3">Player Info</h4>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>Club:</strong>
                                    <a href="{% url 'clubs:club_detail' player.club.id %}" class="text-decoration-none">
                                        {{ player.club.name }}
                                        {% if player.club.is_bot %}<small>(Bot)</small>{% endif %}
                                    </a>
                                </li>
                                <li class="mb-2"><strong>Age:</strong> {{ player.age }}</li>
                                <li class="mb-2"><strong>Nationality:</strong> {{ player.nationality }}</li>
                                {% if player.player_class %}
                                <li class="mb-2">
                                    <strong>Class:</strong>
                                    <span class="badge bg-info">Class {{ player.player_class }}</span>
                                </li>
                                {% endif %}
                                <!-- Отображение опыта -->
                                <li class="mb-2">
                                    <strong>Experience:</strong> {{ player.experience|floatformat:1 }}
                                </li>
                                <li class="mb-2">
                                    <strong>Overall Rating:</strong>
                                    <span class="badge bg-success">{{ player.overall_rating }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Attributes -->
                    <div class="row">
                        {% if player.position == 'Goalkeeper' %}
                            <!-- Physical Attributes -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Physical</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Strength:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="strength"
                                                         style="width: {{ player.strength }}%;"
                                                         aria-valuenow="{{ player.strength }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.strength }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Stamina:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="stamina"
                                                         style="width: {{ player.stamina }}%;"
                                                         aria-valuenow="{{ player.stamina }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.stamina }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Pace:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="pace"
                                                         style="width: {{ player.pace }}%;"
                                                         aria-valuenow="{{ player.pace }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.pace }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Goalkeeper Core Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Core Goalkeeper Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Reflexes:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="reflexes"
                                                         style="width: {{ player.reflexes }}%;"
                                                         aria-valuenow="{{ player.reflexes }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.reflexes }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Handling:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="handling"
                                                         style="width: {{ player.handling }}%;"
                                                         aria-valuenow="{{ player.handling }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.handling }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Positioning:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="positioning"
                                                         style="width: {{ player.positioning }}%;"
                                                         aria-valuenow="{{ player.positioning }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.positioning }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Aerial:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="aerial"
                                                         style="width: {{ player.aerial }}%;"
                                                         aria-valuenow="{{ player.aerial }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.aerial }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Goalkeeper Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Additional Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Command:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="command"
                                                         style="width: {{ player.command }}%;"
                                                         aria-valuenow="{{ player.command }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.command }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Distribution:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="distribution"
                                                         style="width: {{ player.distribution }}%;"
                                                         aria-valuenow="{{ player.distribution }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.distribution }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>One on One:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="one_on_one"
                                                         style="width: {{ player.one_on_one }}%;"
                                                         aria-valuenow="{{ player.one_on_one }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.one_on_one }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Shot Reading:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="shot_reading"
                                                         style="width: {{ player.shot_reading }}%;"
                                                         aria-valuenow="{{ player.shot_reading }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.shot_reading }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Rebound Control:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="rebound_control"
                                                         style="width: {{ player.rebound_control }}%;"
                                                         aria-valuenow="{{ player.rebound_control }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.rebound_control }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- Physical Attributes -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Physical</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Strength:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="strength"
                                                         style="width: {{ player.strength }}%;"
                                                         aria-valuenow="{{ player.strength }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.strength }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Stamina:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="stamina"
                                                         style="width: {{ player.stamina }}%;"
                                                         aria-valuenow="{{ player.stamina }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.stamina }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Pace:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="pace"
                                                         style="width: {{ player.pace }}%;"
                                                         aria-valuenow="{{ player.pace }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.pace }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Work Rate:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="work_rate"
                                                         style="width: {{ player.work_rate }}%;"
                                                         aria-valuenow="{{ player.work_rate }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.work_rate }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Technical Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Technical Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Passing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="passing"
                                                         style="width: {{ player.passing }}%;"
                                                         aria-valuenow="{{ player.passing }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.passing }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Dribbling:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="dribbling"
                                                         style="width: {{ player.dribbling }}%;"
                                                         aria-valuenow="{{ player.dribbling }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.dribbling }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Crossing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="crossing"
                                                         style="width: {{ player.crossing }}%;"
                                                         aria-valuenow="{{ player.crossing }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.crossing }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Heading:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="heading"
                                                         style="width: {{ player.heading }}%;"
                                                         aria-valuenow="{{ player.heading }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.heading }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Finishing:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="finishing"
                                                         style="width: {{ player.finishing }}%;"
                                                         aria-valuenow="{{ player.finishing }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.finishing }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Mental & Additional Skills -->
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Mental & Additional Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="attribute-list">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Vision:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="vision"
                                                         style="width: {{ player.vision }}%;"
                                                         aria-valuenow="{{ player.vision }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.vision }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Flair:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="flair"
                                                         style="width: {{ player.flair }}%;"
                                                         aria-valuenow="{{ player.flair }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.flair }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Accuracy:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="accuracy"
                                                         style="width: {{ player.accuracy }}%;"
                                                         aria-valuenow="{{ player.accuracy }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.accuracy }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Long Range:</span>
                                                <div class="progress w-50">
                                                    <div class="progress-bar"
                                                         data-attr="long_range"
                                                         style="width: {{ player.long_range }}%;"
                                                         aria-valuenow="{{ player.long_range }}"
                                                         aria-valuemin="0" aria-valuemax="100">
                                                        {{ player.long_range }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Defense Skills -->
                            <div class="col-md-12 mb-3">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title h6 mb-0">Defense Skills</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Marking:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar"
                                                             data-attr="marking"
                                                             style="width: {{ player.marking }}%;"
                                                             aria-valuenow="{{ player.marking }}"
                                                             aria-valuemin="0" aria-valuemax="100">
                                                            {{ player.marking }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Tackling:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar"
                                                             data-attr="tackling"
                                                             style="width: {{ player.tackling }}%;"
                                                             aria-valuenow="{{ player.tackling }}"
                                                             aria-valuemin="0" aria-valuemax="100">
                                                            {{ player.tackling }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Positioning:</span>
                                                    <div class="progress w-50">
                                                        <div class="progress-bar"
                                                             data-attr="positioning"
                                                             style="width: {{ player.positioning }}%;"
                                                             aria-valuenow="{{ player.positioning }}"
                                                             aria-valuemin="0" aria-valuemax="100">
                                                            {{ player.positioning }}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Кнопка "Improve Stats" -->
                    <div class="mt-4 text-center">
                        <!-- При клике открываем модальное окно -->
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#boostModal">
                            Improve Stats
                        </button>
                    </div>

                    <!-- Если текущий пользователь — владелец клуба, показать кнопку «Удалить игрока» -->
                    {% if user.is_authenticated and player.club.owner == user %}
                    <div class="mt-4 text-center">
                        <a href="{% url 'players:player_delete' player_id=player.id %}"
                           class="btn btn-danger">
                            Удалить игрока
                        </a>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для выбора группы улучшения -->
<div class="modal fade" id="boostModal" tabindex="-1" aria-labelledby="boostModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- Убираем классический method="POST" и action="...", будет AJAX -->
      <form id="boostForm">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="boostModalLabel">Choose Group to Improve</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-2">
            Next training cost:
            <strong id="costLabel">
              {{ player.get_boost_cost }}
            </strong>
            token{{ player.get_boost_cost|pluralize }}
          </p>

          {% if player.is_goalkeeper %}
            <div class="mb-3">
              <label for="groupSelect" class="form-label">Available Groups:</label>
              <select class="form-select" id="groupSelect" name="group">
                <option value="physical">Physical</option>
                <option value="core_gk_skills">Core GK Skills</option>
                <option value="additional_gk_skills">Additional GK Skills</option>
              </select>
            </div>
          {% else %}
            <div class="mb-3">
              <label for="groupSelect" class="form-label">Available Groups:</label>
              <select class="form-select" id="groupSelect" name="group">
                <option value="physical">Physical</option>
                <option value="defensive">Defensive</option>
                <option value="attacking">Attacking</option>
                <option value="mental">Mental</option>
                <option value="technical">Technical</option>
                <option value="tactical">Tactical</option>
              </select>
            </div>
          {% endif %}

          <p class="small text-muted">
            +3 points will be added to the selected group's attributes.
            Then +2 points will be randomly allocated among other attributes.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <!-- При нажатии => AJAX -->
          <button type="submit" class="btn btn-primary" id="improveSubmitBtn">
            Improve Now
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * Функция для получения csrftoken из cookie.
 */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

document.addEventListener('DOMContentLoaded', function() {
    const boostForm = document.getElementById('boostForm');
    const costLabel = document.getElementById('costLabel');
    const playerId = "{{ player.id }}";
    const csrfToken = getCookie('csrftoken');

    // При сабмите формы делаем AJAX запрос, чтобы улучшить характеристики
    boostForm.addEventListener('submit', function(e) {
        e.preventDefault(); // Не даем форме перейти на новую страницу

        // Собираем данные: group
        const groupSelect = document.getElementById('groupSelect');
        const groupVal = groupSelect.value;

        // Отправляем fetch POST на ваш эндпоинт (players/<id>/boost_player_ajax/)
        fetch("{% url 'players:player_boost_ajax' player.id %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                group: groupVal
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Обновляем прогресс-бары (анимированно):
                applyStatChanges(data.changes);

                // Обновляем costLabel (следующая стоимость)
                costLabel.textContent = data.next_cost;

                // Закрываем модалку
                const modalEl = document.getElementById('boostModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

            } else {
                alert(data.message || 'Error while boosting stats');
            }
        })
        .catch(err => {
            console.error(err);
            alert('Something went wrong');
        });
    });
});

/**
 * Функция, которая анимированно обновляет прогресс-бары.
 * @param {object} changes — словарь { stamina: { old: 50, new: 53 }, ... }
 */
function applyStatChanges(changes) {
    // Для каждого атрибута
    for (let attrName in changes) {
        const oldVal = changes[attrName].old;
        const newVal = changes[attrName].new;

        // Ищем прогресс-бар: data-attr="attrName"
        const bar = document.querySelector(`.progress-bar[data-attr="${attrName}"]`);
        if (!bar) continue;

        // Обновим текст внутри
        bar.textContent = newVal;

        // Начальный width = oldVal
        bar.style.width = oldVal + '%';

        // Если прирост > 0, показываем +N поверх progress
        const diff = newVal - oldVal;
        if (diff > 0) {
            const plusBadge = document.createElement('span');
            plusBadge.className = 'badge bg-success position-absolute translate-middle';
            plusBadge.style.zIndex = '9999';
            plusBadge.textContent = `+${diff}`;
            // Добавляем поверх .progress
            bar.parentNode.appendChild(plusBadge);

            // Через 10 сек удалим badge
            setTimeout(() => {
                plusBadge.remove();
            }, 10000);
        }

        // Анимация плавного перехода
        requestAnimationFrame(() => {
            bar.style.transition = 'width 1s ease';
            bar.style.width = newVal + '%';
        });

        // Через 1.5s убираем transition, чтобы при повторном улучшении анимация сработала снова
        setTimeout(() => {
            bar.style.transition = '';
        }, 1500);
    }
}
</script>
{% endblock %}
